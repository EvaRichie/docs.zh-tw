---
title: 無伺服器架構考慮-無伺服器應用程式
description: 瞭解架構無伺服器應用程式的挑戰，從狀態管理和持續性儲存體到調整、記錄、追蹤和診斷。
author: JEREMYLIKNESS
ms.author: jeliknes
ms.date: 04/06/2020
ms.openlocfilehash: fbbb0c38cea58902124743fb99f9ab31b3d09be9
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2020
ms.locfileid: "91171646"
---
# <a name="serverless-architecture-considerations"></a>無伺服器架構考量

採用無伺服器架構會帶來一些挑戰。 本節將探討一些較常見的考慮事項。 所有這些挑戰都有解決方案。 就像所有的架構選項一樣，最好在仔細考慮優缺點之後，才進行無伺服器的決策。 視應用程式的需求而定，您可能會決定無伺服器的實作為特定元件的正確解決方案。

## <a name="managing-state"></a>管理狀態

無伺服器函式（如同一般微服務）預設為無狀態。 避免狀態可讓無伺服器成為暫時的、向外延展，並在沒有中央失敗點的情況下提供復原功能。 在某些情況下，商務程式需要狀態。 如果您的進程需要狀態，您有兩個選項。 您可以採用無伺服器的模型，或與提供狀態的個別服務互動。 新增狀態可能會讓解決方案變得複雜，並使其更難調整，而且可能會建立單一失敗點。 請仔細考慮您的函式是否確實需要狀態。 如果答案為「是」，請判斷使用無伺服器來執行它是否仍然合理。

有幾個解決方案可採用狀態，而不會危及無伺服器的優點。 一些更受歡迎的解決方案包括：

- 使用暫存資料存放區或分散式快取，例如 Redis
- 在資料庫中儲存狀態，例如 SQL 或 CosmosDB
- 透過工作流程引擎（例如[持久](/azure/azure-functions/durable/durable-functions-overview)函式）處理狀態

重點是，您應該留意到您正在考慮使用無伺服器來執行的進程內的任何狀態管理需求。

## <a name="long-running-processes"></a>長時間執行的進程

無伺服器的許多優點都依賴處理常式是暫時的。 縮短執行時間可讓無伺服器提供者更容易釋出資源，因為函式會在主機上結束和共用功能。 大部分的雲端提供者會限制您的函式執行的總時間（大約10分鐘）。 如果您的程式可能需要較長的時間，您可以考慮替代的執行方式。

有一些例外狀況和解決方案。 其中一個解決方法是將您的程式分成較小的元件，這些元件會個別花費較少的時間執行。 如果您的程式因為相依性而執行時間很長，您也可以考慮使用長期函式等解決方案的非同步工作流程。 長期函式會在等候外部進程完成時，暫停和維護進程的狀態。 非同步處理可減少實際處理常式的執行時間。

## <a name="startup-time"></a>啟動時間

無伺服器實施的一個潛在問題是啟動時間。 為了節省資源，許多無伺服器的提供者會依需求建立基礎結構。 在一段時間後觸發無伺服器函式時，您可能需要建立或重新開機該函式所裝載的資源。 在某些情況下，冷啟動可能會導致延遲幾秒鐘。 啟動時間會因提供者和服務等級而異。 如果您要將應用程式的成功率降至最低，有幾種方法可以解決啟動時間。

- 有些提供者可讓使用者支付保證基礎結構為「永遠開啟」的服務等級。
- 實行保持運作機制 (ping 端點以保持「喚醒」 ) 。
- 使用 Kubernetes 搭配容器化函式方法來使用協調流程， (主機已在執行中，因此啟動新實例非常快速) 。

## <a name="database-updates-and-migrations"></a>資料庫更新和遷移

無伺服器程式碼的優點是您可以發行新的函式，而不需要重新部署整個應用程式。 當涉及關係資料庫時，這種優點可能會成為缺點。 資料庫架構的變更很難與無伺服器更新進行同步處理。 當發生問題且變更必須回復時，就會造成其他挑戰。 資料完整性是微服務和無伺服器函式的最佳作法的其中一個原因，就是它們擁有自己的資料。 您可以將變更部署為計算和資料的單一單位。 實際的情況是，許多舊版系統都具有必須與無伺服器架構協調的大型後端資料庫。

解決架構版本設定的常用方法是永遠不要修改現有的屬性和資料行，而是改為加入新的資訊。 例如，請考慮將待辦事項清單中的布林值「已完成」旗標移至「完成日期」。 資料庫變更將不會移除舊的欄位，而是：

1. 新增 [完成日期] 欄位。
1. 將「已完成」布林值欄位轉換為計算的函式，此函式會評估已完成的日期是否在目前日期之後。
1. 加入觸發程式，將完成的布林值設定為 true 時，將完成日期設定為目前日期。

變更順序可確保舊版程式碼會繼續以「原樣」執行，而較新的無伺服器函式可以利用新的欄位。

如需無伺服器架構中資料的詳細資訊，請參閱 [分散式資料管理的挑戰和解決方案](../microservices/architect-microservice-container-applications/distributed-data-management.md)。

## <a name="scaling"></a>調整大小

無伺服器表示「無伺服器」，這是常見的誤解。 其實是「較少的伺服器」。 其實有一個支援基礎結構，就是了解調整規模的時機。 大部分的無伺服器平臺都會提供一組控制項，以處理事件密度增加時基礎結構的調整方式。 您可以從各種不同的選項中進行選擇，但您的策略可能會因函式而異。 此外，函式通常會在相關主機下執行，讓相同主機上的函式具有相同的調整選項。 因此，您必須根據規模需求來組織和制定哪些函式裝載在一起。

規則通常會指定如何擴大 (增加主機資源) 和向外延展 (根據不同的參數增加主控制項) 實例的數目。 調整的觸發程式可能包括排程、要求率、CPU 使用率和記憶體使用量。 效能較高通常會產生較高的成本。 當要求速率突然增加時，耗用成本較低的方法可能無法迅速調整。 支付前「保險成本」與「隨用隨付」的費用，以及因需求突然增加而產生的風險較慢的取捨。

## <a name="monitoring-tracing-and-logging"></a>監視、追蹤和記錄

DevOps 經常被忽略的層面是在部署應用程式之後進行監視。 請務必具有監視無伺服器函式的策略。 最大的挑戰通常是相互關聯，或在使用者呼叫多個函式作為相同互動的一部分時辨識。 大部分的無伺服器平臺允許可匯入至協力廠商工具的主控台記錄。 另外還有一些選項可自動收集遙測、產生和追蹤相互關聯識別碼，以及監視特定動作以提供詳細的深入解析。 Azure 提供先進的 [Application Insights 平臺](/azure/azure-functions/functions-monitoring) 來進行監視和分析。

## <a name="inter-service-dependencies"></a>服務間相依性

無伺服器架構可能包含依賴其他函式的函式。 事實上，在無伺服器架構中，有多個服務在互動或分散式交易中彼此呼叫彼此的情況並不常見。 為了避免強式結合，建議服務不會直接參考彼此。 當服務的端點需要變更時，直接參考可能會導致主要重構。 建議的解決方案是提供服務探索機制（例如登錄），為要求類型提供適當的結束點。 另一個解決方案是利用訊息服務（例如佇列或主題）來進行服務之間的通訊。

## <a name="managing-failure-and-providing-resiliency"></a>管理失敗並提供復原功能

也請務必考慮 *斷路器模式*：如果基於某些原因，服務會繼續失敗，建議您不要重複呼叫該服務。 相反地，會呼叫替代服務或傳回訊息，直到相依服務的健全狀況重新建立為止。 無伺服器架構需要考慮解決和管理服務間相依性的策略。

若要繼續斷路器模式，服務必須具有容錯能力和彈性。 容錯指的是，即使在遇到未預期的例外狀況或無效狀態之後，您的應用程式仍可繼續執行的功能。 容錯通常是程式碼本身的函式，以及其撰寫方式來處理例外狀況。 復原是指應用程式從失敗中復原的能力。 復原通常是由無伺服器平臺所管理。 當現有的無伺服器函式實例失敗時，該平臺應該能夠啟動新的無伺服器函式實例。 在每個新實例失敗時，平臺也應該有足夠的智慧，以停止啟動新的實例。

如需詳細資訊，請參閱 [執行斷路器模式](../microservices/implement-resilient-applications/implement-circuit-breaker-pattern.md)。

## <a name="versioning-and-greenblue-deployments"></a>版本控制和綠色/藍色部署

無伺服器的主要優點是能夠升級特定功能，而不需要重新部署整個應用程式。 若要成功升級，必須將函式設為版本，以便將呼叫它們的服務路由至正確的程式碼版本。 部署新版本的策略也很重要。 常見的方法是使用「綠色/藍色部署」。 綠色部署是目前的函式。 新的「藍色」版本會部署到生產環境並經過測試。 測試通過時，會交換綠色和藍色版本，讓新版本上線。 如果遇到任何問題，可以將它們交換回來。 支援版本控制和綠色/藍色部署需要結合撰寫這些函式來容納版本變更，以及使用無伺服器平臺來處理部署。

>[!div class="step-by-step"]
>[上一個](serverless-architecture.md) 
>[下一步](serverless-design-examples.md)
