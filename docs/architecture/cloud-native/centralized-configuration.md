---
title: 集中式設定
description: 使用 Azure 應用程式組態與 AzureKey 保存庫集中設定雲端原生應用程式。
ms.date: 05/13/2020
ms.openlocfilehash: 0d40c5b2d70f30beb17489dfd55900f7c5fc1a75
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2020
ms.locfileid: "91160875"
---
# <a name="centralized-configuration"></a><span data-ttu-id="96544-103">集中式設定</span><span class="sxs-lookup"><span data-stu-id="96544-103">Centralized configuration</span></span>

<span data-ttu-id="96544-104">不同于在單一實例中執行所有專案的整合型應用程式，雲端原生應用程式是由分散在虛擬機器、容器和地理區域的獨立服務所組成。</span><span class="sxs-lookup"><span data-stu-id="96544-104">Unlike a monolithic app in which everything runs within a single instance, a cloud-native application consists of independent services distributed across virtual machines, containers, and geographic regions.</span></span> <span data-ttu-id="96544-105">管理數十個互相依存服務的設定，可能是一項挑戰。</span><span class="sxs-lookup"><span data-stu-id="96544-105">Managing configuration settings for dozens of interdependent services can be challenging.</span></span> <span data-ttu-id="96544-106">跨不同位置的設定複本複本重複，是容易發生錯誤且難以管理。</span><span class="sxs-lookup"><span data-stu-id="96544-106">Duplicate copies of configuration settings across different locations is error prone and difficult to manage.</span></span> <span data-ttu-id="96544-107">集中式設定是分散式雲端原生應用程式的重要需求。</span><span class="sxs-lookup"><span data-stu-id="96544-107">Centralized configuration is a critical requirement for distributed cloud-native applications.</span></span>

<span data-ttu-id="96544-108">如 [第1章](introduction.md)所述，十二要素應用程式建議需要在程式碼與設定之間進行嚴格的分隔。</span><span class="sxs-lookup"><span data-stu-id="96544-108">As discussed in [Chapter 1](introduction.md), the Twelve-Factor App recommendations require strict separation between code and configuration.</span></span> <span data-ttu-id="96544-109">設定必須從應用程式外部儲存，並視需要進行讀取。</span><span class="sxs-lookup"><span data-stu-id="96544-109">Configuration must be stored externally from the application and read-in as needed.</span></span> <span data-ttu-id="96544-110">在程式碼中將設定值儲存為常數或常值是一項違規。</span><span class="sxs-lookup"><span data-stu-id="96544-110">Storing configuration values as constants or literal values in code is a violation.</span></span> <span data-ttu-id="96544-111">相同的設定值通常會由相同應用程式中的許多服務使用。</span><span class="sxs-lookup"><span data-stu-id="96544-111">The same configuration values are often be used by many services in the same application.</span></span> <span data-ttu-id="96544-112">此外，我們必須跨多個環境（例如開發、測試和生產環境）支援相同的值。</span><span class="sxs-lookup"><span data-stu-id="96544-112">Additionally, we must support the same values across multiple environments, such as dev, testing, and production.</span></span> <span data-ttu-id="96544-113">最佳做法是將它們儲存在集中式設定存放區。</span><span class="sxs-lookup"><span data-stu-id="96544-113">The best practice is store them in a centralized configuration store.</span></span>

<span data-ttu-id="96544-114">Azure 雲端提供數個絕佳的選項。</span><span class="sxs-lookup"><span data-stu-id="96544-114">The Azure cloud presents several great options.</span></span>

## <a name="azure-app-configuration"></a><span data-ttu-id="96544-115">Azure 應用程式組態</span><span class="sxs-lookup"><span data-stu-id="96544-115">Azure App Configuration</span></span>

<span data-ttu-id="96544-116">[Azure 應用程式組態](/azure/azure-app-configuration/overview) 是完全受控的 Azure 服務，可將非秘密設定設定儲存在安全且集中的位置。</span><span class="sxs-lookup"><span data-stu-id="96544-116">[Azure App Configuration](/azure/azure-app-configuration/overview) is a fully managed Azure service that stores non-secret configuration settings in a secure, centralized location.</span></span> <span data-ttu-id="96544-117">您可以在多個服務和應用程式之間共用儲存的值。</span><span class="sxs-lookup"><span data-stu-id="96544-117">Stored values can be shared among multiple services and applications.</span></span>

<span data-ttu-id="96544-118">這項服務很容易使用，並提供幾項優點：</span><span class="sxs-lookup"><span data-stu-id="96544-118">The service is simple to use and provides several benefits:</span></span>

- <span data-ttu-id="96544-119">彈性的索引鍵/值標記法和對應</span><span class="sxs-lookup"><span data-stu-id="96544-119">Flexible key/value representations and mappings</span></span>
- <span data-ttu-id="96544-120">使用 Azure 標籤標記</span><span class="sxs-lookup"><span data-stu-id="96544-120">Tagging with Azure labels</span></span>
- <span data-ttu-id="96544-121">用於管理的專用 UI</span><span class="sxs-lookup"><span data-stu-id="96544-121">Dedicated UI for management</span></span>
- <span data-ttu-id="96544-122">機密資訊的加密</span><span class="sxs-lookup"><span data-stu-id="96544-122">Encryption of sensitive information</span></span>
- <span data-ttu-id="96544-123">查詢和批次抓取</span><span class="sxs-lookup"><span data-stu-id="96544-123">Querying and batch retrieval</span></span>

<span data-ttu-id="96544-124">Azure 應用程式組態會保留七天對機碼值設定所做的變更。</span><span class="sxs-lookup"><span data-stu-id="96544-124">Azure App Configuration maintains changes made to key-value settings for seven days.</span></span> <span data-ttu-id="96544-125">時間點快照集功能可讓您重建設定的歷程記錄，甚至是復原失敗的部署。</span><span class="sxs-lookup"><span data-stu-id="96544-125">The point-in-time snapshot feature enables you to reconstruct the history of a setting and even rollback for a failed deployment.</span></span>

<span data-ttu-id="96544-126">應用程式設定會自動快取每個設定，以避免對設定存放區進行過多的呼叫。</span><span class="sxs-lookup"><span data-stu-id="96544-126">App Configuration automatically caches each setting to avoid excessive calls to the configuration store.</span></span> <span data-ttu-id="96544-127">重新整理作業會等到設定的快取值過期，才會更新該設定，即使其值在設定存放區中有所變更也一樣。</span><span class="sxs-lookup"><span data-stu-id="96544-127">The refresh operation waits until the cached value of a setting expires to update that setting, even when its value changes in the configuration store.</span></span> <span data-ttu-id="96544-128">預設讀快取到期時間為 30 秒。</span><span class="sxs-lookup"><span data-stu-id="96544-128">The default cache expiration time is 30 seconds.</span></span> <span data-ttu-id="96544-129">您可以覆寫到期時間。</span><span class="sxs-lookup"><span data-stu-id="96544-129">You can override the expiration time.</span></span>

<span data-ttu-id="96544-130">應用程式設定會加密傳輸中和待用的所有設定值。</span><span class="sxs-lookup"><span data-stu-id="96544-130">App Configuration encrypts all configuration values in transit and at rest.</span></span> <span data-ttu-id="96544-131">索引鍵名稱和標籤是用來作為抓取設定資料的索引，且不會加密。</span><span class="sxs-lookup"><span data-stu-id="96544-131">Key names and labels are used as indexes for retrieving configuration data and aren't encrypted.</span></span>

<span data-ttu-id="96544-132">雖然應用程式設定提供強化的安全性，但 Azure Key Vault 仍是儲存應用程式秘密的最佳位置。</span><span class="sxs-lookup"><span data-stu-id="96544-132">Although App Configuration provides hardened security, Azure Key Vault is still the best place for storing application secrets.</span></span> <span data-ttu-id="96544-133">Key Vault 提供硬體層級的加密、細微的存取原則，以及像是憑證輪替的管理作業。</span><span class="sxs-lookup"><span data-stu-id="96544-133">Key Vault provides hardware-level encryption, granular access policies, and management operations such as certificate rotation.</span></span> <span data-ttu-id="96544-134">您可以建立參考儲存在 Key Vault 中之秘密的應用程式設定值。</span><span class="sxs-lookup"><span data-stu-id="96544-134">You can create App Configuration values that reference secrets stored in a Key Vault.</span></span>

## <a name="azure-key-vault"></a><span data-ttu-id="96544-135">Azure 金鑰保存庫</span><span class="sxs-lookup"><span data-stu-id="96544-135">Azure Key Vault</span></span>

<span data-ttu-id="96544-136">Key Vault 是可安全儲存及存取秘密的受控服務。</span><span class="sxs-lookup"><span data-stu-id="96544-136">Key Vault is a managed service for securely storing and accessing secrets.</span></span> <span data-ttu-id="96544-137">祕密是指任何需受到嚴密存取控制的項目，例如 API 金鑰、密碼或憑證。</span><span class="sxs-lookup"><span data-stu-id="96544-137">A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates.</span></span> <span data-ttu-id="96544-138">保存庫是秘密的邏輯群組。</span><span class="sxs-lookup"><span data-stu-id="96544-138">A vault is a logical group of secrets.</span></span>

<span data-ttu-id="96544-139">Key Vault 可大幅降低不小心洩露祕密的風險。</span><span class="sxs-lookup"><span data-stu-id="96544-139">Key Vault greatly reduces the chances that secrets may be accidentally leaked.</span></span> <span data-ttu-id="96544-140">使用 Key Vault 時，應用程式開發人員不再需要在其應用程式中儲存安全性資訊。</span><span class="sxs-lookup"><span data-stu-id="96544-140">When using Key Vault, application developers no longer need to store security information in their application.</span></span> <span data-ttu-id="96544-141">這種做法不需要將此資訊儲存在您的程式碼內。</span><span class="sxs-lookup"><span data-stu-id="96544-141">This practice eliminates the need to store this information inside your code.</span></span> <span data-ttu-id="96544-142">例如，應用程式可能需要連線到資料庫。</span><span class="sxs-lookup"><span data-stu-id="96544-142">For example, an application may need to connect to a database.</span></span> <span data-ttu-id="96544-143">您可以在 Key Vault 中妥善儲存連接字串，而不用在應用程式程式碼中儲存連接字串。</span><span class="sxs-lookup"><span data-stu-id="96544-143">Instead of storing the connection string in the app's code, you can store it securely in Key Vault.</span></span>

<span data-ttu-id="96544-144">您的應用程式可以使用 URI 安全地存取其所需的資訊。</span><span class="sxs-lookup"><span data-stu-id="96544-144">Your applications can securely access the information they need by using URIs.</span></span> <span data-ttu-id="96544-145">這些 URI 可讓應用程式擷取特定版本的祕密。</span><span class="sxs-lookup"><span data-stu-id="96544-145">These URIs allow the applications to retrieve specific versions of a secret.</span></span> <span data-ttu-id="96544-146">不需要撰寫自訂程式碼來保護 Key Vault 中儲存的任何秘密資訊。</span><span class="sxs-lookup"><span data-stu-id="96544-146">There's no need to write custom code to protect any of the secret information stored in Key Vault.</span></span>

<span data-ttu-id="96544-147">存取 Key Vault 需要適當的呼叫端驗證和授權。</span><span class="sxs-lookup"><span data-stu-id="96544-147">Access to Key Vault requires proper caller authentication and authorization.</span></span> <span data-ttu-id="96544-148">一般來說，每個雲端原生微服務都會使用 ClientId/ClientSecret 組合。</span><span class="sxs-lookup"><span data-stu-id="96544-148">Typically, each cloud-native microservice uses a ClientId/ClientSecret combination.</span></span> <span data-ttu-id="96544-149">請務必將這些認證保留在原始檔控制之外。</span><span class="sxs-lookup"><span data-stu-id="96544-149">It's important to keep these credentials outside source control.</span></span> <span data-ttu-id="96544-150">最佳做法是在應用程式的環境中設定這些專案。</span><span class="sxs-lookup"><span data-stu-id="96544-150">A best practice is to set them in  the application's environment.</span></span> <span data-ttu-id="96544-151">您可以使用 [Key Vault FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol)，直接存取 AKS 的 Key Vault。</span><span class="sxs-lookup"><span data-stu-id="96544-151">Direct access to Key Vault from AKS can be achieved using [Key Vault FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol).</span></span>

## <a name="configuration-in-eshop"></a><span data-ttu-id="96544-152">EShop 中的設定</span><span class="sxs-lookup"><span data-stu-id="96544-152">Configuration in eShop</span></span>

<span data-ttu-id="96544-153">EShopOnContainers 應用程式包含每個微服務的本機應用程式佈建檔。</span><span class="sxs-lookup"><span data-stu-id="96544-153">The eShopOnContainers application includes local application settings files with each microservice.</span></span> <span data-ttu-id="96544-154">這些檔案會簽入原始檔控制中，但不包含實際執行的秘密，例如連接字串或 API 金鑰。</span><span class="sxs-lookup"><span data-stu-id="96544-154">These files are checked into source control, but don't include production secrets such as connection strings or API keys.</span></span> <span data-ttu-id="96544-155">在生產環境中，每個服務環境變數可能會覆寫個別設定。</span><span class="sxs-lookup"><span data-stu-id="96544-155">In production, individual settings may be overwritten with per-service environment variables.</span></span> <span data-ttu-id="96544-156">在環境變數中插入秘密是託管應用程式的常見作法，但不提供中央設定存放區。</span><span class="sxs-lookup"><span data-stu-id="96544-156">Injecting secrets in environment variables is a common practice for hosted applications, but doesn't provide a central configuration store.</span></span> <span data-ttu-id="96544-157">為了支援集中管理設定，每個微服務都包含一個設定，可在本機設定或 Azure Key Vault 設定之間切換。</span><span class="sxs-lookup"><span data-stu-id="96544-157">To support centralized management of configuration settings, each microservice includes a setting to toggle between its use of local settings or Azure Key Vault settings.</span></span>

## <a name="references"></a><span data-ttu-id="96544-158">參考資料</span><span class="sxs-lookup"><span data-stu-id="96544-158">References</span></span>

- [<span data-ttu-id="96544-159">EShopOnContainers 架構</span><span class="sxs-lookup"><span data-stu-id="96544-159">The eShopOnContainers Architecture</span></span>](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Architecture)
- [<span data-ttu-id="96544-160">協調微服務和多容器應用程式的高延展性和可用性</span><span class="sxs-lookup"><span data-stu-id="96544-160">Orchestrating microservices and multi-container applications for high scalability and availability</span></span>](../microservices/architect-microservice-container-applications/scalable-available-multi-container-microservice-applications.md)
- [<span data-ttu-id="96544-161">Azure API 管理</span><span class="sxs-lookup"><span data-stu-id="96544-161">Azure API Management</span></span>](/azure/api-management/api-management-key-concepts)
- [<span data-ttu-id="96544-162">Azure SQL Database 總覽</span><span class="sxs-lookup"><span data-stu-id="96544-162">Azure SQL Database Overview</span></span>](/azure/sql-database/sql-database-technical-overview)
- [<span data-ttu-id="96544-163">Azure Cache for Redis</span><span class="sxs-lookup"><span data-stu-id="96544-163">Azure Cache for Redis</span></span>](https://azure.microsoft.com/services/cache/)
- [<span data-ttu-id="96544-164">適用於 MongoDB 的 Azure Cosmos DB API</span><span class="sxs-lookup"><span data-stu-id="96544-164">Azure Cosmos DB's API for MongoDB</span></span>](/azure/cosmos-db/mongodb-introduction)
- [<span data-ttu-id="96544-165">Azure 服務匯流排</span><span class="sxs-lookup"><span data-stu-id="96544-165">Azure Service Bus</span></span>](/azure/service-bus-messaging/service-bus-messaging-overview)
- <span data-ttu-id="96544-166">[Azure 監視器概觀](/azure/azure-monitor/overview) \(部分機器翻譯\)</span><span class="sxs-lookup"><span data-stu-id="96544-166">[Azure Monitor overview](/azure/azure-monitor/overview)</span></span>
- <span data-ttu-id="96544-167">[eShopOnContainers：在 AKS 中建立 Kubernetes 叢集](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Deploy-to-Azure-Kubernetes-Service-(AKS)#create-kubernetes-cluster-in-aks)</span><span class="sxs-lookup"><span data-stu-id="96544-167">[eShopOnContainers: Create Kubernetes cluster in AKS](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Deploy-to-Azure-Kubernetes-Service-(AKS)#create-kubernetes-cluster-in-aks)</span></span>
- [<span data-ttu-id="96544-168">eShopOnContainers： Azure Dev Spaces</span><span class="sxs-lookup"><span data-stu-id="96544-168">eShopOnContainers: Azure Dev Spaces</span></span>](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Azure-Dev-Spaces)
- [<span data-ttu-id="96544-169">Azure 開發人員空間</span><span class="sxs-lookup"><span data-stu-id="96544-169">Azure Dev Spaces</span></span>](/azure/dev-spaces/about)

>[!div class="step-by-step"]
><span data-ttu-id="96544-170">[上一個](deploy-eshoponcontainers-azure.md) 
>[下一步](scale-applications.md)</span><span class="sxs-lookup"><span data-stu-id="96544-170">[Previous](deploy-eshoponcontainers-azure.md)
[Next](scale-applications.md)</span></span>
