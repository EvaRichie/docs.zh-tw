---
title: Azure 平臺復原
description: 設計適用于 Azure 的雲端原生 .NET 應用程式 |Azure 的雲端基礎結構復原
author: robvet
ms.date: 05/13/2020
ms.openlocfilehash: 88634bc60df15cc93b1769a85879795ae383757a
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2020
ms.locfileid: "91163761"
---
# <a name="azure-platform-resiliency"></a>Azure 平臺復原

在雲端中建立可靠的應用程式與傳統的內部部署應用程式開發不同。 在過去，您已購買更高階的硬體來擴大，但在雲端環境中，您可以相應放大。其目標是將其效果降到最低，並讓系統保持穩定，而不是嘗試避免失敗。

話雖如此，可靠的雲端應用程式會顯示不同的特性：

- 它們具有復原能力、可從問題中順利復原，並繼續運作。
- 這些都是高可用性 (HA) 並以健全狀態設計的方式執行，而且不會有顯著的停機時間。

若要建立可靠的雲端原生應用程式，請務必瞭解這些特性如何搭配運作，以及它們如何影響成本。 接下來我們將探討您可以利用 Azure 雲端的功能，在雲端原生應用程式中建立復原和可用性的方法。

## <a name="design-with-resiliency"></a>使用復原設計

我們已說過復原功能，可讓您的應用程式回應失敗，而且仍可正常運作。 [Azure 白皮書](https://azure.microsoft.com/mediahandler/files/resourcefiles/resilience-in-azure-whitepaper/Resilience%20in%20Azure.pdf)中的復原技術白皮書，提供在 azure 平臺中達成復原能力的指引。 以下是一些重要的建議：

- *硬體失敗。* 藉由在不同的容錯網域中部署元件，來建立應用程式的冗余。 例如，使用可用性設定組，確保 Azure Vm 會放在不同的機架中。

- *資料中心失敗。* 使用跨資料中心的錯誤隔離區域來建立應用程式的冗余。 例如，使用 Azure 可用性區域，確定 Azure Vm 會放在不同的錯誤隔離資料中心。

- *區域失敗。* 將資料和元件複寫到另一個區域，讓應用程式可以快速復原。 例如，使用 Azure Site Recovery 將 Azure Vm 複寫至另一個 Azure 區域。

- *重載。* 在實例之間進行負載平衡，以處理使用量尖峰。 例如，將兩個或多個 Azure Vm 放在負載平衡器後方，以將流量分散到所有 Vm。

- *意外刪除或損毀資料。* 備份資料，以便在有任何刪除或損毀時可以還原。 例如，使用 Azure 備份定期備份 Azure Vm。

## <a name="design-with-redundancy"></a>使用冗余設計

失敗的影響範圍會有所不同。 硬體故障（例如失敗的磁片）可能會影響叢集中的單一節點。 失敗的網路交換器可能會影響整個伺服器機架。 較不常見的失敗（例如遺失電源）可能會中斷整個資料中心。 很少會有整個區域變成無法使用。

[冗余](/azure/architecture/guide/design-principles/redundancy) 是提供應用程式恢復功能的一種方式。 所需的完整冗余層級取決於您的業務需求，而且會影響系統的成本和複雜度。 例如，多區域部署比單一區域部署更昂貴且更複雜。 您將需要操作程式來管理容錯移轉和容錯回復。 某些商務案例可能會有額外的成本和複雜度，而非其他業務案例。

若要架構冗余，您需要識別應用程式中的重要路徑，然後判斷路徑中的每個點是否有多餘的？ 如果子系統應該會失敗，應用程式是否會容錯移轉至其他內容？ 最後，您需要清楚瞭解 Azure 雲端平臺內建的功能，您可以利用這些功能來滿足您的冗余需求。 以下是架構冗余的建議：

- *部署多個服務執行個體。* 如果您的應用程式相依於服務的單一執行個體，它會建立單一失敗點。 佈建多個執行個體，可改善復原能力和延展性。 在 Azure Kubernetes Service 中裝載時，您可以在 Kubernetes 資訊清單檔中，以宣告方式設定 (複本集) 的重複實例。 您可以透過程式設計方式、在入口網站中或透過自動調整功能來管理複本計數值。

- *利用負載平衡器。* 負載平衡會將應用程式的要求散發到狀況良好的服務實例，並自動從輪替中移除狀況不良的實例。 部署至 Kubernetes 時，您可以在 [服務] 區段的 Kubernetes 資訊清單檔中指定負載平衡。

- *規劃多區域部署。* 如果您將應用程式部署到單一區域，且該區域變成無法使用，則您的應用程式也會變成無法使用。 這可能無法在應用程式的服務等級合約條款下接受。 相反地，請考慮將您的應用程式和其服務部署到多個區域。 例如，Azure Kubernetes Service (AKS) 叢集會部署到單一區域。 若要保護您的系統不受區域失敗的影響，您可以將應用程式部署到不同區域的多個 AKS 叢集，並使用 [配對的區域](https://buildazure.com/2017/01/06/azure-region-pairs-explained/) 功能來協調平臺更新並排定復原工作的優先順序。

- *啟用 [異地](/azure/sql-database/sql-database-active-geo-replication)複寫。* 服務的異地複寫（例如 Azure SQL Database 和 Cosmos DB）會跨多個區域建立資料的次要複本。 雖然這兩個服務都會自動複寫相同區域內的資料，但異地複寫可讓您容錯移轉至次要區域，以防止區域中斷。 異地複寫的另一個最佳作法是儲存容器映射。 若要在 AKS 中部署服務，您需要儲存並從存放庫提取映射。 Azure Container Registry 與 AKS 整合，並且可以安全地儲存容器映射。 若要改善效能和可用性，請考慮將映射異地複寫到每個有 AKS 叢集的區域中的登錄。 接著，每個 AKS 叢集都會從其區域中的本機容器登錄提取容器映射，如圖6-4 所示：

![跨區域複寫的資源](./media/replicated-resources.png)

**圖 6-4**。 跨區域複寫的資源

- *執行 DNS 流量負載平衡器。* [Azure 流量管理員](/azure/traffic-manager/traffic-manager-overview) 可透過在 DNS 層級的負載平衡，提供重要應用程式的高可用性。 它可以根據地理位置、叢集回應時間，甚至是應用程式端點的健康情況，將流量路由至不同的區域。 例如，Azure 流量管理員可以將客戶導向至最接近的 AKS 叢集和應用程式實例。 如果您在不同區域中有多個 AKS 叢集，請使用流量管理員來控制流量流向每個叢集中執行之應用程式的方式。 圖6-5 顯示此案例。

![AKS 和 Azure 流量管理員](./media/aks-traffic-manager.png)

**圖 6-5**。 AKS 和 Azure 流量管理員

## <a name="design-for-scalability"></a>延展性設計

雲端計畫才能生生不息調整規模。 增加/減少系統資源以因應增加/減少系統負載的能力，是 Azure 雲端的關鍵原則。 但是，若要有效地調整應用程式，您需要瞭解您的應用程式中包含的每個 Azure 服務的調整功能。  以下是有效實施系統調整的建議。

- *進行調整的設計。* 應用程式必須針對調整而設計。 首先，服務應該是無狀態的，以便將要求路由傳送到任何實例。 使用無狀態服務也表示新增或移除實例，並不會對目前的使用者造成不良的影響。

- *分割工作負載*。 將網域分解至獨立、獨立的微服務，可讓每個服務獨立于其他服務進行調整。 一般來說，服務會有不同的擴充性需求和需求。 資料分割可讓您只調整需要調整的內容，而不需要調整整個應用程式的不必要成本。

- *優先擴充。* 以雲端為基礎的應用程式可利相應放大資源，而不是向上延展。 相應放大 (也稱為水準調整) 包括將更多服務資源新增至現有的系統，以符合並共用所需的效能層級。 相應增加 (也稱為垂直調整) 牽涉到將現有資源取代為更強大的硬體 (更多磁片、記憶體和處理核心) 。 您可以使用某些 Azure 雲端資源中提供的自動調整功能來自動叫用相應放大。 跨多個資源相應放大也會增加整體系統的冗余。 最後，相應增加單一資源的成本通常會比在許多較小的資源之間相應放大。 圖6-6 顯示這兩種方法：

![擴大與相應放大](./media/scale-up-scale-out.png)

**圖6-6。** 擴大與相應放大

- *依比例調整規模。* 調整服務時，請考慮 *資源集*。 如果您要大幅擴充特定服務，對後端資料存放區、快取和相依服務有何影響？ 有些資源（例如 Cosmos DB）可以按比例相應放大，而其他資源則無法進行。 您想要確保您不會將資源相應放大至即將耗盡其他相關資源的點。

- *避免親和性。* 最佳做法是確保節點不需要區域親和性，通常稱為「 *粘滯話*」。 要求應該要能夠路由傳送到任何實例。 如果您需要保存狀態，則應將其儲存至分散式快取，例如 [Azure Redis cache](https://azure.microsoft.com/services/cache/)。

- *利用平臺自動調整功能。* 盡可能使用內建的自動調整功能，而不是自訂或協力廠商機制。 可能的話，請使用排程的調整規則來確保資源在沒有啟動延遲的情況下可供使用，但請適當地將回應式自動調整新增至規則，以應付非預期的需求變更。 如需詳細資訊，請參閱自動調整 [指引](/azure/architecture/best-practices/auto-scaling)。

- *積極地相應放大。* 最後一個作法是積極地向外延展，讓您可以快速地符合流量的立即尖峰，而不會失去業務損失。 然後， (也就是，移除不必要的實例，) 保守地將系統保持穩定。 執行這項作業的一個簡單方式是設定酷炫的期間，也就是在調整作業之間等待的時間，以及五分鐘的時間來新增資源，以及最多15分鐘的時間來移除實例。

## <a name="built-in-retry-in-services"></a>服務中的內建重試

我們建議您在稍早的章節中執行程式設計重試作業的最佳做法。 請記住，許多 Azure 服務及其對應的用戶端 Sdk 也包含重試機制。 下列清單摘要說明本書籍中所討論的許多 Azure 服務的重試功能：

- *Azure Cosmos DB。* <xref:Microsoft.Azure.Documents.Client.DocumentClient>來自用戶端 API 的類別會自動淘汰失敗的嘗試。 重試次數和等候時間上限是可設定的。 用戶端 API 擲回的例外狀況，可能是超過重試原則或非暫時性錯誤的要求。

- *Azure Redis 快取。* Redis >stackexchange.redis 用戶端使用的連線管理員類別包含嘗試失敗時的重試。 重試次數、特定重試原則和等候時間都是可設定的。

- *Azure 服務匯流排。* 服務匯流排用戶端會公開 [RetryPolicy 類別](xref:Microsoft.ServiceBus.RetryPolicy) ，此類別可以設定為使用反向間隔、重試計數，以及 <xref:Microsoft.ServiceBus.RetryExponential.TerminationTimeBuffer%2A> 指定作業可採取的最長時間。 預設原則是兩次重試嘗試次數，並在嘗試之間有30秒的輪詢間隔。

- *Azure SQL Database。* 使用 [Entity Framework Core](/ef/core/miscellaneous/connection-resiliency) 程式庫時，會提供重試支援。

- *Azure 儲存體。* 儲存體用戶端程式庫支援重試作業。 這些策略會因 Azure 儲存體資料表、blob 和佇列而異。 同樣地，在啟用異地複寫功能時，會在主要和次要儲存體服務位置之間切換替代重試。

- *Azure 事件中樞。* 事件中樞用戶端程式庫具有 RetryPolicy 屬性，其中包含可設定的指數輪詢功能。

>[!div class="step-by-step"]
>[上一個](application-resiliency-patterns.md) 
>[下一步](resilient-communications.md)
