---
title: 應用程式復原模式
description: 設計適用于 Azure 的雲端原生 .NET 應用程式 |應用程式復原模式
author: robvet
ms.date: 05/13/2020
ms.openlocfilehash: e81d6e1d6b95cf0053de3ba557068ff458a59dc9
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2020
ms.locfileid: "91161148"
---
# <a name="application-resiliency-patterns"></a>應用程式復原模式

第一道防線是應用程式復原。

雖然您可以投入相當長的時間來撰寫自己的復原架構，但這類產品已經存在。 [Polly](http://www.thepollyproject.org/) 是完整的 .net 復原和暫時性錯誤處理程式庫，可讓開發人員以流暢且安全線程的方式來表達復原原則。 Polly 以 .NET Framework 或 .NET Core 為基礎的應用程式為目標。 下表說明 Polly 程式庫中所提供的復原功能（稱為 `policies` ）。 它們可以個別套用或群組在一起。

| 原則 | 體驗 |
| :-------- | :-------- |
| 重試 | 設定指定作業的重試作業。 |
| 斷路器 | 當錯誤超過設定的臨界值時，封鎖預先定義期間的要求作業 |
| 逾時 | 限制呼叫端可以等候回應的持續時間限制。 |
| 隔艙 | 將動作限制為固定大小的資源集區，以防止呼叫淹沒資源。 |
| 快取 | 自動儲存回應。 |
| 後援 | 定義失敗時的結構化行為。 |

請注意，在上圖中，復原原則會套用至要求訊息（不論是來自外部用戶端或後端服務）。 其目標是要補償可能會暫時無法使用之服務的要求。 這些短暫的中斷通常會以下表所示的 HTTP 狀態碼來資訊清單。

| HTTP 狀態碼| 原因 |
| :-------- | :-------- |
| 404 | 找不到 |
| 408 | 要求逾時 |
| 429 | 太多要求 (您很可能已經過節流)  |
| 502 | 閘道不正確 |
| 503 | 服務無法使用 |
| 504 | 閘道超時 |

問題：您是否要重試 HTTP 狀態碼 403-禁止？ 否。 在這裡，系統會正常運作，但通知呼叫者未獲授權執行要求的操作。 務必務必只重試失敗所造成的作業。

如第1章所述，Microsoft 開發人員應以 .NET Core 平臺為目標，來建立雲端原生應用程式。 2.1 版引進了 [HTTPClientFactory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) 程式庫，可用於建立 HTTP 用戶端實例，以與 URL 型資源互動。 取代原始的 HTTPClient 類別，factory 類別支援許多增強功能，其中一個與 Polly 復原程式庫 [緊密整合](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md) 。 有了它，您就可以輕鬆地在應用程式啟動類別中定義復原原則，以處理部分失敗和連線問題。

接下來，讓我們展開重試和斷路器模式。

### <a name="retry-pattern"></a>重試模式

在分散式雲端原生環境中，服務和雲端資源的呼叫可能會因為暫時性 (短暫的) 失敗而失敗，這通常會在短暫的時間內自行修正。 執行重試策略可協助雲端原生服務減輕這些案例的風險。

[重試模式](/azure/architecture/patterns/retry)可讓服務重試失敗的要求作業， (可設定的) 次數，並以指數方式增加等候時間。 圖6-2 顯示重試動作。

![作用中的重試模式](./media/retry-pattern.png)

**圖 6-2**。 作用中的重試模式

在上圖中，已針對要求作業執行重試模式。 它是設定為在失敗前最多有四次重試， (等候時間) 從兩秒開始，這會以指數方式為每次後續的嘗試進行雙精度浮點數。

- 第一個調用失敗，並傳回 HTTP 狀態碼500。 應用程式會等待兩秒，然後重試呼叫。
- 第二個調用也會失敗，並傳回 HTTP 狀態碼500。 應用程式現在會將輪詢間隔加倍到四秒，然後重試呼叫。
- 最後，第三個呼叫會成功。
- 在此案例中，重試作業最多會嘗試四次重試，但在呼叫失敗之前將輪詢持續時間加倍。
- 第四次重試嘗試失敗時，將會叫用回溯原則以正常處理問題。

請務必先增加輪詢期間，再重試呼叫，以允許服務時間自行修正。 最佳做法是以指數方式增加輪詢 (將每次重試) 的期間加倍，以允許適當的更正時間。

## <a name="circuit-breaker-pattern"></a>斷路器模式

雖然重試模式有助於在部分失敗中搶救要求纏結，但是在某些情況下，可能會因為未預期的事件需要較長的時間來解決問題而造成失敗。 這些錯誤的嚴重性範圍包含失去部分連線到整個服務無法運作。 在這些情況下，應用程式會持續重試不太可能成功的作業，是無意義的。

為了讓事情更糟，在沒有回應的服務上執行連續的重試作業，可以將您移至自我設定的拒絕服務案例中，您會使用持續的呼叫耗盡資源（例如記憶體、執行緒和資料庫連接），導致使用相同資源的系統不相關部分失敗。

在這些情況下，最好是讓作業立即失敗，而且只有在可能成功時才嘗試叫用服務。

[斷路器模式](/azure/architecture/patterns/circuit-breaker)可防止應用程式重複嘗試執行可能失敗的作業。 在預先定義的失敗呼叫次數之後，它會封鎖對服務的所有流量。 它會定期允許試用通話，以判斷錯誤是否已解決。 圖6-3 顯示斷路器模式的作用。

![作用中的斷路器模式](./media/circuit-breaker-pattern.png)

**圖 6-3**。 作用中的斷路器模式

在上圖中，已將斷路器模式新增至原始重試模式。 請注意，在100次失敗的要求之後，斷路器會開啟，而且不會再允許服務的呼叫。 設定為30秒的 CheckCircuit 值，指定程式庫允許一個要求繼續服務的頻率。 如果該呼叫成功，則電路會關閉，而且服務會再次提供給流量。

請記住，斷路器模式的目的與重試模式的意圖 *不同* 。 重試模式可讓應用程式在預期會成功的情況下重試操作。 斷路器模式可防止應用程式執行可能失敗的作業。 一般而言，應用程式會使用重試模式，透過斷路器叫用作業來 *結合* 這兩種模式。

## <a name="testing-for-resiliency"></a>針對復原而測試

執行單元測試、整合測試等) ， (測試應用程式功能的方式，就不一定可以測試復原。 相反地，您必須測試端對端工作負載在失敗情況下的執行方式，這只會間歇性發生。 例如：損毀進程、過期憑證、讓相依服務無法使用等插入失敗。 [混亂](https://github.com/Netflix/chaosmonkey) 等架構可用於這類混亂測試。

應用程式復原是處理有問題的要求作業時必須具備的功能。 但是，這只是故事的一半而已。 接下來，我們會討論 Azure 雲端中可用的復原功能。

>[!div class="step-by-step"]
>[上一個](resiliency.md) 
>[下一步](infrastructure-resiliency-azure.md)
