---
title: 執行復原
description: 在 .NET 中執行復原。 資源管理員會在資源失敗之後重新登記交易參與者，協助解決持久的交易登記。
ms.date: 03/30/2017
ms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0
ms.openlocfilehash: bb00d2f574cc2651b733f3308cf2ffc6b430cc31
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141961"
---
# <a name="performing-recovery"></a><span data-ttu-id="58827-104">執行復原</span><span class="sxs-lookup"><span data-stu-id="58827-104">Performing Recovery</span></span>
<span data-ttu-id="58827-105">資源管理員會在資源失敗後重新登記異動參與者，以協助解析異動中的永久性登記。</span><span class="sxs-lookup"><span data-stu-id="58827-105">A resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.</span></span>  
  
## <a name="the-recovery-process"></a><span data-ttu-id="58827-106">復原程序</span><span class="sxs-lookup"><span data-stu-id="58827-106">The Recovery Process</span></span>  
 <span data-ttu-id="58827-107">若要永久地登記稍後可用於復原的資源 (如 <xref:System.Transactions.IEnlistmentNotification> 介面實作所述)，您應該呼叫 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="58827-107">To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="58827-108">此外，您必須提供一個包含資源管理員識別項 (<xref:System.Transactions.Transaction.EnlistDurable%2A>) 的 <xref:System.Guid> 方法，此識別項可在發生資源失敗時，用來為交易參與者持續加上標籤。</span><span class="sxs-lookup"><span data-stu-id="58827-108">In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure.</span></span> <span data-ttu-id="58827-109">基於這個理由，提供給初始登錄呼叫的會與復原 <xref:System.Guid> 期間呼叫中的*resourceManagerIdentifier*參數相同 <xref:System.Transactions.TransactionManager.Reenlist%2A> 。</span><span class="sxs-lookup"><span data-stu-id="58827-109">For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery.</span></span> <span data-ttu-id="58827-110">否則，會擲回 <xref:System.Transactions.TransactionException>。</span><span class="sxs-lookup"><span data-stu-id="58827-110">Otherwise, <xref:System.Transactions.TransactionException> is thrown.</span></span> <span data-ttu-id="58827-111">如需永久性登記的詳細資訊，請參閱[將資源登記為交易中的參與者](enlisting-resources-as-participants-in-a-transaction.md)。</span><span class="sxs-lookup"><span data-stu-id="58827-111">For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](enlisting-resources-as-participants-in-a-transaction.md) .</span></span>  
  
 <span data-ttu-id="58827-112">在 2PC 通訊協定準備階段 (第一階段) 中，當您實作的永久性資源管理員收到 <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> 告知，就應該會在此階段記錄下自己的準備記錄。</span><span class="sxs-lookup"><span data-stu-id="58827-112">In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase.</span></span> <span data-ttu-id="58827-113">該記錄應包含完成交易認可所需的所有資訊。</span><span class="sxs-lookup"><span data-stu-id="58827-113">The record should contain all the information that is necessary to complete the transaction on commit.</span></span> <span data-ttu-id="58827-114">您稍後可以藉由抓取 PreparingEnlistment 回呼的屬性，在復原期間存取準備記錄 <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> 。 *preparingEnlistment*</span><span class="sxs-lookup"><span data-stu-id="58827-114">The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback.</span></span> <span data-ttu-id="58827-115">由於 RM 可以在背景工作執行緒 (Worker Thread) 上進行記錄，因此您不需要透過 <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> 方法來執行。</span><span class="sxs-lookup"><span data-stu-id="58827-115">The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread.</span></span>  
  
 <span data-ttu-id="58827-116">復原程序包含下列兩個步驟：</span><span class="sxs-lookup"><span data-stu-id="58827-116">The recovery process consists of the following two steps:</span></span>  
  
### <a name="step-1---reenlist"></a><span data-ttu-id="58827-117">步驟 1 - 重新登記</span><span class="sxs-lookup"><span data-stu-id="58827-117">Step 1 - ReEnlist</span></span>  
 <span data-ttu-id="58827-118">資源管理員會檢查每個不確定之登記的準備資訊記錄。</span><span class="sxs-lookup"><span data-stu-id="58827-118">The resource manager examines the prepare information record for each enlistment that is in-doubt.</span></span> <span data-ttu-id="58827-119">它會檢查 <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> 回呼的 <xref:System.Transactions.PreparingEnlistment> 屬性，這個屬性會在第一階段透過 <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> 告知傳遞給資源管理員。</span><span class="sxs-lookup"><span data-stu-id="58827-119">This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1.</span></span>  
  
 <span data-ttu-id="58827-120">它會針對每個所檢查的此類登記，叫用交易管理員上的 <xref:System.Transactions.TransactionManager.Reenlist%2A>。</span><span class="sxs-lookup"><span data-stu-id="58827-120">For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager.</span></span> <span data-ttu-id="58827-121">此方法會傳遞可識別資源管理員的唯一 <xref:System.Guid>，以及位元組陣列中的登記資訊。</span><span class="sxs-lookup"><span data-stu-id="58827-121">This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array.</span></span> <span data-ttu-id="58827-122">隨即會傳回新的 <xref:System.Transactions.Enlistment> 物件。</span><span class="sxs-lookup"><span data-stu-id="58827-122">A new <xref:System.Transactions.Enlistment> object is returned.</span></span> <span data-ttu-id="58827-123">如果重新登記因為例外狀況而失敗，則資源管理員需要在稍後重試。</span><span class="sxs-lookup"><span data-stu-id="58827-123">If the reenlistment fails with an exception, the resource manager will need to retry at a later time.</span></span>  
  
 <span data-ttu-id="58827-124">只有在資源管理員從失敗中重新啟動時，您才應該呼叫 <xref:System.Transactions.TransactionManager.Reenlist%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="58827-124">You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure.</span></span> <span data-ttu-id="58827-125">此外，您只應該重新登記無法解析的交易，這些交易是由資源管理員在兩階段交易認可 (Two-Phase Commit) 的初始準備階段所記錄。</span><span class="sxs-lookup"><span data-stu-id="58827-125">In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit.</span></span> <span data-ttu-id="58827-126">任何嘗試在無效時間呼叫這個方法的動作，都可能產生錯誤性結果。</span><span class="sxs-lookup"><span data-stu-id="58827-126">Any attempt to call this method at invalid times can produce erroneous results.</span></span>  
  
 <span data-ttu-id="58827-127">當使用這個方法重新登記參與者時，會依適合的情況呼叫對應至異動結果 (也就是，<xref:System.Transactions.IEnlistmentNotification>、<xref:System.Transactions.IEnlistmentNotification.Commit%2A> 或 <xref:System.Transactions.IEnlistmentNotification.Rollback%2A>) 之 <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> 的第二階段方法。</span><span class="sxs-lookup"><span data-stu-id="58827-127">When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate.</span></span>  
  
### <a name="step-2---completing-the-recovery"></a><span data-ttu-id="58827-128">步驟 2 - 完成復原</span><span class="sxs-lookup"><span data-stu-id="58827-128">Step 2 - Completing the recovery</span></span>  
 <span data-ttu-id="58827-129">完成所有重新登記後，資源管理員就會呼叫 <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="58827-129">When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method.</span></span> <span data-ttu-id="58827-130">此方法會完成復原並告知交易管理員，資源管理員已不包含任何不確定的交易。</span><span class="sxs-lookup"><span data-stu-id="58827-130">This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions.</span></span> <span data-ttu-id="58827-131">當資源管理員這麼做，即保證不會再次叫用 <xref:System.Transactions.TransactionManager.Reenlist%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="58827-131">By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again.</span></span>  
  
 <span data-ttu-id="58827-132">在登記新的交易之前，不需要透過資源管理員來解析所有不確定的交易。</span><span class="sxs-lookup"><span data-stu-id="58827-132">A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions.</span></span> <span data-ttu-id="58827-133">在資源管理員與交易管理員建立關聯性之後，您可以隨時執行第一個步驟，但是在被叫用之後 <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> （步驟2），就無法再次執行步驟1。</span><span class="sxs-lookup"><span data-stu-id="58827-133">The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again.</span></span> <span data-ttu-id="58827-134">步驟 2 可以重複執行多次，而不會影響到交易結果。</span><span class="sxs-lookup"><span data-stu-id="58827-134">Step 2 can be repeated multiple times without affecting the outcome of transactions.</span></span>
