---
title: 實作資源管理員
description: 在 .NET 中執行資源管理員。 資源管理員會管理交易中使用的資源。 交易管理員會協調 resource manager 動作。
ms.date: 03/30/2017
ms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3
ms.openlocfilehash: bf40c6eaee35a5a548c6de4a286e46c4d4a66aca
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141845"
---
# <a name="implementing-a-resource-manager"></a><span data-ttu-id="a85de-105">實作資源管理員</span><span class="sxs-lookup"><span data-stu-id="a85de-105">Implementing a Resource Manager</span></span>
<span data-ttu-id="a85de-106">交易所使用的每項資源都會受到資源管理員的管理，而這些資源管理員在採取行動時必須經過交易管理員的協調。</span><span class="sxs-lookup"><span data-stu-id="a85de-106">Each resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="a85de-107">資源管理員會和交易管理員一起合作以提供應用程式單元性 (Atomicity) 和隔離性 (Isolation) 的保證。</span><span class="sxs-lookup"><span data-stu-id="a85de-107">Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation.</span></span> <span data-ttu-id="a85de-108">Microsoft SQL Server、永久性訊息佇列、記憶體中的雜湊資料表，通通都是資源管理員的範例。</span><span class="sxs-lookup"><span data-stu-id="a85de-108">Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.</span></span>  
  
 <span data-ttu-id="a85de-109">資源管理員會負責管理永久性或變動性資料。</span><span class="sxs-lookup"><span data-stu-id="a85de-109">A resource manager manages either durable or volatile data.</span></span> <span data-ttu-id="a85de-110">資源管理員的永久性 (反之為變動性) 指的是資源管理員是否支援故障復原。</span><span class="sxs-lookup"><span data-stu-id="a85de-110">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="a85de-111">如果資源管理員支援故障復原，會在第一階段 (準備階段) 將資料保存在永久性儲存裝置中。這樣一來，如果資源管理員故障，資料就可以在復原後重新登記到交易中，並依據接收自交易管理員的告知執行適當的動作。</span><span class="sxs-lookup"><span data-stu-id="a85de-111">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager.</span></span> <span data-ttu-id="a85de-112">一般來說，變動性資源管理員會將變動性資源當成記憶體中的資料結構來管理 (例如，記憶體中的交易雜湊表)，而永久性資源管理員則會管理具有較持久之備份存放區的資源 (例如，使用磁碟做為備份存放區的資料庫)。</span><span class="sxs-lookup"><span data-stu-id="a85de-112">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>  
  
 <span data-ttu-id="a85de-113">為了讓資源參與交易，資源必須登記到交易中。</span><span class="sxs-lookup"><span data-stu-id="a85de-113">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="a85de-114"><xref:System.Transactions.Transaction>類別會定義一組方法，其名稱開頭為**Enlist**可提供此功能的登錄。</span><span class="sxs-lookup"><span data-stu-id="a85de-114">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="a85de-115">不同的**登錄方法會**對應至資源管理員可能擁有的不同登記類型。</span><span class="sxs-lookup"><span data-stu-id="a85de-115">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="a85de-116">具體來說，您可以使用變動性資源的 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法，以及永久性資源的 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="a85de-116">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="a85de-117">在依據資源永久性支援來決定是否採用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 或 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法之後，為了方便作業，您應該實作資源管理員的 <xref:System.Transactions.IEnlistmentNotification> 介面，以便登記資源並讓其參與兩階段交易認可 (2PC)。</span><span class="sxs-lookup"><span data-stu-id="a85de-117">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="a85de-118">如需有關2PC 的詳細資訊，請參閱[在單一階段和多重階段中認可交易](committing-a-transaction-in-single-phase-and-multi-phase.md)。</span><span class="sxs-lookup"><span data-stu-id="a85de-118">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>  
  
 <span data-ttu-id="a85de-119">資源管理員藉由登記來確保當交易認可或中止時，能夠從交易管理員中取得回呼。</span><span class="sxs-lookup"><span data-stu-id="a85de-119">By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts.</span></span> <span data-ttu-id="a85de-120">每項登記都有一個 <xref:System.Transactions.IEnlistmentNotification> 執行個體。</span><span class="sxs-lookup"><span data-stu-id="a85de-120">There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment.</span></span> <span data-ttu-id="a85de-121">一般來說，每個交易都會包含一個登記，但是資源管理員可以選擇在同一個交易中登記多次。</span><span class="sxs-lookup"><span data-stu-id="a85de-121">Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.</span></span>  
  
 <span data-ttu-id="a85de-122">登記完之後，資源管理員會回應交易要求。</span><span class="sxs-lookup"><span data-stu-id="a85de-122">After enlistment, the resource manager responds to the transaction's requests.</span></span> <span data-ttu-id="a85de-123">永久性資源管理員會儲存足夠的資訊，方便它復原或重做交易對它所管理的資源的變更。</span><span class="sxs-lookup"><span data-stu-id="a85de-123">A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages.</span></span> <span data-ttu-id="a85de-124">有許多方式可以這麼做；保存不同的資料版本，或是保存一份變更記錄，都是常見的方法。</span><span class="sxs-lookup"><span data-stu-id="a85de-124">There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.</span></span>  
  
 <span data-ttu-id="a85de-125">當應用程式認可交易時，交易管理員會啟始兩階段的交易認可通訊協定。</span><span class="sxs-lookup"><span data-stu-id="a85de-125">When the application commits the transaction, the transaction manager initiates the two-phase commit protocol.</span></span> <span data-ttu-id="a85de-126">交易管理員會先詢問每個登記的資源管理員是否已經準備好認可交易。</span><span class="sxs-lookup"><span data-stu-id="a85de-126">The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction.</span></span> <span data-ttu-id="a85de-127">資源管理員必須準備認可交易，它可以準備認可或是中止交易。</span><span class="sxs-lookup"><span data-stu-id="a85de-127">The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.</span></span>  
  
 <span data-ttu-id="a85de-128">在準備階段，永久性資源管理員會將新舊資料記錄到穩定的儲存位置，這樣一來，就算系統故障，資源管理員還是能夠加以復原。</span><span class="sxs-lookup"><span data-stu-id="a85de-128">During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails.</span></span> <span data-ttu-id="a85de-129">如果資源管理員可以準備，就會告知交易管理員它已投票認可或中止交易。</span><span class="sxs-lookup"><span data-stu-id="a85de-129">If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction.</span></span> <span data-ttu-id="a85de-130">如果有任何資源管理員報告準備失敗，則交易管理員會將回呼指令傳給每個資源管理員，並向應用程式指出交易認可失敗之處。</span><span class="sxs-lookup"><span data-stu-id="a85de-130">If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="a85de-131">準備好之後，資源管理員必須等到第二階段從交易管理員取得交易認可或中止的回呼。</span><span class="sxs-lookup"><span data-stu-id="a85de-131">Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2.</span></span> <span data-ttu-id="a85de-132">一般來說，整個準備與認可通訊協定會在一瞬間完成。</span><span class="sxs-lookup"><span data-stu-id="a85de-132">Typically, the entire prepare and commit protocol completes in a fraction of a second.</span></span> <span data-ttu-id="a85de-133">如果發生系統故障或通訊失敗，則認可或中止告知可能無法在幾分鐘或幾小時內抵達。</span><span class="sxs-lookup"><span data-stu-id="a85de-133">If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours.</span></span> <span data-ttu-id="a85de-134">在這段期間，資源管理員將無法確定交易的結果。</span><span class="sxs-lookup"><span data-stu-id="a85de-134">During this period, the resource manager is in doubt about the outcome of the transaction.</span></span> <span data-ttu-id="a85de-135">它不知道交易是否已經認可或中止。</span><span class="sxs-lookup"><span data-stu-id="a85de-135">It does not know whether the transaction committed or aborted.</span></span> <span data-ttu-id="a85de-136">當資源管理員不確定交易結果時，會鎖定交易來持續修改資料，進而將這些變更從其他所有交易中隔離出來。</span><span class="sxs-lookup"><span data-stu-id="a85de-136">While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.</span></span>  
  
 <span data-ttu-id="a85de-137">當資源管理員失敗，所有登記的交易都會中止 (在失敗前已經準備好或認可的交易除外)。</span><span class="sxs-lookup"><span data-stu-id="a85de-137">When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure.</span></span> <span data-ttu-id="a85de-138">當永久性資源管理員重新啟動，會擷取於準備階段中寫入的準備資訊來重新建構所管理的資源認可狀態，並據此認可或中止交易。</span><span class="sxs-lookup"><span data-stu-id="a85de-138">When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.</span></span>  
  
 <span data-ttu-id="a85de-139">簡言之，兩階段交易認可通訊協定與資源管理員會共同讓交易變成不可部分完成且具有永久性。</span><span class="sxs-lookup"><span data-stu-id="a85de-139">In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.</span></span>  
  
 <span data-ttu-id="a85de-140"><xref:System.Transactions.Transaction> 類別也會提供 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 方法，以便登記可提升單一階段登記 (PSPE)。</span><span class="sxs-lookup"><span data-stu-id="a85de-140">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="a85de-141">這樣一來永久性資源管理員 (RM) 就可以裝載並「擁有」交易，並可在稍後視需要將規模擴大為由 MSDTC 管理。</span><span class="sxs-lookup"><span data-stu-id="a85de-141">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="a85de-142">如需這種情況的詳細資訊，請參閱[使用單一階段認可和可提升單一階段通知的優化](optimization-spc-and-promotable-spn.md)。</span><span class="sxs-lookup"><span data-stu-id="a85de-142">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="a85de-143">本節內容</span><span class="sxs-lookup"><span data-stu-id="a85de-143">In This Section</span></span>  
 <span data-ttu-id="a85de-144">如下列各主題所述，這些步驟通常會緊接著資源管理員。</span><span class="sxs-lookup"><span data-stu-id="a85de-144">The steps generally followed by a resource manager are outlined in the following topics.</span></span>  
  
 [<span data-ttu-id="a85de-145">將資源登記成為交易中的參與者</span><span class="sxs-lookup"><span data-stu-id="a85de-145">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)  
  
 <span data-ttu-id="a85de-146">說明如何在交易中登記永久性或變動性資源。</span><span class="sxs-lookup"><span data-stu-id="a85de-146">Describes how a durable or volatile resource can enlist in a transaction.</span></span>  
  
 [<span data-ttu-id="a85de-147">在單一階段和多重階段中認可異動</span><span class="sxs-lookup"><span data-stu-id="a85de-147">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)  
  
 <span data-ttu-id="a85de-148">說明資源管理員如何回應認可告知以及準備認可。</span><span class="sxs-lookup"><span data-stu-id="a85de-148">Describes how a resource manager responds to commit notification and prepare the commit.</span></span>  
  
 [<span data-ttu-id="a85de-149">執行復原</span><span class="sxs-lookup"><span data-stu-id="a85de-149">Performing Recovery</span></span>](performing-recovery.md)  
  
 <span data-ttu-id="a85de-150">說明永久性資源管理員如何從故障中復原。</span><span class="sxs-lookup"><span data-stu-id="a85de-150">Describes how a durable resource manager recovers from failure.</span></span>  
  
 [<span data-ttu-id="a85de-151">存取資源的安全性信任層級</span><span class="sxs-lookup"><span data-stu-id="a85de-151">Security Trust Levels in Accessing Resources</span></span>](security-trust-levels-in-accessing-resources.md)  
  
 <span data-ttu-id="a85de-152">說明 System.Transactions 的三個信任層級如何對 <xref:System.Transactions> 所公開的資源型別限制其存取。</span><span class="sxs-lookup"><span data-stu-id="a85de-152">Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes.</span></span>  
  
 [<span data-ttu-id="a85de-153">使用單一階段認可和可提升單一階段通知進行最佳化</span><span class="sxs-lookup"><span data-stu-id="a85de-153">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)  
  
 <span data-ttu-id="a85de-154">說明可用來實作資源管理員的最佳化準則。</span><span class="sxs-lookup"><span data-stu-id="a85de-154">Describes optimization practices available to implementations of resource managers.</span></span>
