---
title: 使用單一階段交易認可和可提升單一階段告知進行最佳化
description: 使用單一階段交易認可和可提升單一階段通知，將效能優化。 瞭解 .NET 中的系統交易基礎結構。
ms.date: 03/30/2017
ms.assetid: 57beaf1a-fb4d-441a-ab1d-bc0c14ce7899
ms.openlocfilehash: 89ce82e673340c93254983c078f78a2501129383
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141974"
---
# <a name="optimization-using-single-phase-commit-and-promotable-single-phase-notification"></a><span data-ttu-id="e3cca-104">使用單一階段交易認可和可提升單一階段告知進行最佳化</span><span class="sxs-lookup"><span data-stu-id="e3cca-104">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>

<span data-ttu-id="e3cca-105">本主題將說明 <xref:System.Transactions> 基礎結構所提供，用以最佳化效能的各項機制。</span><span class="sxs-lookup"><span data-stu-id="e3cca-105">This topic describes the mechanisms provided by the <xref:System.Transactions> infrastructure to optimize performance.</span></span>

## <a name="promotable-single-phase-enlistment"></a><span data-ttu-id="e3cca-106">可提升單一階段登記</span><span class="sxs-lookup"><span data-stu-id="e3cca-106">Promotable Single Phase Enlistment</span></span>

<span data-ttu-id="e3cca-107"><xref:System.Transactions> 基礎結構負責管理單一應用程式定義域 (最多涉及單一永久性資源或多個變動性資源) 內的交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-107">The <xref:System.Transactions> infrastructure administrates a transaction inside a single application domain that involves at most a single durable resource or multiple volatile resources.</span></span> <span data-ttu-id="e3cca-108">由於 <xref:System.Transactions> 基礎結構只使用應用程式內部的網域呼叫，因此可得到最佳輸送量與效能。</span><span class="sxs-lookup"><span data-stu-id="e3cca-108">Since the <xref:System.Transactions> infrastructure uses only intra-application domain calls, it yields the best throughput and performance.</span></span>

<span data-ttu-id="e3cca-109">然而，如果將交易提供給位於同一部電腦上另一個應用程式定義域 (包含跨處理序與電腦界限) 中的另一個物件時，<xref:System.Transactions> 基礎結構會自動擴大由 MSDTC 所管理的交易規模。</span><span class="sxs-lookup"><span data-stu-id="e3cca-109">However, if the transaction is provided to another object in another application domain (including across process and machine boundaries) on the same computer, or if you were to enlist another durable resource manager, the <xref:System.Transactions> infrastructure automatically escalates the transaction to be managed by the MSDTC.</span></span> <span data-ttu-id="e3cca-110">由 MSDTC 所管理的交易並不像由 <xref:System.Transactions> 基礎結構所管理的交易一樣注重效能。</span><span class="sxs-lookup"><span data-stu-id="e3cca-110">A transaction managed by MSDTC is not as performance-wise as one managed by the <xref:System.Transactions> infrastructure.</span></span>

<span data-ttu-id="e3cca-111">為了最佳化效能，<xref:System.Transactions> 基礎結構會將提供可提升單一階段登記 (PSPE) 以允許位於不同應用程式定義域、處理序或電腦上的單一遠端永久性資源參與 <xref:System.Transactions> 交易，而不會導致它擴大為 MSDTC 交易規模。</span><span class="sxs-lookup"><span data-stu-id="e3cca-111">To optimize performance, the <xref:System.Transactions> infrastructure provides the Promotable Single Phase Enlistment (PSPE) that allows a single remote durable resource, located in a different application domain, process or machine, to participate in a <xref:System.Transactions> transaction without causing it to be escalated to an MSDTC transaction.</span></span> <span data-ttu-id="e3cca-112">此交易管理員 (RM) 可以裝載並「擁有」交易，並可在稍後視需要將規模擴大為分散式交易 (或 MSDTC 交易)。</span><span class="sxs-lookup"><span data-stu-id="e3cca-112">This resource manager (RM) can host and "own" a transaction that can later be escalated to a distributed transaction (or MSDTC transaction) if necessary.</span></span> <span data-ttu-id="e3cca-113">這會減少 MSDTC 的使用。</span><span class="sxs-lookup"><span data-stu-id="e3cca-113">This reduces the chance of using the MSDTC.</span></span>

<span data-ttu-id="e3cca-114">這項特定的資源管理員通常擁有自己的內部非分散式交易，而且需要在執行階段支援將這些交易轉換為分散式交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-114">This specific resource manager usually has its own internal non distributed transactions and it needs to support converting those transactions to distributed transactions at runtime.</span></span> <span data-ttu-id="e3cca-115">例如，SQL Server 2005 就是這樣的資源管理員。</span><span class="sxs-lookup"><span data-stu-id="e3cca-115">For example, SQL Server 2005 is such a resource manager.</span></span> <span data-ttu-id="e3cca-116">在此情況下，<xref:System.Transactions> 基礎結構會採取消極的管理作為，而且只會監控交易，看看是否需要擴大規模。</span><span class="sxs-lookup"><span data-stu-id="e3cca-116">In such case, the <xref:System.Transactions> infrastructure takes a passive management role by just monitoring the transaction for a need for escalation.</span></span> <span data-ttu-id="e3cca-117">為了支援 <xref:System.Transactions> 基礎結構與資源管理員之間的互動，後者需要實作 <xref:System.Transactions.IPromotableSinglePhaseNotification> 介面。</span><span class="sxs-lookup"><span data-stu-id="e3cca-117">To support the interaction between the <xref:System.Transactions> infrastructure and resource manager, the latter needs to implement the interface <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span></span>

<span data-ttu-id="e3cca-118">您可以使用 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 方法，來登記稍後要擴大規模的單一永久性資源。</span><span class="sxs-lookup"><span data-stu-id="e3cca-118">The <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method is used to enlist a single durable resource that can be escalated later.</span></span> <span data-ttu-id="e3cca-119">此方法可確保必要時登記擴大規模。</span><span class="sxs-lookup"><span data-stu-id="e3cca-119">This method ensures that the enlistment can be escalated as needed.</span></span> <span data-ttu-id="e3cca-120">如果登記作業順利，則 RM 會建立自己的內部交易並將其與 <xref:System.Transactions> 交易關聯在一起。</span><span class="sxs-lookup"><span data-stu-id="e3cca-120">If the enlistment succeeds, the RM creates its internal transaction and associates it with the <xref:System.Transactions> transaction.</span></span> <span data-ttu-id="e3cca-121">如果 PSPE 登記作業失敗，則 RM 應該改用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法來登記。</span><span class="sxs-lookup"><span data-stu-id="e3cca-121">If the PSPE enlistment fails, the RM should instead enlist using the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="e3cca-122">當交易已經成為分散式交易時，或當另一個 RM 已經執行了 PSPE 登記作業時，PSPE 登記作業可能會失敗</span><span class="sxs-lookup"><span data-stu-id="e3cca-122">Failures to enlist in PSPE might happen when the transaction is already a distributed transaction, or when another RM has already performed a PSPE enlistment</span></span>

<span data-ttu-id="e3cca-123">登記好了以後，用戶端的 <xref:System.Transactions> 交易認可或中止呼叫會藉由個別叫用 <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> 方法或 <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A>，轉換為對資源管理員的呼叫。</span><span class="sxs-lookup"><span data-stu-id="e3cca-123">Once enlisted, calls by clients to commit or abort the <xref:System.Transactions> transaction are converted to calls on the Resource Manager by invoking the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> method, or the <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> respectively.</span></span>

<span data-ttu-id="e3cca-124">如果 <xref:System.Transactions> 交易從不需要擴大規模，則當認可交易時，RM 會收到一份 <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> 告知。</span><span class="sxs-lookup"><span data-stu-id="e3cca-124">If the <xref:System.Transactions> transaction never requires escalation, when the transaction is committed, the RM receives a <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification.</span></span> <span data-ttu-id="e3cca-125">接著它會認可剛建立好的內部交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-125">It can then commit the internal transaction that was initially created.</span></span>

<span data-ttu-id="e3cca-126">如果 <xref:System.Transactions> 交易需要擴大規模 (例如，用以支援多個 RM)，則 <xref:System.Transactions> 會呼叫 <xref:System.Transactions.ITransactionPromoter.Promote%2A> 介面之來源 <xref:System.Transactions.ITransactionPromoter> 介面上的 <xref:System.Transactions.IPromotableSinglePhaseNotification> 方法，以告知資源管理員。</span><span class="sxs-lookup"><span data-stu-id="e3cca-126">If the <xref:System.Transactions> transaction needs to be escalated (e.g., to support multiple RMs), <xref:System.Transactions> informs the resource manager by calling the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface, from which the <xref:System.Transactions.IPromotableSinglePhaseNotification> interface derives.</span></span> <span data-ttu-id="e3cca-127">接著，資源管理員會從內部將交易由本機交易 (不需要記錄) 轉換為可參與 DTC 交易的交易物件，並將其與已經完成的工作產生關聯。</span><span class="sxs-lookup"><span data-stu-id="e3cca-127">The resource manager then converts the transaction internally from a local transaction (which does not require logging) to a transaction object that is capable of participating in a DTC transaction, and associates it with the work already done.</span></span> <span data-ttu-id="e3cca-128">一旦交易被要求認可，交易管理員仍舊會將 <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> 告知傳送給資源管理員，使其認可在擴大規模期間所建立的分散式交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-128">When the transaction is asked to commit, the transaction manager still sends the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification to the resource manager, which commits the distributed transaction that it created during escalation.</span></span>

> [!NOTE]
> <span data-ttu-id="e3cca-129">**TransactionCommitted**追蹤（在擴大的交易上叫用 Commit 時產生）包含 DTC 交易的活動識別碼。</span><span class="sxs-lookup"><span data-stu-id="e3cca-129">The **TransactionCommitted** traces (that are generated when a Commit is invoked on the escalated transaction) contain the activity ID of the DTC transaction.</span></span>

<span data-ttu-id="e3cca-130">如需管理擴大的詳細資訊，請參閱[交易管理擴大](transaction-management-escalation.md)。</span><span class="sxs-lookup"><span data-stu-id="e3cca-130">For more information on management escalation, see [Transaction Management Escalation](transaction-management-escalation.md).</span></span>

## <a name="transaction-management-escalation-scenario"></a><span data-ttu-id="e3cca-131">交易管理擴大規模案例</span><span class="sxs-lookup"><span data-stu-id="e3cca-131">Transaction Management Escalation Scenario</span></span>

<span data-ttu-id="e3cca-132">下列案例說明了使用 <xref:System.Data> 命名空間做為資源管理員 Proxy 以便將規模擴大為分散式交易的情況。</span><span class="sxs-lookup"><span data-stu-id="e3cca-132">The following scenario demonstrates an escalation to a distributed transaction using the <xref:System.Data> namespace as the ‘proxy’ for the resource manager.</span></span> <span data-ttu-id="e3cca-133">此案例假定已經存在一個對資料庫的 <xref:System.Data> 連線 (CN1) 且此資料庫已經參與交易，而且應用程式想要在交易中加入另一個 <xref:System.Data> 連線 (CN2)。</span><span class="sxs-lookup"><span data-stu-id="e3cca-133">This scenario assumes that there is already one <xref:System.Data> connection to the database, CN1, involved in the transaction, and the application wants to involve another <xref:System.Data> connection, CN2.</span></span> <span data-ttu-id="e3cca-134">此交易必須擴大至 DTC，才算完成整個分散式兩階段交易認可交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-134">The transaction must be escalated to DTC, as a full distributed two-phase commit transaction.</span></span>

<span data-ttu-id="e3cca-135">在此案例中，</span><span class="sxs-lookup"><span data-stu-id="e3cca-135">In this scenario,</span></span>

1. <span data-ttu-id="e3cca-136">CN1 會呼叫 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 方法來登記交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-136">CN1 calls the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist in the transaction.</span></span> <span data-ttu-id="e3cca-137">接著，交易仍舊在本機上執行，而且未含其他可提升登記項目，因此 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 呼叫能夠順利完成。</span><span class="sxs-lookup"><span data-stu-id="e3cca-137">Then, the transaction is still local and there are no other promotable enlistments on the transaction, so the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> call succeeds.</span></span>

2. <span data-ttu-id="e3cca-138">當第二個連線，也就是 CN2 呼叫 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 時，由於已經內含另一個可提升登記項目，因此呼叫會失敗。</span><span class="sxs-lookup"><span data-stu-id="e3cca-138">When the second connection, CN2 calls <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, the call fails because there is another promotable enlistment involved.</span></span> <span data-ttu-id="e3cca-139">因為這個緣故，CN2 必須取得 DTC 交易以便將其傳送給 SQL。</span><span class="sxs-lookup"><span data-stu-id="e3cca-139">Because of this, CN2 must get a DTC transaction in order to pass it to SQL.</span></span> <span data-ttu-id="e3cca-140">為了達到這個目的，它會使用 <xref:System.Transactions.TransactionInterop> 類別所提供的其中一種方法來產生可提供給 SQL 的交易格式。</span><span class="sxs-lookup"><span data-stu-id="e3cca-140">To do this, it uses one of the methods provided by the <xref:System.Transactions.TransactionInterop> class to produce a format of the transaction that can be given to SQL.</span></span>

3. <span data-ttu-id="e3cca-141"><xref:System.Transactions> 會呼叫 CN1 於 <xref:System.Transactions.ITransactionPromoter.Promote%2A> 介面上所實作的 <xref:System.Transactions.ITransactionPromoter> 方法。</span><span class="sxs-lookup"><span data-stu-id="e3cca-141"><xref:System.Transactions> calls the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface implemented by CN1.</span></span>

4. <span data-ttu-id="e3cca-142">此時，CN1 會藉助 SQL 2005 與 <xref:System.Data> 專屬的某些機制來擴大交易規模。</span><span class="sxs-lookup"><span data-stu-id="e3cca-142">At this point, CN1 escalates the transaction, using some mechanism specific to SQL 2005 and <xref:System.Data>.</span></span>

5. <span data-ttu-id="e3cca-143">來自 <xref:System.Transactions.ITransactionPromoter.Promote%2A> 方法的傳回值是一種位元組陣列，其中包含用於交易的傳播權杖。</span><span class="sxs-lookup"><span data-stu-id="e3cca-143">The return value from the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method is a byte array that contains a propagation token for the transaction.</span></span> <span data-ttu-id="e3cca-144"><xref:System.Transactions>會使用此傳播權杖來建立可併入本機交易的 DTC 交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-144"><xref:System.Transactions> uses this propagation token to create a DTC transaction that it can incorporate into the local transaction.</span></span>

6. <span data-ttu-id="e3cca-145">此時，CN2 可以使用 <xref:System.Transactions.TransactionInterop> 來呼叫其中一種方法，並藉由呼叫後所收到的資料將交易傳遞給 SQL。</span><span class="sxs-lookup"><span data-stu-id="e3cca-145">At this point, CN2 can use the data received from calling one of the methods by <xref:System.Transactions.TransactionInterop> to pass the transaction to SQL.</span></span>

7. <span data-ttu-id="e3cca-146">現在，兩者都已經登記在 DTC 分散式交易中了。</span><span class="sxs-lookup"><span data-stu-id="e3cca-146">Now, both are enlisted in a DTC distributed transaction.</span></span>

## <a name="single-phase-commit-optimization"></a><span data-ttu-id="e3cca-147">單一階段交易認可最佳化</span><span class="sxs-lookup"><span data-stu-id="e3cca-147">Single Phase Commit Optimization</span></span>

<span data-ttu-id="e3cca-148">在執行階段使用單一階段交易認可通訊協定會比較有效率，因為所有的更新不需要任何個別的協調作業就可完成。</span><span class="sxs-lookup"><span data-stu-id="e3cca-148">The Single Phase Commit protocol is more efficient at runtime as all updates are done without any explicit coordination.</span></span> <span data-ttu-id="e3cca-149">若要充分善用此最佳化優勢，您應該使用資源的 <xref:System.Transactions.ISinglePhaseNotification> 介面來實作資源管理員，並使用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 或 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法來登記交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-149">To take advantage of this optimization, you should implement a resource manager using <xref:System.Transactions.ISinglePhaseNotification> interface for the resource and enlist in a transaction using the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span> <span data-ttu-id="e3cca-150">具體而言， *EnlistmentOptions*參數應該等於， <xref:System.Transactions.EnlistmentOptions.None> 以確保會執行單一階段認可。</span><span class="sxs-lookup"><span data-stu-id="e3cca-150">Specifically, the *EnlistmentOptions* parameter should equal to <xref:System.Transactions.EnlistmentOptions.None> to ensure that a single phase commit would be performed.</span></span>

<span data-ttu-id="e3cca-151">由於 <xref:System.Transactions.ISinglePhaseNotification> 介面是衍生自 <xref:System.Transactions.IEnlistmentNotification> 介面，即使 RM 無法執行單一階段交易認可，仍舊可以收到兩階段交易認可告知。</span><span class="sxs-lookup"><span data-stu-id="e3cca-151">Since the <xref:System.Transactions.ISinglePhaseNotification> interface derives from the <xref:System.Transactions.IEnlistmentNotification> interface, if your RM is not eligible for single phase commit, it can still receive the two phase commit notifications.</span></span> <span data-ttu-id="e3cca-152">如果您的 RM 收到來自 TM 的 <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> 告知，它應該嘗試執行必要的工作以便認可交易，並接著藉由呼叫 <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A> 參數上的 <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>、<xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A>，或 <xref:System.Transactions.SinglePhaseEnlistment> 方法來告知交易管理員是否應該認可或復原交易。</span><span class="sxs-lookup"><span data-stu-id="e3cca-152">If your RM receives a <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> notification from the TM, it should try to do the work necessary for it to commit and correspondingly inform the transaction manager if the transaction is to be committed or rolled back by calling the <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>, or <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> method on the <xref:System.Transactions.SinglePhaseEnlistment> parameter.</span></span> <span data-ttu-id="e3cca-153">此階段對登記項目的 <xref:System.Transactions.Enlistment.Done%2A> 回應將意指唯讀語意。</span><span class="sxs-lookup"><span data-stu-id="e3cca-153">A response of <xref:System.Transactions.Enlistment.Done%2A> on the enlistment at this stage implies ReadOnly semantics.</span></span> <span data-ttu-id="e3cca-154">因此，您不應該在其他任何方法以外，回應 <xref:System.Transactions.Enlistment.Done%2A>。</span><span class="sxs-lookup"><span data-stu-id="e3cca-154">Therefore, you should not reply <xref:System.Transactions.Enlistment.Done%2A> in addition to any of the other methods.</span></span>

<span data-ttu-id="e3cca-155">如果只有一個變動性登記，而且沒有永久性登記，則 volatile 登記會接收 SPC 通知。</span><span class="sxs-lookup"><span data-stu-id="e3cca-155">If there is only one volatile enlistment and no durable enlistment, the volatile enlistment receives SPC notification.</span></span> <span data-ttu-id="e3cca-156">如果有任何變動性登記，而且只有一個永久性登記，則 volatile 登記會收到2PC。</span><span class="sxs-lookup"><span data-stu-id="e3cca-156">If there are any volatile enlistments and only one durable enlistment, the volatile enlistments receive 2PC.</span></span> <span data-ttu-id="e3cca-157">當它完成時，永久性登記會收到 SPC。</span><span class="sxs-lookup"><span data-stu-id="e3cca-157">When it is completed, the durable enlistment receives SPC.</span></span>

## <a name="see-also"></a><span data-ttu-id="e3cca-158">另請參閱</span><span class="sxs-lookup"><span data-stu-id="e3cca-158">See also</span></span>

- [<span data-ttu-id="e3cca-159">將資源登記成為交易中的參與者</span><span class="sxs-lookup"><span data-stu-id="e3cca-159">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)
- [<span data-ttu-id="e3cca-160">在單一階段和多重階段中認可異動</span><span class="sxs-lookup"><span data-stu-id="e3cca-160">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
