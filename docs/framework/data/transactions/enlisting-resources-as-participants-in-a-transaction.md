---
title: 將資源登記成為交易中的參與者
description: 將資源登記為 .NET 交易中的參與者。 交易中的每個資源都是由資源管理員所管理，並由交易管理員協調。
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 786a12c2-d530-49f4-9c59-5c973e15a11d
ms.openlocfilehash: c3c777593750b3a4f05ae97ed6e26e19f58e4d72
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141871"
---
# <a name="enlisting-resources-as-participants-in-a-transaction"></a><span data-ttu-id="29adb-104">將資源登記成為交易中的參與者</span><span class="sxs-lookup"><span data-stu-id="29adb-104">Enlisting Resources as Participants in a Transaction</span></span>

<span data-ttu-id="29adb-105">參與交易的每項資源都會受到資源管理員的管理，而這些資源管理員在採取行動時必須經過交易管理員的協調。</span><span class="sxs-lookup"><span data-stu-id="29adb-105">Each resource participating in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="29adb-106">訂閱者透過交易管理員登記到交易中，並收到告知來完成整個協調程序。</span><span class="sxs-lookup"><span data-stu-id="29adb-106">The coordination is done through notifications given to subscribers who have enlisted in a transaction through the transaction manager.</span></span>

<span data-ttu-id="29adb-107">本主題將涵蓋如何在交易中登記資源 (或多項資源)，以及登記的型別有哪些。</span><span class="sxs-lookup"><span data-stu-id="29adb-107">This topic covers how a resource (or multiple resources) can be enlisted in a transaction, as well as the different types of enlistment.</span></span> <span data-ttu-id="29adb-108">[在單一階段和多重階段中認可交易](committing-a-transaction-in-single-phase-and-multi-phase.md)主題涵蓋了如何在登記的資源之間協調交易承諾。</span><span class="sxs-lookup"><span data-stu-id="29adb-108">The [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) topic covers how transaction commitment can be coordinated among enlisted resources.</span></span>

## <a name="enlisting-resources-in-a-transaction"></a><span data-ttu-id="29adb-109">將資源登記到交易中</span><span class="sxs-lookup"><span data-stu-id="29adb-109">Enlisting Resources in a Transaction</span></span>

<span data-ttu-id="29adb-110">為了讓資源參與交易，資源必須登記到交易中。</span><span class="sxs-lookup"><span data-stu-id="29adb-110">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="29adb-111"><xref:System.Transactions.Transaction>類別會定義一組方法，其名稱開頭為**Enlist**可提供此功能的登錄。</span><span class="sxs-lookup"><span data-stu-id="29adb-111">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="29adb-112">不同的**登錄方法會**對應至資源管理員可能擁有的不同登記類型。</span><span class="sxs-lookup"><span data-stu-id="29adb-112">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="29adb-113">具體來說，您可以使用變動性資源的 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法，以及永久性資源的 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="29adb-113">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="29adb-114">資源管理員的永久性 (反之為變動性) 指的是資源管理員是否支援故障復原。</span><span class="sxs-lookup"><span data-stu-id="29adb-114">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="29adb-115">如果資源管理員支援故障復原，會在第一階段 (準備階段) 將資料保存在永久性儲存裝置中。這樣一來，如果資源管理員故障，資料就可以在復原後重新登記到交易中，並依據接收自 TM 的告知執行適當的動作。</span><span class="sxs-lookup"><span data-stu-id="29adb-115">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the TM.</span></span> <span data-ttu-id="29adb-116">一般來說，變動性資源管理員會將變動性資源當成記憶體中的資料結構來管理 (例如，記憶體中的交易雜湊表)，而永久性資源管理員則會管理具有較持久之備份存放區的資源 (例如，使用磁碟做為備份存放區的資料庫)。</span><span class="sxs-lookup"><span data-stu-id="29adb-116">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>

<span data-ttu-id="29adb-117">在依據資源永久性支援來決定是否採用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 或 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法之後，為了方便作業，您應該實作資源管理員的 <xref:System.Transactions.IEnlistmentNotification> 介面，以便登記資源並讓其參與兩階段交易認可 (2PC)。</span><span class="sxs-lookup"><span data-stu-id="29adb-117">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="29adb-118">如需有關2PC 的詳細資訊，請參閱[在單一階段和多重階段中認可交易](committing-a-transaction-in-single-phase-and-multi-phase.md)。</span><span class="sxs-lookup"><span data-stu-id="29adb-118">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>

<span data-ttu-id="29adb-119">單一參與者可藉由呼叫 <xref:System.Transactions.Transaction.EnlistDurable%2A> 與 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 數次為一個以上的這類通訊協定進行登記。</span><span class="sxs-lookup"><span data-stu-id="29adb-119">A single participant can enlist for more than one of these protocols by calling <xref:System.Transactions.Transaction.EnlistDurable%2A> and <xref:System.Transactions.Transaction.EnlistVolatile%2A> multiple times.</span></span>

### <a name="durable-enlistment"></a><span data-ttu-id="29adb-120">永久性登記</span><span class="sxs-lookup"><span data-stu-id="29adb-120">Durable Enlistment</span></span>

<span data-ttu-id="29adb-121">您可以使用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法來登記資源管理員，以便以永久性資源身分參與交易。</span><span class="sxs-lookup"><span data-stu-id="29adb-121">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods are used to enlist a resource manager for participation in the transaction as a durable resource.</span></span>  <span data-ttu-id="29adb-122">如果永久性資源管理員在交易中途停機，預期它會重新登記 (使用 <xref:System.Transactions.TransactionManager.Reenlist%2A> 方法) 到所有已參與但未完成第二階段的交易中，並於重新上線後執行復原。一旦完成復原程序，資源管理員便會呼叫 <xref:System.Transactions.TransactionManager.RecoveryComplete%2A>。</span><span class="sxs-lookup"><span data-stu-id="29adb-122">It is expected that if a durable resource manager is brought down in the middle of a transaction, it can perform recovery once it is brought back online by reenlisting (using the <xref:System.Transactions.TransactionManager.Reenlist%2A> method) in all transactions in which it was a participant and did not complete phase 2, and call <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> once it finishes recovery processing.</span></span> <span data-ttu-id="29adb-123">如需有關復原的詳細資訊，請參閱[執行](performing-recovery.md)復原。</span><span class="sxs-lookup"><span data-stu-id="29adb-123">For more information on recovery, see [Performing Recovery](performing-recovery.md).</span></span>

<span data-ttu-id="29adb-124">所有 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法都會將 <xref:System.Guid> 物件當成第一個參數。</span><span class="sxs-lookup"><span data-stu-id="29adb-124">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods all take a <xref:System.Guid> object as their first parameter.</span></span> <span data-ttu-id="29adb-125">交易管理員會使用 <xref:System.Guid>，將永久性登記與特定的資源管理員關聯在一起。</span><span class="sxs-lookup"><span data-stu-id="29adb-125">The <xref:System.Guid> is used by the transaction manager to associate a durable enlistment with a particular resource manager.</span></span> <span data-ttu-id="29adb-126">這麼一來，資源管理員在重新啟動時就必須持續使用相同的 <xref:System.Guid> 來辨識自己 (即使是在不同的資源管理員之間亦然)，否則復原會失敗。</span><span class="sxs-lookup"><span data-stu-id="29adb-126">As such, it is imperative that a resource manager consistently uses the same <xref:System.Guid> to identify itself even across different resource managers upon restarting, otherwise the recovery can fail.</span></span>

<span data-ttu-id="29adb-127"><xref:System.Transactions.Transaction.EnlistDurable%2A> 方法的第二個參數會參考某個資源管理員實作以接收交易告知的物件。</span><span class="sxs-lookup"><span data-stu-id="29adb-127">The second parameter of the <xref:System.Transactions.Transaction.EnlistDurable%2A> method is a reference to the object that the resource manager implements to receive transaction notifications.</span></span> <span data-ttu-id="29adb-128">您會使用多載來告知交易管理員有關資源管理員是否支援單一階段交易認可 (SPC) 最佳化。</span><span class="sxs-lookup"><span data-stu-id="29adb-128">The overload you use informs the transaction manager whether your resource manager supports the Single Phase Commit (SPC) optimization.</span></span> <span data-ttu-id="29adb-129">在大部分情況下，您應該實作 介面來參與兩階段交易認可 (2PC)。</span><span class="sxs-lookup"><span data-stu-id="29adb-129">Most of the time you would implement the <xref:System.Transactions.IEnlistmentNotification> interface to take part in Two-Phase Commit (2PC).</span></span> <span data-ttu-id="29adb-130">但是，如果您希望最佳化交易認可處理序，則可以考慮實作 SPC 的 <xref:System.Transactions.ISinglePhaseNotification> 介面。</span><span class="sxs-lookup"><span data-stu-id="29adb-130">However, if you want to optimize the commit process, you can consider implementing the <xref:System.Transactions.ISinglePhaseNotification> interface for SPC.</span></span> <span data-ttu-id="29adb-131">如需有關 SPC 的詳細資訊，請參閱[使用單一階段認可和可提升單一階段通知](optimization-spc-and-promotable-spn.md)，[在單一階段和多階段](committing-a-transaction-in-single-phase-and-multi-phase.md)和優化中認可交易。</span><span class="sxs-lookup"><span data-stu-id="29adb-131">For more information on SPC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) and [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

<span data-ttu-id="29adb-132">第三個參數是一種 <xref:System.Transactions.EnlistmentOptions> 列舉型別，其值可為 <xref:System.Transactions.EnlistmentOptions.None> 或 <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>。</span><span class="sxs-lookup"><span data-stu-id="29adb-132">The third parameter is an <xref:System.Transactions.EnlistmentOptions> enumeration, whose value can be either <xref:System.Transactions.EnlistmentOptions.None> or <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>.</span></span> <span data-ttu-id="29adb-133">如果將值設為 <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>，登記作業可能會在收到來自交易管理員的準備告知時登記額外的資源管理員。</span><span class="sxs-lookup"><span data-stu-id="29adb-133">If the value is set to <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>, the enlistment may enlist additional resource managers upon receiving the Prepare notification from the transaction manager.</span></span> <span data-ttu-id="29adb-134">但是，您應該了解這種登記型別不適用於單一階段交易認可最佳化作業。</span><span class="sxs-lookup"><span data-stu-id="29adb-134">However, you should be aware that this type of enlistment is not eligible for the Single Phase Commit optimization.</span></span>

### <a name="volatile-enlistment"></a><span data-ttu-id="29adb-135">變動性登記</span><span class="sxs-lookup"><span data-stu-id="29adb-135">Volatile Enlistment</span></span>

<span data-ttu-id="29adb-136">管理快取之類的變動性資源的參與者，應該使用 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法來登記。</span><span class="sxs-lookup"><span data-stu-id="29adb-136">Participants managing volatile resources such as a cache should enlist using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods.</span></span> <span data-ttu-id="29adb-137">此類物件也許無法取得交易結果，或是在系統故障後復原所參與的任何交易狀態。</span><span class="sxs-lookup"><span data-stu-id="29adb-137">Such objects might not be able to obtain the outcome of a transaction or recover the state of any transaction they participate in after a system failure.</span></span>

<span data-ttu-id="29adb-138">如同先前所述，如果資源管理員負責管理記憶體中的變動性資源，就需要進行變動性登記作業。</span><span class="sxs-lookup"><span data-stu-id="29adb-138">As stated previously, a resource manager would make a volatile enlistment if it manages an in-memory, volatile resource.</span></span> <span data-ttu-id="29adb-139">使用 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 的其中一項好處就是，它不會強制擴大不必要的交易規模。</span><span class="sxs-lookup"><span data-stu-id="29adb-139">One of the benefits of using <xref:System.Transactions.Transaction.EnlistVolatile%2A> is that it does not force an unnecessary escalation of the transaction.</span></span> <span data-ttu-id="29adb-140">如需交易擴大的詳細資訊，請參閱[交易管理擴大](transaction-management-escalation.md)主題。</span><span class="sxs-lookup"><span data-stu-id="29adb-140">For more information on transaction escalation, see [Transaction Management Escalation](transaction-management-escalation.md) topic.</span></span> <span data-ttu-id="29adb-141">登記變動性意味著交易管理員處理登記的方式，以及交易管理員預期的資源管理員有何差異。</span><span class="sxs-lookup"><span data-stu-id="29adb-141">Enlisting volatility implies both a difference in how the enlistment is handled by the transaction manager, as well as what is expected of the resource manager by the transaction manager.</span></span> <span data-ttu-id="29adb-142">這是因為變動性資源管理員無法執行復原。</span><span class="sxs-lookup"><span data-stu-id="29adb-142">This is because a volatile resource manager does not perform recovery.</span></span> <span data-ttu-id="29adb-143"><xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法不會使用 <xref:System.Guid> 參數，因為變動性資源管理員無法執行復原，也無法呼叫需要 <xref:System.Transactions.TransactionManager.Reenlist%2A> 的 <xref:System.Guid> 方法。</span><span class="sxs-lookup"><span data-stu-id="29adb-143">The <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods do not take a <xref:System.Guid> parameter, because a volatile resource manager does not perform recovery and would not call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method which needs a <xref:System.Guid>.</span></span>

<span data-ttu-id="29adb-144">有關永久性登記方面，不管您使用哪種多載方法來登記，都會向交易管理員表示您的資源管理員是否支援單一階段交易認可最佳化。</span><span class="sxs-lookup"><span data-stu-id="29adb-144">As with durable enlistments, whichever overload method you use to enlist denotes to the transaction manager whether your resource manager supports the Single Phase Commit optimization.</span></span> <span data-ttu-id="29adb-145">由於變動性資源管理員無法執行復原，因此準備階段期間不會針對變動性登記寫入復原資訊。</span><span class="sxs-lookup"><span data-stu-id="29adb-145">Since a volatile resource manager cannot perform recovery, no recovery information is written for a volatile enlistment during the Prepare phase.</span></span> <span data-ttu-id="29adb-146">如此一來，呼叫 <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> 方法將產生 <xref:System.InvalidOperationException> 的結果。</span><span class="sxs-lookup"><span data-stu-id="29adb-146">Therefore, calling the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> method results in an <xref:System.InvalidOperationException>.</span></span>

<span data-ttu-id="29adb-147">下列範例會顯示如何使用 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法將此類物件登記為交易中的參與者。</span><span class="sxs-lookup"><span data-stu-id="29adb-147">The following example shows how to enlist such an object as a participant in a transaction using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span>

[!code-csharp[Tx_Enlist#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_enlist/cs/enlist.cs#1)]
[!code-vb[Tx_Enlist#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_enlist/vb/enlist.vb#1)]

### <a name="optimizing-performance"></a><span data-ttu-id="29adb-148">最佳化效能</span><span class="sxs-lookup"><span data-stu-id="29adb-148">Optimizing Performance</span></span>

<span data-ttu-id="29adb-149"><xref:System.Transactions.Transaction> 類別也會提供 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 方法，以便登記可提升單一階段登記 (PSPE)。</span><span class="sxs-lookup"><span data-stu-id="29adb-149">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="29adb-150">這樣一來永久性資源管理員 (RM) 就可以裝載並「擁有」交易，並可在稍後視需要將規模擴大為由 MSDTC 管理。</span><span class="sxs-lookup"><span data-stu-id="29adb-150">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="29adb-151">如需這種情況的詳細資訊，請參閱[使用單一階段認可和可提升單一階段通知的優化](optimization-spc-and-promotable-spn.md)。</span><span class="sxs-lookup"><span data-stu-id="29adb-151">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="29adb-152">另請參閱</span><span class="sxs-lookup"><span data-stu-id="29adb-152">See also</span></span>

- [<span data-ttu-id="29adb-153">使用單一階段認可和可提升單一階段通知進行最佳化</span><span class="sxs-lookup"><span data-stu-id="29adb-153">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)
- [<span data-ttu-id="29adb-154">在單一階段和多重階段中認可異動</span><span class="sxs-lookup"><span data-stu-id="29adb-154">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
