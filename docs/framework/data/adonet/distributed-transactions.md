---
title: 分散式交易
ms.date: 03/30/2017
ms.assetid: 718b257c-bcb2-408e-b004-a7b0adb1c176
ms.openlocfilehash: b6553d50039ca0f4888f0610b187c6b419a462b5
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2020
ms.locfileid: "91153193"
---
# <a name="distributed-transactions"></a><span data-ttu-id="482ea-102">分散式交易</span><span class="sxs-lookup"><span data-stu-id="482ea-102">Distributed Transactions</span></span>

<span data-ttu-id="482ea-103">異動是一組相關工作，尤其是它會做為一個單位的成功 (認可) 或失敗 (中止)。</span><span class="sxs-lookup"><span data-stu-id="482ea-103">A transaction is a set of related tasks that either succeeds (commit) or fails (abort) as a unit, among other things.</span></span> <span data-ttu-id="482ea-104">*分散式交易*是影響數個資源的交易。</span><span class="sxs-lookup"><span data-stu-id="482ea-104">A *distributed transaction* is a transaction that affects several resources.</span></span> <span data-ttu-id="482ea-105">對於要認可的分散式異動，所有參與者都必須保證資料的任何變更都是永久的。</span><span class="sxs-lookup"><span data-stu-id="482ea-105">For a distributed transaction to commit, all participants must guarantee that any change to data will be permanent.</span></span> <span data-ttu-id="482ea-106">不管系統是否當機，還是發生其他不可預見的事件，變更必須持續。</span><span class="sxs-lookup"><span data-stu-id="482ea-106">Changes must persist despite system crashes or other unforeseen events.</span></span> <span data-ttu-id="482ea-107">如果單一參與者無法做出此保證，則整個異動會失敗，異動範圍內的任何資料變更都將復原。</span><span class="sxs-lookup"><span data-stu-id="482ea-107">If even a single participant fails to make this guarantee, the entire transaction fails, and any changes to data within the scope of the transaction are rolled back.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="482ea-108">如果在異動作用期間啟動了 `DataReader`，而您嘗試認可或復原該異動，就會擲回例外狀況 (Exception)。</span><span class="sxs-lookup"><span data-stu-id="482ea-108">An exception will be thrown if you attempt to commit or roll back a transaction if a `DataReader` is started while the transaction is active.</span></span>  
  
## <a name="working-with-systemtransactions"></a><span data-ttu-id="482ea-109">使用 System.Transactions</span><span class="sxs-lookup"><span data-stu-id="482ea-109">Working with System.Transactions</span></span>  

 <span data-ttu-id="482ea-110">在 .NET Framework 中，會透過 <xref:System.Transactions> 命名空間中的 API 來管理分散式異動。</span><span class="sxs-lookup"><span data-stu-id="482ea-110">In the .NET Framework, distributed transactions are managed through the API in the <xref:System.Transactions> namespace.</span></span> <span data-ttu-id="482ea-111">當涉及多個持續性資源管理員時，<xref:System.Transactions> API 會將分散式異動處理委派給異動監視器，如 Microsoft 分散式異動協調器 (MS DTC)。</span><span class="sxs-lookup"><span data-stu-id="482ea-111">The <xref:System.Transactions> API will delegate distributed transaction handling to a transaction monitor such as the Microsoft Distributed Transaction Coordinator (MS DTC) when multiple persistent resource managers are involved.</span></span> <span data-ttu-id="482ea-112">如需詳細資訊，請參閱 [交易基礎](../transactions/transaction-fundamentals.md)概念。</span><span class="sxs-lookup"><span data-stu-id="482ea-112">For more information, see [Transaction Fundamentals](../transactions/transaction-fundamentals.md).</span></span>  
  
 <span data-ttu-id="482ea-113">ADO.NET 2.0 支援使用 `EnlistTransaction` 方法在分散式交易中登記，該方法會在 <xref:System.Transactions.Transaction> 執行個體中登記連接。</span><span class="sxs-lookup"><span data-stu-id="482ea-113">ADO.NET 2.0 introduced support for enlisting in a distributed transaction using the `EnlistTransaction` method, which enlists a connection in a <xref:System.Transactions.Transaction> instance.</span></span> <span data-ttu-id="482ea-114">在舊版 ADO.NET 中，會使用連接的 `EnlistDistributedTransaction` 方法在分散式異動中進行明確登記，以在支援回溯相容性的 <xref:System.EnterpriseServices.ITransaction> 執行個體 (Instance) 中登記連接。</span><span class="sxs-lookup"><span data-stu-id="482ea-114">In previous versions of ADO.NET, explicit enlistment in distributed transactions was performed using the `EnlistDistributedTransaction` method of a connection to enlist a connection in a <xref:System.EnterpriseServices.ITransaction> instance, which is supported for backwards compatibility.</span></span> <span data-ttu-id="482ea-115">如需企業服務交易的詳細資訊，請參閱 [與 Enterprise services 和 COM + 交易的互通性](../transactions/interoperability-with-enterprise-services-and-com-transactions.md)。</span><span class="sxs-lookup"><span data-stu-id="482ea-115">For more information on Enterprise Services transactions, see [Interoperability with Enterprise Services and COM+ Transactions](../transactions/interoperability-with-enterprise-services-and-com-transactions.md).</span></span>  
  
 <span data-ttu-id="482ea-116">當針對 SQL Server 資料庫，使用具有 SQL Server 的 .NET Framework 提供者之 <xref:System.Transactions> 異動時，會自動使用輕量型 <xref:System.Transactions.Transaction>。</span><span class="sxs-lookup"><span data-stu-id="482ea-116">When using a <xref:System.Transactions> transaction with the .NET Framework Provider for SQL Server against a SQL Server database, a lightweight <xref:System.Transactions.Transaction> will automatically be used.</span></span> <span data-ttu-id="482ea-117">然後，交易可視需要提升為完全分散式交易。</span><span class="sxs-lookup"><span data-stu-id="482ea-117">The transaction can then be promoted to a full distributed transaction on an as-needed basis.</span></span> <span data-ttu-id="482ea-118">如需詳細資訊，請參閱 [System. 交易與 SQL Server 整合](system-transactions-integration-with-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="482ea-118">For more information, see [System.Transactions Integration with SQL Server](system-transactions-integration-with-sql-server.md).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="482ea-119">Oracle 資料庫一次可參與的分散式交易數目上限預設為 10。</span><span class="sxs-lookup"><span data-stu-id="482ea-119">The maximum number of distributed transactions that an Oracle database can participate in at one time is set to 10 by default.</span></span> <span data-ttu-id="482ea-120">與 Oracle 資料庫連接時，在第 10 次交易後會擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="482ea-120">After the 10th transaction when connected to an Oracle database, an exception is thrown.</span></span> <span data-ttu-id="482ea-121">Oracle 不支援分散式異動內的 `DDL`。</span><span class="sxs-lookup"><span data-stu-id="482ea-121">Oracle does not support `DDL` inside of a distributed transaction.</span></span>  
  
## <a name="automatically-enlisting-in-a-distributed-transaction"></a><span data-ttu-id="482ea-122">自動登記分散式異動</span><span class="sxs-lookup"><span data-stu-id="482ea-122">Automatically Enlisting in a Distributed Transaction</span></span>  

 <span data-ttu-id="482ea-123">自動登記是整合 ADO.NET 連接與 `System.Transactions` 的預設 (及慣用) 方式。</span><span class="sxs-lookup"><span data-stu-id="482ea-123">Automatic enlistment is the default (and preferred) way of integrating ADO.NET connections with `System.Transactions`.</span></span> <span data-ttu-id="482ea-124">如果連接物件確定交易處於作用中 (在 `System.Transaction` 詞彙中，表示 `Transaction.Current` 不為 Null)，則會自動在現有分散式交易中登記。</span><span class="sxs-lookup"><span data-stu-id="482ea-124">A connection object will automatically enlist in an existing distributed transaction if it determines that a transaction is active, which, in `System.Transaction` terms, means that `Transaction.Current` is not null.</span></span> <span data-ttu-id="482ea-125">當開啟連接時，即會發生自動異動登記。</span><span class="sxs-lookup"><span data-stu-id="482ea-125">Automatic transaction enlistment occurs when the connection is opened.</span></span> <span data-ttu-id="482ea-126">之後即使在異動範圍內執行命令，該事件也不會發生。</span><span class="sxs-lookup"><span data-stu-id="482ea-126">It will not happen after that even if a command is executed inside of a transaction scope.</span></span> <span data-ttu-id="482ea-127">您可藉由指定 `Enlist=false` 做為 <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType> 的連接字串參數，或指定 `OLE DB Services=-7` 做為 <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType> 的連接字串參數，停用現有交易中的自動登記。</span><span class="sxs-lookup"><span data-stu-id="482ea-127">You can disable auto-enlistment in existing transactions by specifying `Enlist=false` as a connection string parameter for a <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType>, or `OLE DB Services=-7` as a connection string parameter for an <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="482ea-128">如需 Oracle 及 ODBC 連接字串參數的詳細資訊，請參閱 <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType> 及 <xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="482ea-128">For more information on Oracle and ODBC connection string parameters, see <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType> and <xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>.</span></span>  
  
## <a name="manually-enlisting-in-a-distributed-transaction"></a><span data-ttu-id="482ea-129">在分散式異動中手動登記</span><span class="sxs-lookup"><span data-stu-id="482ea-129">Manually Enlisting in a Distributed Transaction</span></span>  

 <span data-ttu-id="482ea-130">如果停用了自動登記，或需要登記在開啟連接之後啟動的交易，您可以針對所使用的提供者，使用 `EnlistTransaction` 物件的 <xref:System.Data.Common.DbConnection> 方法，在現有的分散式交易中登記。</span><span class="sxs-lookup"><span data-stu-id="482ea-130">If auto-enlistment is disabled or you need to enlist a transaction that was started after the connection was opened, you can enlist in an existing distributed transaction using the `EnlistTransaction` method of the <xref:System.Data.Common.DbConnection> object for the provider you are working with.</span></span> <span data-ttu-id="482ea-131">在現有的分散式異動中登記可確保，如果認可或復原異動，則也會認可或復原資料來源的程式碼所做的修改。</span><span class="sxs-lookup"><span data-stu-id="482ea-131">Enlisting in an existing distributed transaction ensures that, if the transaction is committed or rolled back, modifications made by the code at the data source will be committed or rolled back as well.</span></span>  
  
 <span data-ttu-id="482ea-132">當共用商務物件時，在分散式異動中登記會特別適用。</span><span class="sxs-lookup"><span data-stu-id="482ea-132">Enlisting in distributed transactions is particularly applicable when pooling business objects.</span></span> <span data-ttu-id="482ea-133">如果與開啟的連接共用商務物件，則僅當該連接開啟時，才會發生自動交易登記。</span><span class="sxs-lookup"><span data-stu-id="482ea-133">If a business object is pooled with an open connection, automatic transaction enlistment only occurs when that connection is opened.</span></span> <span data-ttu-id="482ea-134">如果使用共用的商務物件來執行多個異動，則該物件的開啟連接將不會自動在新起始的異動中登記。</span><span class="sxs-lookup"><span data-stu-id="482ea-134">If multiple transactions are performed using the pooled business object, the open connection for that object will not automatically enlist in newly initiated transactions.</span></span> <span data-ttu-id="482ea-135">在此情況下，您可以停用連接的自動異動登記，並使用 `EnlistTransaction` 在異動中登記連接。</span><span class="sxs-lookup"><span data-stu-id="482ea-135">In this case, you can disable automatic transaction enlistment for the connection and enlist the connection in transactions using `EnlistTransaction`.</span></span>  
  
 <span data-ttu-id="482ea-136">`EnlistTransaction` 採用型別的單一引數 <xref:System.Transactions.Transaction> ，這是現有交易的參考。</span><span class="sxs-lookup"><span data-stu-id="482ea-136">`EnlistTransaction` takes a single argument of type <xref:System.Transactions.Transaction> that is a reference to the existing transaction.</span></span> <span data-ttu-id="482ea-137">呼叫連接的 `EnlistTransaction` 方法之後，對使用連接之資料來源所做的所有修改都會包含在異動中。</span><span class="sxs-lookup"><span data-stu-id="482ea-137">After calling the connection's `EnlistTransaction` method, all modifications made at the data source using the connection are included in the transaction.</span></span> <span data-ttu-id="482ea-138">傳遞 Null 值可將連接從目前的分散式異動登記中取消登記。</span><span class="sxs-lookup"><span data-stu-id="482ea-138">Passing a null value unenlists the connection from its current distributed transaction enlistment.</span></span> <span data-ttu-id="482ea-139">請注意，在呼叫 `EnlistTransaction` 之前，必須先開啟連接。</span><span class="sxs-lookup"><span data-stu-id="482ea-139">Note that the connection must be opened before calling `EnlistTransaction`.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="482ea-140">在交易上明確地登記連接之後，直到第一個交易完成之前，無法取消登記或在其他交易中登記它。</span><span class="sxs-lookup"><span data-stu-id="482ea-140">Once a connection is explicitly enlisted on a transaction, it cannot be un-enlisted or enlisted in another transaction until the first transaction finishes.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="482ea-141">如果連接已使用連接的 `EnlistTransaction` 方法啟動異動，則 <xref:System.Data.Common.DbConnection.BeginTransaction%2A> 會擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="482ea-141">`EnlistTransaction` throws an exception if the connection has already begun a transaction using the connection's <xref:System.Data.Common.DbConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="482ea-142">不過，如果異動是在資料來源上啟動的本機異動 (例如，使用 <xref:System.Data.SqlClient.SqlCommand>，明確執行 BEGIN TRANSACTION 陳述式)，則 `EnlistTransaction` 將復原本機異動，並按要求在現有的分散式異動中登記。</span><span class="sxs-lookup"><span data-stu-id="482ea-142">However, if the transaction is a local transaction started at the data source (for example, executing the BEGIN TRANSACTION statement explicitly using a <xref:System.Data.SqlClient.SqlCommand>), `EnlistTransaction` will roll back the local transaction and enlist in the existing distributed transaction as requested.</span></span> <span data-ttu-id="482ea-143">您不會收到復原本機異動的通知，而且必須管理所有非使用 <xref:System.Data.Common.DbConnection.BeginTransaction%2A> 啟動的本機異動。</span><span class="sxs-lookup"><span data-stu-id="482ea-143">You will not receive notice that the local transaction was rolled back, and must manage any local transactions not started using <xref:System.Data.Common.DbConnection.BeginTransaction%2A>.</span></span> <span data-ttu-id="482ea-144">如果您是將 .NET Framework Data Provider for SQL Server (`SqlClient`) 用於 SQL Server，則嘗試登記會擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="482ea-144">If you are using the .NET Framework Data Provider for SQL Server (`SqlClient`) with SQL Server, an attempt to enlist will throw an exception.</span></span> <span data-ttu-id="482ea-145">將不會偵測到所有其他情況。</span><span class="sxs-lookup"><span data-stu-id="482ea-145">All other cases will go undetected.</span></span>  
  
## <a name="promotable-transactions-in-sql-server"></a><span data-ttu-id="482ea-146">SQL Server 中的可提升異動</span><span class="sxs-lookup"><span data-stu-id="482ea-146">Promotable Transactions in SQL Server</span></span>  

 <span data-ttu-id="482ea-147">SQL Server 支援可提升異動，在該異動中，本機輕量型異動可在必要時自動提升為分散式異動。</span><span class="sxs-lookup"><span data-stu-id="482ea-147">SQL Server supports promotable transactions in which a local lightweight transaction can be automatically promoted to a distributed transaction only if it is required.</span></span> <span data-ttu-id="482ea-148">除非需要已加入的負荷，否則可提升交易不會叫用分散式交易的已加入負荷。</span><span class="sxs-lookup"><span data-stu-id="482ea-148">A promotable transaction does not invoke the added overhead of a distributed transaction unless the added overhead is required.</span></span> <span data-ttu-id="482ea-149">如需詳細資訊和程式碼範例，請參閱 [System. 交易與 SQL Server 整合](system-transactions-integration-with-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="482ea-149">For more information and a code sample, see [System.Transactions Integration with SQL Server](system-transactions-integration-with-sql-server.md).</span></span>  
  
## <a name="configuring-distributed-transactions"></a><span data-ttu-id="482ea-150">設定分散式異動</span><span class="sxs-lookup"><span data-stu-id="482ea-150">Configuring Distributed Transactions</span></span>  

 <span data-ttu-id="482ea-151">您可能需要透過網路啟用 MS DTC，才能使用分散式異動。</span><span class="sxs-lookup"><span data-stu-id="482ea-151">You may need to enable the MS DTC over the network in order to use distributed transactions.</span></span> <span data-ttu-id="482ea-152">如果已啟用 Windows 防火牆，則必須允許 MS DTC 服務使用網路或開啟 MS DTC 連接埠。</span><span class="sxs-lookup"><span data-stu-id="482ea-152">If have the Windows Firewall enabled, you must allow the MS DTC service to use the network or open the MS DTC port.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="482ea-153">另請參閱</span><span class="sxs-lookup"><span data-stu-id="482ea-153">See also</span></span>

- [<span data-ttu-id="482ea-154">異動和並行存取</span><span class="sxs-lookup"><span data-stu-id="482ea-154">Transactions and Concurrency</span></span>](transactions-and-concurrency.md)
- [<span data-ttu-id="482ea-155">System.Transactions 與 SQL Server 整合</span><span class="sxs-lookup"><span data-stu-id="482ea-155">System.Transactions Integration with SQL Server</span></span>](system-transactions-integration-with-sql-server.md)
- <span data-ttu-id="482ea-156">[ADO.NET 概觀](ado-net-overview.md) \(部分機器翻譯\)</span><span class="sxs-lookup"><span data-stu-id="482ea-156">[ADO.NET Overview](ado-net-overview.md)</span></span>
