---
title: OLE DB、ODBC 和 Oracle 連接共用
ms.date: 03/30/2017
ms.assetid: 2bd83b1e-3ea9-43c4-bade-d9cdb9bbbb04
ms.openlocfilehash: 0ff3cbd89482645ff8d52e3144f1a82fd05d8013
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2020
ms.locfileid: "91150683"
---
# <a name="ole-db-odbc-and-oracle-connection-pooling"></a><span data-ttu-id="e3d2f-102">OLE DB、ODBC 和 Oracle 連接共用</span><span class="sxs-lookup"><span data-stu-id="e3d2f-102">OLE DB, ODBC, and Oracle connection pooling</span></span>

<span data-ttu-id="e3d2f-103">共用連接可顯著提高應用程式的效能及延展性。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-103">Pooling connections can significantly enhance the performance and scalability of your application.</span></span> <span data-ttu-id="e3d2f-104">本節討論 OLE DB、ODBC 及 Oracle 的 .NET Framework 資料提供者的連接共用。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-104">This section discusses connection pooling for the .NET Framework data providers for OLE DB, ODBC, and Oracle.</span></span>

## <a name="oledb"></a><span data-ttu-id="e3d2f-105">OleDb</span><span class="sxs-lookup"><span data-stu-id="e3d2f-105">OleDb</span></span>

<span data-ttu-id="e3d2f-106">OLE DB 的 .NET Framework 資料提供者會自動使用 OLE DB 工作階段共用來共用連接。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-106">The .NET Framework Data Provider for OLE DB automatically pools connections using OLE DB session pooling.</span></span> <span data-ttu-id="e3d2f-107">連接字串引數可用於啟用或停用 OLE DB 服務 (包括共用)。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-107">Connection string arguments can be used to enable or disable OLE DB services including pooling.</span></span> <span data-ttu-id="e3d2f-108">例如，下列連接字串會停用 OLE DB 工作階段共用及自動異動登記。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-108">For example, the following connection string disables OLE DB session pooling and automatic transaction enlistment.</span></span>

```csharp
Provider=SQLOLEDB;OLE DB Services=-4;Data Source=localhost;Integrated Security=SSPI;
```

 <span data-ttu-id="e3d2f-109">建議您在完成使用連接後，一定要關閉或處置該連接，以便將連接傳回集區。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-109">We recommend that you always close or dispose of a connection when you are finished using it in order to return the connection to the pool.</span></span> <span data-ttu-id="e3d2f-110">未明確關閉的連接可能無法傳回集區。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-110">Connections that are not explicitly closed may not get returned to the pool.</span></span> <span data-ttu-id="e3d2f-111">例如，已離開範圍但尚未明確關閉的連接僅會在已達到最大集區大小，且連接仍然有效時，才會回到連接集區。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-111">For example, a connection that has gone out of scope but that has not been explicitly closed will only be returned to the connection pool if the maximum pool size has been reached and the connection is still valid.</span></span>

 <span data-ttu-id="e3d2f-112">如需 OLE DB 會話或資源分享的詳細資訊，以及如何藉由覆寫 OLE DB 提供者服務預設值來停用共用的詳細資訊，請參閱 OLE DB 程式設計 [人員手冊](/previous-versions/windows/desktop/ms713643(v=vs.85))。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-112">For more information about OLE DB session or resource pooling, as well as how to disable pooling by overriding OLE DB provider service defaults, see the [OLE DB Programmer's Guide](/previous-versions/windows/desktop/ms713643(v=vs.85)).</span></span>

## <a name="odbc"></a><span data-ttu-id="e3d2f-113">ODBC</span><span class="sxs-lookup"><span data-stu-id="e3d2f-113">ODBC</span></span>

 <span data-ttu-id="e3d2f-114">ODBC 的 .NET Framework 資料提供者連接共用由用於連接的 ODBC 驅動程式管理員管理，並且不受 ODBC 的 .NET Framework 資料提供者的影響。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-114">Connection pooling for the .NET Framework Data Provider for ODBC is managed by the ODBC Driver Manager that is used for the connection, and is not affected by the .NET Framework Data Provider for ODBC.</span></span>

 <span data-ttu-id="e3d2f-115">若要啟用或停用連接共用，請在主控台的 [系統管理工具] 資料夾中開啟 [ **ODBC 資料來源管理員** ]。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-115">To enable or disable connection pooling, open **ODBC Data Source Administrator** in the Administrative Tools folder of Control Panel.</span></span> <span data-ttu-id="e3d2f-116">[ **連接** 共用] 索引標籤可讓您指定每個已安裝 ODBC 驅動程式的連接共用參數。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-116">The **Connection Pooling** tab allows you to specify connection pooling parameters for each ODBC driver installed.</span></span> <span data-ttu-id="e3d2f-117">特定 ODBC 驅動程式的連接共用變更會影響使用該 ODBC 驅動程式的所有應用程式。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-117">Connection pooling changes for a specific ODBC driver affect all applications that use that ODBC driver.</span></span>

## <a name="oracleclient"></a><span data-ttu-id="e3d2f-118">OracleClient</span><span class="sxs-lookup"><span data-stu-id="e3d2f-118">OracleClient</span></span>

 <span data-ttu-id="e3d2f-119">Oracle 的 .NET Framework 資料提供者會自動為 ADO.NET 用戶端應用程式提供連接共用。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-119">The .NET Framework Data Provider for Oracle provides connection pooling automatically for your ADO.NET client application.</span></span> <span data-ttu-id="e3d2f-120">您也可以提供數個連接字串修飾詞，以控制連接共用行為 (請參閱本主題稍後的＜使用連接字串關鍵字控制連接共用＞)。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-120">You can also supply several connection string modifiers to control connection pooling behavior (see "Controlling Connection Pooling with Connection String Keywords," later in this topic).</span></span>

### <a name="create-and-assign-pools"></a><span data-ttu-id="e3d2f-121">建立和指派集區</span><span class="sxs-lookup"><span data-stu-id="e3d2f-121">Create and assign pools</span></span>

 <span data-ttu-id="e3d2f-122">當開啟連接時，會依據將集區與連接中連接字串相關聯的精確比對演算法，建立連接集區。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-122">When a connection is opened, a connection pool is created based on an exact matching algorithm that associates the pool with the connection string in the connection.</span></span> <span data-ttu-id="e3d2f-123">每個連接集區與不同的連接字串相關聯。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-123">Each connection pool is associated with a distinct connection string.</span></span> <span data-ttu-id="e3d2f-124">開啟新連接時，如果連接字串與現有集區並不完全相符，則會建立新集區。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-124">When a new connection is opened, if the connection string is not an exact match to an existing pool, a new pool is created.</span></span>

 <span data-ttu-id="e3d2f-125">一旦建立，便無法損毀連接集區，直到作用中處理序結束為止。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-125">Once created, connection pools are not destroyed until the active process ends.</span></span> <span data-ttu-id="e3d2f-126">維護非作用中或空的集區所耗用的系統資源極少。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-126">Maintaining inactive or empty pools uses very few system resources.</span></span>

### <a name="connection-addition"></a><span data-ttu-id="e3d2f-127">加入連接</span><span class="sxs-lookup"><span data-stu-id="e3d2f-127">Connection Addition</span></span>

 <span data-ttu-id="e3d2f-128">針對每個唯一連接字串可建立連接集區。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-128">A connection pool is created for each unique connection string.</span></span> <span data-ttu-id="e3d2f-129">建立集區時，會建立多個連接物件並加入集區，以滿足最小集區大小需求。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-129">When a pool is created, multiple connection objects are created and added to the pool so that the minimum pool size requirement is satisfied.</span></span> <span data-ttu-id="e3d2f-130">視需要將連接加入集區，不超過最大集區大小。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-130">Connections are added to the pool as needed, up to the maximum pool size.</span></span>

 <span data-ttu-id="e3d2f-131">當要求 <xref:System.Data.OracleClient.OracleConnection> 物件時，若有可用的連接，則會從集區取得該物件。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-131">When an <xref:System.Data.OracleClient.OracleConnection> object is requested, it is obtained from the pool if a usable connection is available.</span></span> <span data-ttu-id="e3d2f-132">若要可用，連接目前必須為未使用，並具有相符的異動內容，或未與任何異動內容關聯，同時具有到伺服器的有效連結。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-132">To be usable, the connection must currently be unused, have a matching transaction context or not be associated with any transaction context, and have a valid link to the server.</span></span>

 <span data-ttu-id="e3d2f-133">如果已達到最大集區大小，但仍沒有可用的連接，則會將要求排入佇列。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-133">If the maximum pool size has been reached and no usable connection is available, the request is queued.</span></span> <span data-ttu-id="e3d2f-134">連接共用器會在連接釋放回集區後，重新配置連接以滿足這些要求。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-134">The connection pooler satisfies these requests by reallocating connections as they are released back into the pool.</span></span> <span data-ttu-id="e3d2f-135">連接關閉或處置時，會被釋放回集區。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-135">Connections are released back into the pool when they are closed or disposed.</span></span>

### <a name="connection-removal"></a><span data-ttu-id="e3d2f-136">移除連接</span><span class="sxs-lookup"><span data-stu-id="e3d2f-136">Connection Removal</span></span>

 <span data-ttu-id="e3d2f-137">連接共用器會在閒置一段時間之後，從集區中移除連接，或者，如果共用器偵測到與伺服器的連接已中斷。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-137">The connection pooler removes a connection from the pool after it has been idle for an extended period of time or if the pooler detects that the connection with the server has been severed.</span></span> <span data-ttu-id="e3d2f-138">只有在嘗試與伺服器通訊之後，才可以偵測到此情況。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-138">This can be detected only after attempting to communicate with the server.</span></span> <span data-ttu-id="e3d2f-139">如果發現連接已不再連接到伺服器，則會將其標記為無效。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-139">If a connection is found that is no longer connected to the server, it is marked as invalid.</span></span> <span data-ttu-id="e3d2f-140">連接共用器會定期掃描連接集區，以尋找已釋放回集區及標記為無效的物件。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-140">The connection pooler periodically scans connection pools looking for objects that have been released to the pool and are marked as invalid.</span></span> <span data-ttu-id="e3d2f-141">然後會永久移除這些連接。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-141">These connections are then permanently removed.</span></span>

 <span data-ttu-id="e3d2f-142">如果連接是與已消失的伺服器連接，且連接共用器尚未偵測到已嚴重損毀的連接並將其標記為無效，則會從集區中描繪連接。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-142">If a connection exists to a server that has disappeared, this connection can be drawn from the pool if the connection pooler has not detected the severed connection and marked it as invalid.</span></span> <span data-ttu-id="e3d2f-143">此類情況發生時，會產生例外狀況。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-143">When this occurs, an exception is generated.</span></span> <span data-ttu-id="e3d2f-144">然而，您仍需關閉連接，以將它釋放回集區。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-144">However, you must still close the connection in order to release it back into the pool.</span></span>

 <span data-ttu-id="e3d2f-145">請不要在您類別之 `Close` 方法中的 `Dispose`、`Connection` 或任何其他 Managed 物件上呼叫 `DataReader` 或 `Finalize`。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-145">Do not call `Close` or `Dispose` on a `Connection`, a `DataReader`, or any other managed object in the `Finalize` method of your class.</span></span> <span data-ttu-id="e3d2f-146">在完成項中，只需釋放類別直接擁有的 Unmanaged 資源。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-146">In a finalizer, only release unmanaged resources that your class owns directly.</span></span> <span data-ttu-id="e3d2f-147">如果類別未擁有任何 Unmanaged 資源，請不要在類別定義中包含 `Finalize` 方法。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-147">If your class does not own any unmanaged resources, do not include a `Finalize` method in your class definition.</span></span> <span data-ttu-id="e3d2f-148">如需詳細資訊，請參閱 [垃圾收集](../../../standard/garbage-collection/index.md)。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-148">For more information, see [Garbage Collection](../../../standard/garbage-collection/index.md).</span></span>

### <a name="transaction-support"></a><span data-ttu-id="e3d2f-149">異動支援</span><span class="sxs-lookup"><span data-stu-id="e3d2f-149">Transaction Support</span></span>

 <span data-ttu-id="e3d2f-150">從集區中描繪連接，並根據異動內容進行指派。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-150">Connections are drawn from the pool and assigned based on transaction context.</span></span> <span data-ttu-id="e3d2f-151">要求執行緒的內容必須與指派的連接相符。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-151">The context of the requesting thread and the assigned connection must match.</span></span> <span data-ttu-id="e3d2f-152">因此，每個連接集區都會細分為沒有相關聯交易內容的連接，並分成 *N* 個分割區，每個都包含與特定交易內容的連接。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-152">Therefore, each connection pool is subdivided into connections with no associated transaction context and into *N* subdivisions that each contain connections with a particular transaction context.</span></span>

 <span data-ttu-id="e3d2f-153">連接關閉時，會根據其異動內容將其釋放回集區，並置於適當的子區塊中。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-153">When a connection is closed, it is released back into the pool and into the appropriate subdivision based on its transaction context.</span></span> <span data-ttu-id="e3d2f-154">因此，即使分散式交易仍處於暫止狀態，您仍可以關閉連接，而不會產生錯誤。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-154">Therefore, you can close the connection without generating an error, even though a distributed transaction is still pending.</span></span> <span data-ttu-id="e3d2f-155">這可讓您稍後認可或中止分散式異動。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-155">This allows you to commit or abort the distributed transaction at a later time.</span></span>

### <a name="control-connection-pooling-with-connection-string-keywords"></a><span data-ttu-id="e3d2f-156">使用連接字串關鍵字控制連接共用</span><span class="sxs-lookup"><span data-stu-id="e3d2f-156">Control Connection Pooling with Connection String Keywords</span></span>

 <span data-ttu-id="e3d2f-157"><xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A> 物件的 <xref:System.Data.OracleClient.OracleConnection> 屬性支援連接字串索引鍵/值配對，這些配對可用於調整連接共用邏輯的行為。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-157">The <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A> property of the <xref:System.Data.OracleClient.OracleConnection> object supports connection string key/value pairs that can be used to adjust the behavior of the connection pooling logic.</span></span>

 <span data-ttu-id="e3d2f-158">下表說明可用於調整連接共用行為的 <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A> 值。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-158">The following table describes the <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A> values you can use to adjust connection pooling behavior.</span></span>

|<span data-ttu-id="e3d2f-159">名稱</span><span class="sxs-lookup"><span data-stu-id="e3d2f-159">Name</span></span>|<span data-ttu-id="e3d2f-160">預設</span><span class="sxs-lookup"><span data-stu-id="e3d2f-160">Default</span></span>|<span data-ttu-id="e3d2f-161">描述</span><span class="sxs-lookup"><span data-stu-id="e3d2f-161">Description</span></span>|
|----------|-------------|-----------------|
|`Connection Lifetime`|<span data-ttu-id="e3d2f-162">0</span><span class="sxs-lookup"><span data-stu-id="e3d2f-162">0</span></span>|<span data-ttu-id="e3d2f-163">當連接傳回集區時，會將其建立時間與目前時間進行比較，如果該時間範圍 (秒) 超過 `Connection Lifetime` 指定的值，則會損毀連接。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-163">When a connection is returned to the pool, its creation time is compared with the current time, and the connection is destroyed if that time span (in seconds) exceeds the value specified by `Connection Lifetime`.</span></span> <span data-ttu-id="e3d2f-164">這在叢集組態中很有用，可在執行中伺服器與剛連線的伺服器之間強制負載平衡。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-164">This is useful in clustered configurations to force load balancing between a running server and a server just brought online.</span></span><br /><br /> <span data-ttu-id="e3d2f-165">值零 (0) 將導致共用的連接具有最大逾時。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-165">A value of zero (0) will cause pooled connections to have the maximum time-out.</span></span>|
|`Enlist`|<span data-ttu-id="e3d2f-166">'true'</span><span class="sxs-lookup"><span data-stu-id="e3d2f-166">'true'</span></span>|<span data-ttu-id="e3d2f-167">為 `true` 時，如果交易內容存在，則共用器會自動在建立執行緒之目前交易內容中登記連接。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-167">When `true`, the pooler automatically enlists the connection in the current transaction context of the creation thread if a transaction context exists.</span></span>|
|`Max Pool Size`|<span data-ttu-id="e3d2f-168">100</span><span class="sxs-lookup"><span data-stu-id="e3d2f-168">100</span></span>|<span data-ttu-id="e3d2f-169">集區中所允許的最大連接數。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-169">The maximum number of connections allowed in the pool.</span></span>|
|`Min Pool Size`|<span data-ttu-id="e3d2f-170">0</span><span class="sxs-lookup"><span data-stu-id="e3d2f-170">0</span></span>|<span data-ttu-id="e3d2f-171">集區中保留的最小連接數。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-171">The minimum number of connections maintained in the pool.</span></span>|
|`Pooling`|<span data-ttu-id="e3d2f-172">'true'</span><span class="sxs-lookup"><span data-stu-id="e3d2f-172">'true'</span></span>|<span data-ttu-id="e3d2f-173">為 `true` 時，會從適當的集區描繪連接，或視需要在適當的集區中建立及加入連接。</span><span class="sxs-lookup"><span data-stu-id="e3d2f-173">When `true`, the connection is drawn from the appropriate pool, or if necessary, created and added to the appropriate pool.</span></span>|

## <a name="see-also"></a><span data-ttu-id="e3d2f-174">另請參閱</span><span class="sxs-lookup"><span data-stu-id="e3d2f-174">See also</span></span>

- [<span data-ttu-id="e3d2f-175">連接共用</span><span class="sxs-lookup"><span data-stu-id="e3d2f-175">Connection Pooling</span></span>](connection-pooling.md)
- [<span data-ttu-id="e3d2f-176">效能計數器</span><span class="sxs-lookup"><span data-stu-id="e3d2f-176">Performance Counters</span></span>](performance-counters.md)
- <span data-ttu-id="e3d2f-177">[ADO.NET 概觀](ado-net-overview.md) \(部分機器翻譯\)</span><span class="sxs-lookup"><span data-stu-id="e3d2f-177">[ADO.NET Overview](ado-net-overview.md)</span></span>
