---
title: 資料追蹤
ms.date: 03/30/2017
ms.assetid: a6a752a5-d2a9-4335-a382-b58690ccb79f
ms.openlocfilehash: 5fe04d6b6146079db7d4e110a94ced361949998c
ms.sourcegitcommit: 27a15a55019f6b5f2733961738babe94aec0def3
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/15/2020
ms.locfileid: "90557106"
---
# <a name="data-tracing-in-adonet"></a><span data-ttu-id="ea44a-102">ADO.NET 中的資料追蹤</span><span class="sxs-lookup"><span data-stu-id="ea44a-102">Data Tracing in ADO.NET</span></span>

<span data-ttu-id="ea44a-103">ADO.NET 具備內建資料追蹤功能，可支援 SQL Server、Oracle、OLE DB 和 ODBC 的 .NET 資料提供者，以及 ADO.NET <xref:System.Data.DataSet> 和 SQL Server 的網路通訊協定。</span><span class="sxs-lookup"><span data-stu-id="ea44a-103">ADO.NET features built-in data tracing functionality that is supported by the .NET data providers for SQL Server, Oracle, OLE DB and ODBC, as well as the ADO.NET <xref:System.Data.DataSet>, and the SQL Server network protocols.</span></span>

<span data-ttu-id="ea44a-104">追蹤資料存取 API 呼叫可協助診斷下列問題：</span><span class="sxs-lookup"><span data-stu-id="ea44a-104">Tracing data access API calls can help diagnose the following problems:</span></span>

- <span data-ttu-id="ea44a-105">用戶端程式與資料庫之間的結構描述不符。</span><span class="sxs-lookup"><span data-stu-id="ea44a-105">Schema mismatch between client program and the database.</span></span>

- <span data-ttu-id="ea44a-106">無法使用資料庫或網路程式庫發生問題。</span><span class="sxs-lookup"><span data-stu-id="ea44a-106">Database unavailability or network library problems.</span></span>

- <span data-ttu-id="ea44a-107">SQL 錯誤，該 SQL 是硬式編碼或應用程式所產生的。</span><span class="sxs-lookup"><span data-stu-id="ea44a-107">Incorrect SQL whether hard coded or generated by an application.</span></span>

- <span data-ttu-id="ea44a-108">錯誤的程式設計邏輯。</span><span class="sxs-lookup"><span data-stu-id="ea44a-108">Incorrect programming logic.</span></span>

- <span data-ttu-id="ea44a-109">多個 ADO.NET 元件之間，或 ADO.NET 與您本身的元件之間互動所發生的問題。</span><span class="sxs-lookup"><span data-stu-id="ea44a-109">Issues resulting from the interaction between multiple ADO.NET components or between ADO.NET and your own components.</span></span>

<span data-ttu-id="ea44a-110">為了支援不同的追蹤技術，我們製作了可擴充的追蹤，讓開發人員追蹤任何應用程式堆疊層級的問題。</span><span class="sxs-lookup"><span data-stu-id="ea44a-110">To support different trace technologies, tracing is extensible, so a developer can trace a problem at any level of the application stack.</span></span> <span data-ttu-id="ea44a-111">雖然追蹤不是 ADO.NET 的特有功能，但 Microsoft 提供者可利用通用的追蹤和檢測應用程式開發介面。</span><span class="sxs-lookup"><span data-stu-id="ea44a-111">Although tracing is not an ADO.NET-only feature, Microsoft providers take advantage of generalized tracing and instrumentation APIs.</span></span>

<span data-ttu-id="ea44a-112">如需在 ADO.NET 中設定和設定 managed 追蹤的詳細資訊，請參閱 [追蹤資料存取](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))。</span><span class="sxs-lookup"><span data-stu-id="ea44a-112">For more information about setting and configuring managed tracing in ADO.NET, see [Tracing Data Access](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10)).</span></span>

## <a name="accessing-diagnostic-information-in-the-extended-events-log"></a><span data-ttu-id="ea44a-113">存取擴展事件記錄檔中的診斷資訊</span><span class="sxs-lookup"><span data-stu-id="ea44a-113">Accessing Diagnostic Information in the Extended Events Log</span></span>

<span data-ttu-id="ea44a-114">在 SQL Server 的 .NET Framework Data Provider 中，資料存取追蹤 ([資料存取追蹤](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))) 已更新，可讓您更輕鬆地將用戶端事件與伺服器連接信號緩衝區中的診斷資訊（例如連接失敗）相互關聯，以及擴充事件記錄檔中的應用程式效能資訊。</span><span class="sxs-lookup"><span data-stu-id="ea44a-114">In the .NET Framework Data Provider for SQL Server, data access tracing ([Data Access Tracing](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))) has been updated to make it easier to correlate client events with diagnostic information, such as connection failures, from the server's connectivity ring buffer and application performance information in the extended events log.</span></span> <span data-ttu-id="ea44a-115">如需讀取擴充事件記錄檔的資訊，請參閱[檢視事件工作階段資料](/previous-versions/sql/sql-server-2012/hh710068(v=sql.110))。</span><span class="sxs-lookup"><span data-stu-id="ea44a-115">For information about reading the extended events log, see [View Event Session Data](/previous-versions/sql/sql-server-2012/hh710068(v=sql.110)).</span></span>

<span data-ttu-id="ea44a-116">ADO.NET 會傳送用戶端連接 ID 以進行連接作業。</span><span class="sxs-lookup"><span data-stu-id="ea44a-116">For connection operations, ADO.NET will send a client connection ID.</span></span> <span data-ttu-id="ea44a-117">如果連線失敗，您可以 [使用連接信號緩衝區](/archive/blogs/sql_protocols/connectivity-troubleshooting-in-sql-server-2008-with-the-connectivity-ring-buffer)) 來存取連線信號緩衝區 (SQL Server 2008 中的連線能力疑難排解，並尋找該 `ClientConnectionID` 欄位，並取得連接失敗的相關診斷資訊。</span><span class="sxs-lookup"><span data-stu-id="ea44a-117">If the connection fails, you can access the connectivity ring buffer ([Connectivity troubleshooting in SQL Server 2008 with the Connectivity Ring Buffer](/archive/blogs/sql_protocols/connectivity-troubleshooting-in-sql-server-2008-with-the-connectivity-ring-buffer)) and find the `ClientConnectionID` field and get diagnostic information about the connection failure.</span></span> <span data-ttu-id="ea44a-118">僅在發生錯誤時，才會在信號緩衝區中記錄用戶端連接識別碼。</span><span class="sxs-lookup"><span data-stu-id="ea44a-118">Client connection IDs are logged in the ring buffer only if an error occurs.</span></span> <span data-ttu-id="ea44a-119">(如果在傳送登入前封包之前連接失敗，則不會產生用戶端連接識別碼。)用戶端連接識別碼是 16 位元組的 GUID。</span><span class="sxs-lookup"><span data-stu-id="ea44a-119">(If a connection fails before sending the prelogin packet, a client connection ID will not be generated.) The client connection ID is a 16-byte GUID.</span></span> <span data-ttu-id="ea44a-120">如果在擴充事件工作階段中將 `client_connection_id` 動作加入到事件中，您還可以在擴充事件目標輸出中尋找用戶端連接 ID。</span><span class="sxs-lookup"><span data-stu-id="ea44a-120">You can also find the client connection ID in the extended events target output, if the `client_connection_id` action is added to events in an extended events session.</span></span> <span data-ttu-id="ea44a-121">如需進一步的用戶端驅動程式診斷協助，您可以啟用資料存取追蹤並傳回連接命令，同時觀察資料存取追蹤當中的 `ClientConnectionID` 欄位。</span><span class="sxs-lookup"><span data-stu-id="ea44a-121">You can enable data access tracing and rerun the connection command and observe the `ClientConnectionID` field in the data access trace, if you need further client driver diagnostic assistance.</span></span>

<span data-ttu-id="ea44a-122">您可以使用 `SqlConnection.ClientConnectionID` 屬性，以程式設計方式取得用戶端連接 ID。</span><span class="sxs-lookup"><span data-stu-id="ea44a-122">You can get the client connection ID programmatically by using the `SqlConnection.ClientConnectionID` property.</span></span>

<span data-ttu-id="ea44a-123">成功建立連接的 `ClientConnectionID` 物件可取得 <xref:System.Data.SqlClient.SqlConnection>。</span><span class="sxs-lookup"><span data-stu-id="ea44a-123">The `ClientConnectionID` is available for a <xref:System.Data.SqlClient.SqlConnection> object that successfully establishes  a connection.</span></span> <span data-ttu-id="ea44a-124">如果連接嘗試失敗，可能可以透過 `ClientConnectionID` 取得 `SqlException.ToString`。</span><span class="sxs-lookup"><span data-stu-id="ea44a-124">If a connection attempt fails, `ClientConnectionID` may be available via `SqlException.ToString`.</span></span>

<span data-ttu-id="ea44a-125">ADO.NET 也會傳送特定執行緒活動 ID。</span><span class="sxs-lookup"><span data-stu-id="ea44a-125">ADO.NET also sends a thread-specific activity ID.</span></span> <span data-ttu-id="ea44a-126">如果會話是在啟用 TRACK_CAUSALITY 選項的情況下啟動，就會在擴充的事件會話中捕捉活動識別碼。</span><span class="sxs-lookup"><span data-stu-id="ea44a-126">The activity ID is captured in the extended events sessions if the sessions are started with the TRACK_CAUSALITY option enabled.</span></span> <span data-ttu-id="ea44a-127">如需與使用中連接相關的效能問題，您可以從用戶端的資料存取追蹤 (`ActivityID` 欄位) 取得活動識別碼，然後在擴充的事件輸出中尋找此活動識別碼。</span><span class="sxs-lookup"><span data-stu-id="ea44a-127">For performance issues with an active connection, you can get the activity ID from the client's data access trace (`ActivityID` field) and then locate the activity ID in the extended events output.</span></span> <span data-ttu-id="ea44a-128">擴充事件記錄中的活動 ID 是 16 個位元組的 GUID (和用戶端連接 ID 的 GUID 不同)，並且附加一個四位元組的序號。</span><span class="sxs-lookup"><span data-stu-id="ea44a-128">The activity ID in extended events is a 16-byte GUID (not the same as the GUID for the client connection ID) appended with a four-byte sequence number.</span></span> <span data-ttu-id="ea44a-129">此序號表示執行緒內要求的順序，並指出執行緒的批次和 RPC 陳述式的相對排序。</span><span class="sxs-lookup"><span data-stu-id="ea44a-129">The sequence number represents the order of a request within a thread and indicates the relative ordering of batch and RPC statements for the thread.</span></span> <span data-ttu-id="ea44a-130">啟用資料存取追蹤功能，而且開啟資料存取追蹤組態字詞中的第 18 個位元時，目前會選擇性地傳送 SQL 批次陳述式和 RPC 要求的 `ActivityID`。</span><span class="sxs-lookup"><span data-stu-id="ea44a-130">The `ActivityID` is currently optionally sent for SQL batch statements and RPC requests when data access tracing is enabled on and the 18th bit in the data access tracing configuration word is turned ON.</span></span>

<span data-ttu-id="ea44a-131">下列範例會使用 Transact-sql 啟動擴充的事件會話，此會話將儲存在信號緩衝區中，並且會記錄從 RPC 和批次作業的用戶端傳送的活動識別碼。</span><span class="sxs-lookup"><span data-stu-id="ea44a-131">The following is a sample that uses Transact-SQL to start an extended events session that will be stored in a ring buffer and will record the activity ID sent from a client on RPC and batch operations.</span></span>

```sql
create event session MySession on server
add event connectivity_ring_buffer_recorded,
add event sql_statement_starting (action (client_connection_id)),
add event sql_statement_completed (action (client_connection_id)),
add event rpc_starting (action (client_connection_id)),
add event rpc_completed (action (client_connection_id))
add target ring_buffer with (track_causality=on)
```

## <a name="see-also"></a><span data-ttu-id="ea44a-132">另請參閱</span><span class="sxs-lookup"><span data-stu-id="ea44a-132">See also</span></span>

- [<span data-ttu-id="ea44a-133">以 .NET Framework 進行網路追蹤</span><span class="sxs-lookup"><span data-stu-id="ea44a-133">Network Tracing in the .NET Framework</span></span>](../../network-programming/network-tracing.md)
- <span data-ttu-id="ea44a-134">[追蹤和檢測應用程式](../../debug-trace-profile/tracing-and-instrumenting-applications.md) (機器翻譯)</span><span class="sxs-lookup"><span data-stu-id="ea44a-134">[Tracing and Instrumenting Applications](../../debug-trace-profile/tracing-and-instrumenting-applications.md)</span></span>
- <span data-ttu-id="ea44a-135">[ADO.NET 概觀](ado-net-overview.md) \(部分機器翻譯\)</span><span class="sxs-lookup"><span data-stu-id="ea44a-135">[ADO.NET Overview](ado-net-overview.md)</span></span>
