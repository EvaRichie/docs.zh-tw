---
title: 探索安全性範例
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: 0957e8ddaee99e60b205c92319dc2c61e2ab007a
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/26/2020
ms.locfileid: "96292632"
---
# <a name="discovery-security-sample"></a><span data-ttu-id="f0d43-102">探索安全性範例</span><span class="sxs-lookup"><span data-stu-id="f0d43-102">Discovery Security Sample</span></span>

<span data-ttu-id="f0d43-103">探索規格不會要求參與探索程序的端點是安全的。</span><span class="sxs-lookup"><span data-stu-id="f0d43-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="f0d43-104">增強探索訊息的安全性會減少各種攻擊 (訊息變更、阻斷服務、重新執行、詐騙)。</span><span class="sxs-lookup"><span data-stu-id="f0d43-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="f0d43-105">此範例使用精簡簽章格式 (如 WS-Discovery 規格的第 8.2 節所述) 實作計算與驗證訊息簽章的自訂通道。</span><span class="sxs-lookup"><span data-stu-id="f0d43-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="f0d43-106">此範例同時支援 [2005 探索規格](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) 和 [1.1 版本](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf)。</span><span class="sxs-lookup"><span data-stu-id="f0d43-106">The sample supports both the [2005 Discovery specification](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) and the [1.1 version](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span></span>  
  
 <span data-ttu-id="f0d43-107">自訂通道會針對探索和公告端點，套用到現有通道堆疊的頂端。</span><span class="sxs-lookup"><span data-stu-id="f0d43-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="f0d43-108">如此一來，每個傳送的訊息都會套用簽章標頭。</span><span class="sxs-lookup"><span data-stu-id="f0d43-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="f0d43-109">系統會驗證收到之訊息上的簽章，而且當該簽章不符或訊息沒有簽章時，就會捨棄訊息。</span><span class="sxs-lookup"><span data-stu-id="f0d43-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="f0d43-110">為簽署與驗證訊息，此範例使用憑證。</span><span class="sxs-lookup"><span data-stu-id="f0d43-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="f0d43-111">討論</span><span class="sxs-lookup"><span data-stu-id="f0d43-111">Discussion</span></span>  

 <span data-ttu-id="f0d43-112">WCF 是可擴充的，可讓使用者視需要自訂通道。</span><span class="sxs-lookup"><span data-stu-id="f0d43-112">WCF is extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="f0d43-113">此範例會實作可建立安全通道的探索安全繫結項目。</span><span class="sxs-lookup"><span data-stu-id="f0d43-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="f0d43-114">安全通道會套用並驗證訊息簽章，而且會套用到目前堆疊的頂端。</span><span class="sxs-lookup"><span data-stu-id="f0d43-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="f0d43-115">安全繫結項目會建立安全通道處理站與通道接聽項。</span><span class="sxs-lookup"><span data-stu-id="f0d43-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="f0d43-116">安全通道處理站</span><span class="sxs-lookup"><span data-stu-id="f0d43-116">Secure Channel Factory</span></span>  

 <span data-ttu-id="f0d43-117">安全通道處理站會建立將精簡簽章加入至訊息標頭的輸出或雙工通道。</span><span class="sxs-lookup"><span data-stu-id="f0d43-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="f0d43-118">為了讓訊息保持越小越好，請使用精簡簽章格式。</span><span class="sxs-lookup"><span data-stu-id="f0d43-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="f0d43-119">精簡簽章的結構顯示在下列範例中。</span><span class="sxs-lookup"><span data-stu-id="f0d43-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >
  [<d:Sig Scheme="xs:anyURI"
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"
          Sig="xs:base64Binary"
          ... />]?  
  ...
</d:Security>  
```  
  
> [!NOTE]
> <span data-ttu-id="f0d43-120">`PrefixList` 會在 2008 探索版本通訊協定中加入。</span><span class="sxs-lookup"><span data-stu-id="f0d43-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="f0d43-121">為計算簽章，此範例決定展開的簽章項目。</span><span class="sxs-lookup"><span data-stu-id="f0d43-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="f0d43-122">XML 簽章 (`SignedInfo`) 會使用 WS-Discovery 規格所要求的 `ds` 命名空間前置詞建立。</span><span class="sxs-lookup"><span data-stu-id="f0d43-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="f0d43-123">探索與定址命名空間中的本文和所有標頭都會在簽章中參考，因此無法進行竄改。</span><span class="sxs-lookup"><span data-stu-id="f0d43-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="f0d43-124">每個參考的專案都會使用專屬的標準化 () 進行轉換 <http://www.w3.org/2001/10/xml-exc-c14n#> ，然後將 sha-1 摘要值計算 (<http://www.w3.org/2000/09/xmldsig#sha1>) 。</span><span class="sxs-lookup"><span data-stu-id="f0d43-124">Each referenced element is transformed using the Exclusive Canonicalization (<http://www.w3.org/2001/10/xml-exc-c14n#>), and then an SHA-1 digest value is computed (<http://www.w3.org/2000/09/xmldsig#sha1>).</span></span> <span data-ttu-id="f0d43-125">根據所有參考的元素及其摘要值，簽章值是使用 RSA 演算法 () 來計算 <http://www.w3.org/2000/09/xmldsig#rsa-sha1> 。</span><span class="sxs-lookup"><span data-stu-id="f0d43-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (<http://www.w3.org/2000/09/xmldsig#rsa-sha1>).</span></span>  
  
 <span data-ttu-id="f0d43-126">訊息會使用用戶端指定的憑證簽署。</span><span class="sxs-lookup"><span data-stu-id="f0d43-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="f0d43-127">建立繫結項目時，必須指定存放區位置、名稱和憑證主體名稱。</span><span class="sxs-lookup"><span data-stu-id="f0d43-127">The store location, name, and certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="f0d43-128">精簡簽章中的 `KeyId` 表示簽章權杖的金鑰識別碼，而且是簽署權杖的主體金鑰識別碼 (SKI)，或 (如果 SKI 不存在) 簽署權杖公開金鑰的 SHA-1 雜湊。</span><span class="sxs-lookup"><span data-stu-id="f0d43-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="f0d43-129">安全通道接聽項</span><span class="sxs-lookup"><span data-stu-id="f0d43-129">Secure Channel Listener</span></span>  

 <span data-ttu-id="f0d43-130">安全通道接聽項會建立可驗證收到之訊息中精簡簽章的輸入或雙工通道。</span><span class="sxs-lookup"><span data-stu-id="f0d43-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="f0d43-131">為驗證簽章，系統會使用訊息內附加之精簡簽章中指定的 `KeyId` 來選取指定之存放區中的憑證。</span><span class="sxs-lookup"><span data-stu-id="f0d43-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="f0d43-132">如果訊息沒有簽章或簽章檢查失敗，就會捨棄訊息。</span><span class="sxs-lookup"><span data-stu-id="f0d43-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="f0d43-133">為使用安全繫結，此範例會使用加入的探索安全繫結項目，定義可建立自訂 <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> 和 <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> 的處理站。</span><span class="sxs-lookup"><span data-stu-id="f0d43-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="f0d43-134">這些安全端點可用於探索公告接聽項和可搜尋的服務。</span><span class="sxs-lookup"><span data-stu-id="f0d43-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="f0d43-135">範例詳細資料</span><span class="sxs-lookup"><span data-stu-id="f0d43-135">Sample Details</span></span>  

 <span data-ttu-id="f0d43-136">此範例包含程式庫和 4 個主控台應用程式：</span><span class="sxs-lookup"><span data-stu-id="f0d43-136">The sample includes a library and 4 console applications:</span></span>
  
- <span data-ttu-id="f0d43-137">**DiscoverySecurityChannels**：公開安全系結的程式庫。</span><span class="sxs-lookup"><span data-stu-id="f0d43-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="f0d43-138">此程式庫會計算與驗證傳出/傳入訊息的精簡簽章。</span><span class="sxs-lookup"><span data-stu-id="f0d43-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
- <span data-ttu-id="f0d43-139">**服務**：公開 ICalculatorService 合約（自我裝載）的服務。</span><span class="sxs-lookup"><span data-stu-id="f0d43-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="f0d43-140">此服務會標示為可搜尋。</span><span class="sxs-lookup"><span data-stu-id="f0d43-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="f0d43-141">使用者會透過指定存放位置和名稱、憑證的主體名稱或其他唯一識別碼，以及用戶端憑證所在的存放位置 (用來檢查傳入訊息之簽章的憑證)，指定簽署訊息所使用之憑證的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="f0d43-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="f0d43-142">根據這些詳細資料，就會建立並使用具有額外安全性的 UdpDiscoveryEndpoint。</span><span class="sxs-lookup"><span data-stu-id="f0d43-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
- <span data-ttu-id="f0d43-143">**用戶端**：這個類別會嘗試探索 ICalculatorService，並呼叫服務上的方法。</span><span class="sxs-lookup"><span data-stu-id="f0d43-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="f0d43-144">同樣地，系統會建立並使用具有額外安全性的 <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> 來簽署與驗證訊息。</span><span class="sxs-lookup"><span data-stu-id="f0d43-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
- <span data-ttu-id="f0d43-145">**AnnouncementListener**：一種自我裝載的服務，它會接聽線上與離線公告，並使用安全公告端點。</span><span class="sxs-lookup"><span data-stu-id="f0d43-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="f0d43-146">如果多次執行 Setup.bat，憑證管理員會因為有重複的憑證而提示您選擇要加入的憑證。</span><span class="sxs-lookup"><span data-stu-id="f0d43-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="f0d43-147">在該情況下，應該中止 Setup.bat 並呼叫 Cleanup.bat，因為已經產生重複。</span><span class="sxs-lookup"><span data-stu-id="f0d43-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="f0d43-148">Cleanup.bat 也會提示您選擇要刪除的憑證。</span><span class="sxs-lookup"><span data-stu-id="f0d43-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="f0d43-149">選取清單中的憑證並繼續執行 Cleanup.bat，直到沒有剩下任何憑證為止。</span><span class="sxs-lookup"><span data-stu-id="f0d43-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="f0d43-150">若要使用這個範例</span><span class="sxs-lookup"><span data-stu-id="f0d43-150">To use this sample</span></span>  
  
1. <span data-ttu-id="f0d43-151">從 Visual Studio 的開發人員命令提示字元執行 Setup.bat 腳本。</span><span class="sxs-lookup"><span data-stu-id="f0d43-151">Execute the Setup.bat script from a Developer Command Prompt for Visual Studio.</span></span> <span data-ttu-id="f0d43-152">此範例會使用憑證來簽署與驗證訊息。</span><span class="sxs-lookup"><span data-stu-id="f0d43-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="f0d43-153">指令碼會使用 Makecert.exe 建立憑證，然後使用 Certmgr.exe 進行安裝。</span><span class="sxs-lookup"><span data-stu-id="f0d43-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="f0d43-154">此指令碼必須以系統管理員權限的身分來執行。</span><span class="sxs-lookup"><span data-stu-id="f0d43-154">The script must be run with administrator privileges.</span></span>  
  
2. <span data-ttu-id="f0d43-155">若要建立並執行範例，請在 Visual Studio 中開啟安全性 .sln 檔案，然後選擇 [ **全部重建**]。</span><span class="sxs-lookup"><span data-stu-id="f0d43-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="f0d43-156">更新方案屬性以啟動多個專案：針對 [DiscoverySecureChannels] 以外的所有專案選取 [ **啟動** ]。</span><span class="sxs-lookup"><span data-stu-id="f0d43-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="f0d43-157">按照一般方式執行方案。</span><span class="sxs-lookup"><span data-stu-id="f0d43-157">Run the solution normally.</span></span>  
  
3. <span data-ttu-id="f0d43-158">完成此範例之後，請執行 Cleanup.bat 指令碼，以移除針對此範例建立的憑證。</span><span class="sxs-lookup"><span data-stu-id="f0d43-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="f0d43-159">這些範例可能已安裝在您的電腦上。</span><span class="sxs-lookup"><span data-stu-id="f0d43-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="f0d43-160">請先檢查下列 (預設) 目錄，然後再繼續。</span><span class="sxs-lookup"><span data-stu-id="f0d43-160">Check for the following (default) directory before continuing.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples`  
>
> <span data-ttu-id="f0d43-161">如果此目錄不存在，請移至 [Windows Communication Foundation (wcf) 並 Windows Workflow Foundation (適用于) 4 的 WF .NET Framework 範例](https://www.microsoft.com/download/details.aspx?id=21459) 下載所有 WINDOWS COMMUNICATION FOUNDATION 的 wcf (和 [!INCLUDE[wf1](../../../../includes/wf1-md.md)] 範例。</span><span class="sxs-lookup"><span data-stu-id="f0d43-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="f0d43-162">此範例位於下列目錄。</span><span class="sxs-lookup"><span data-stu-id="f0d43-162">This sample is located in the following directory.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
