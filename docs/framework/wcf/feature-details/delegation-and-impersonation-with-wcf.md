---
title: 使用 WCF 的委派和模擬
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
ms.openlocfilehash: e491925fdbe8d44df8e0c64b563eb92569453e35
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/09/2020
ms.locfileid: "84599252"
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="cacf2-102">使用 WCF 的委派和模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-102">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="cacf2-103">「*模擬* 」(Impersonation) 是服務用來限制用戶端存取服務網域資源的常用技術。</span><span class="sxs-lookup"><span data-stu-id="cacf2-103">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="cacf2-104">服務網域資源可以是像是本機檔案 (模擬) 的電腦資源，或是在另一部電腦上的資源，例如檔案共用 (委派)。</span><span class="sxs-lookup"><span data-stu-id="cacf2-104">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="cacf2-105">如需範例應用程式，請參閱 [Impersonating the Client](../samples/impersonating-the-client.md)。</span><span class="sxs-lookup"><span data-stu-id="cacf2-105">For a sample application, see [Impersonating the Client](../samples/impersonating-the-client.md).</span></span> <span data-ttu-id="cacf2-106">如需如何使用模擬的範例，請參閱 [How to: Impersonate a Client on a Service](../how-to-impersonate-a-client-on-a-service.md)。</span><span class="sxs-lookup"><span data-stu-id="cacf2-106">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="cacf2-107">請留意，在模擬服務上的用戶端時，服務會以用戶端的認證執行，而該認證的權限可能高於伺服器處理序。</span><span class="sxs-lookup"><span data-stu-id="cacf2-107">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="cacf2-108">概觀</span><span class="sxs-lookup"><span data-stu-id="cacf2-108">Overview</span></span>  
 <span data-ttu-id="cacf2-109">一般而言，用戶端會呼叫服務，讓服務代表用戶端執行一些動作。</span><span class="sxs-lookup"><span data-stu-id="cacf2-109">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="cacf2-110">模擬可讓服務在執行動作時擔任用戶端。</span><span class="sxs-lookup"><span data-stu-id="cacf2-110">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="cacf2-111">委派可讓前端服務將用戶端的要求轉寄到後端服務，如此一來，後端服務也可以模擬用戶端。</span><span class="sxs-lookup"><span data-stu-id="cacf2-111">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="cacf2-112">模擬是最常用來檢查用戶端是否經過授權可執行特定動作的方法，而委派則是一種將模擬功能連同用戶端的身分識別一起流動至後端服務的方法。</span><span class="sxs-lookup"><span data-stu-id="cacf2-112">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="cacf2-113">委派是 Windows 網域功能，可以在執行 Kerberos 驗證時使用。</span><span class="sxs-lookup"><span data-stu-id="cacf2-113">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="cacf2-114">委派與身分識別流動不同，並且由於委派會傳輸此功能以模擬用戶端，而又不需擁有用戶端的密碼，因此它的作業權限比身分識別流動高得多。</span><span class="sxs-lookup"><span data-stu-id="cacf2-114">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="cacf2-115">模擬與委派兩者都需要用戶端具有 Windows 身分識別。</span><span class="sxs-lookup"><span data-stu-id="cacf2-115">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="cacf2-116">如果用戶端沒有 Windows 身分識別，則唯一的選擇就是將用戶端的身分識別流動至第二個服務。</span><span class="sxs-lookup"><span data-stu-id="cacf2-116">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="cacf2-117">模擬基本概念</span><span class="sxs-lookup"><span data-stu-id="cacf2-117">Impersonation Basics</span></span>  
 <span data-ttu-id="cacf2-118">Windows Communication Foundation （WCF）支援各種用戶端認證的模擬。</span><span class="sxs-lookup"><span data-stu-id="cacf2-118">Windows Communication Foundation (WCF) supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="cacf2-119">本主題會說明在服務方法實作期間模擬呼叫者的服務模型支援。</span><span class="sxs-lookup"><span data-stu-id="cacf2-119">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="cacf2-120">同時也討論了常見的部署案例，其中包括模擬和 SOAP 安全性，以及這些案例中的 WCF 選項。</span><span class="sxs-lookup"><span data-stu-id="cacf2-120">Also discussed are common deployment scenarios involving impersonation and SOAP security and WCF options in these scenarios.</span></span>  
  
 <span data-ttu-id="cacf2-121">本主題著重在使用 SOAP 安全性時，WCF 中的模擬和委派。</span><span class="sxs-lookup"><span data-stu-id="cacf2-121">This topic focuses on impersonation and delegation in WCF when using SOAP security.</span></span> <span data-ttu-id="cacf2-122">您也可以在使用傳輸安全性時搭配 WCF 使用模擬和委派，如[使用模擬與傳輸安全性](using-impersonation-with-transport-security.md)中所述。</span><span class="sxs-lookup"><span data-stu-id="cacf2-122">You can also use impersonation and delegation with WCF when using transport security, as described in [Using Impersonation with Transport Security](using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="cacf2-123">兩個方法</span><span class="sxs-lookup"><span data-stu-id="cacf2-123">Two Methods</span></span>  
 <span data-ttu-id="cacf2-124">WCF SOAP 安全性有兩個不同的方法來執行模擬。</span><span class="sxs-lookup"><span data-stu-id="cacf2-124">WCF SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="cacf2-125">所使用的方法會取決於繫結。</span><span class="sxs-lookup"><span data-stu-id="cacf2-125">The method used depends on the binding.</span></span> <span data-ttu-id="cacf2-126">一個是從安全性支援提供者介面 (SSPI) 或 Kerberos 驗證取得之 Windows 權杖進行的模擬，該權杖後來會快取到服務上。</span><span class="sxs-lookup"><span data-stu-id="cacf2-126">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="cacf2-127">第二個則是從 Kerberos 延伸取得之 Windows 權杖進行的模擬，統稱為「 *Service-for-User* 」(S4U)。</span><span class="sxs-lookup"><span data-stu-id="cacf2-127">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="cacf2-128">快取權杖模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-128">Cached Token Impersonation</span></span>  
 <span data-ttu-id="cacf2-129">您可以用下列項目來執行快取權杖模擬：</span><span class="sxs-lookup"><span data-stu-id="cacf2-129">You can perform cached-token impersonation with the following:</span></span>  
  
- <span data-ttu-id="cacf2-130">具有 Windows 用戶端認證的<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>及 <xref:System.ServiceModel.NetTcpBinding> 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
- <span data-ttu-id="cacf2-131"><xref:System.ServiceModel.BasicHttpBinding> ，其 <xref:System.ServiceModel.BasicHttpSecurityMode> 設定為 <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> 認證或是其他任何標準繫結，繫結是指用戶端會在其中提供可由服務用來對應至有效 Windows 帳戶的使用者名稱認證。</span><span class="sxs-lookup"><span data-stu-id="cacf2-131"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="cacf2-132">任何使用 Windows 用戶端認證，而且 <xref:System.ServiceModel.Channels.CustomBinding> 已設定為 `requireCancellation` 的 `true`</span><span class="sxs-lookup"><span data-stu-id="cacf2-132">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="cacf2-133">（屬性可在下列類別上使用： <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters> 、 <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters> 和 <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters> 。）如果在系結上使用安全對話，它也必須將 `requireCancellation` 屬性設定為 `true` 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-133">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
- <span data-ttu-id="cacf2-134">用戶端在其中提供使用者名稱認證的任何 <xref:System.ServiceModel.Channels.CustomBinding> 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-134">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="cacf2-135">如果此繫結上有使用安全對話，這時也必須將 `requireCancellation` 屬性設定為 `true`。</span><span class="sxs-lookup"><span data-stu-id="cacf2-135">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="cacf2-136">S4U 架構模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-136">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="cacf2-137">您可以用下列項目來執行 S4U 架構模擬：</span><span class="sxs-lookup"><span data-stu-id="cacf2-137">You can perform S4U-based impersonation with the following:</span></span>  
  
- <span data-ttu-id="cacf2-138"><xref:System.ServiceModel.WSHttpBinding>、 <xref:System.ServiceModel.WSDualHttpBinding>及 <xref:System.ServiceModel.NetTcpBinding> ，包含可讓服務用來對應至有效 Windows 帳戶的憑證用戶端認證。</span><span class="sxs-lookup"><span data-stu-id="cacf2-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="cacf2-139">任何使用 Windows 用戶端認證，而且 <xref:System.ServiceModel.Channels.CustomBinding> 屬性已設定為 `requireCancellation` 的 `false`。</span><span class="sxs-lookup"><span data-stu-id="cacf2-139">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
- <span data-ttu-id="cacf2-140">任何使用使用者名稱或 Windows 用戶端認證以及安全對話，而且 <xref:System.ServiceModel.Channels.CustomBinding> 屬性已設定為 `requireCancellation` 的 `false`。</span><span class="sxs-lookup"><span data-stu-id="cacf2-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="cacf2-141">服務可以模擬用戶端的程度，取決於服務在嘗試模擬時所擁有的權限、所使用的模擬類型，以及用戶端允許的可能模擬程度。</span><span class="sxs-lookup"><span data-stu-id="cacf2-141">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cacf2-142">當用戶端和服務在相同電腦上執行，而且用戶端正以系統帳戶執行時 (例如， `Local System` 或 `Network Service`)，用戶端就無法在安全工作階段是以可設定狀態之安全性內容權杖所建立的情況下進行模擬。</span><span class="sxs-lookup"><span data-stu-id="cacf2-142">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="cacf2-143">Windows Form 或主控台應用程式 (Console Application) 一般都會以目前登入的帳戶執行，因此依預設可以模擬該帳戶。</span><span class="sxs-lookup"><span data-stu-id="cacf2-143">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="cacf2-144">不過，當用戶端是 ASP.NET 網頁，而且該頁面裝載于 IIS 6.0 或 IIS 7.0 中時，用戶端預設會在帳戶下執行 `Network Service` 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-144">However, when the client is an ASP.NET page and that page is hosted in IIS 6.0 or IIS 7.0, then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="cacf2-145">所有支援安全工作階段的系統提供繫結，根據預設，都會使用沒有狀態 (Stateless) 的安全性內容權杖 (SCT)。</span><span class="sxs-lookup"><span data-stu-id="cacf2-145">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="cacf2-146">不過，如果用戶端是 ASP.NET 網頁，而且使用具狀態 Sct 的安全會話，則無法模擬用戶端。</span><span class="sxs-lookup"><span data-stu-id="cacf2-146">However, if the client is an ASP.NET page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="cacf2-147">如需在安全會話中使用具狀態 Sct 的詳細資訊，請參閱[如何：為安全會話建立安全性內容權杖](how-to-create-a-security-context-token-for-a-secure-session.md)。</span><span class="sxs-lookup"><span data-stu-id="cacf2-147">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="cacf2-148">使用服務方法的模擬：宣告式模型</span><span class="sxs-lookup"><span data-stu-id="cacf2-148">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="cacf2-149">大多數模擬狀況都牽涉到在呼叫端內容中執行服務方法。</span><span class="sxs-lookup"><span data-stu-id="cacf2-149">Most impersonation scenarios involve executing the service method in the caller context.</span></span> <span data-ttu-id="cacf2-150">WCF 提供模擬功能，可讓使用者在屬性中指定模擬需求，藉此輕鬆執行此動作 <xref:System.ServiceModel.OperationBehaviorAttribute> 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-150">WCF provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="cacf2-151">例如，在下列程式碼中，WCF 基礎結構會在執行方法之前模擬呼叫者 `Hello` 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-151">For example, in the following code, the WCF infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="cacf2-152">資源的存取控制清單 (ACL) 必須允許呼叫者存取權限，任何存取 `Hello` 方法內部原生資源的嘗試才能繼續。</span><span class="sxs-lookup"><span data-stu-id="cacf2-152">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="cacf2-153">若要啟用模擬，請將 <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> 屬性設定為其中一個 <xref:System.ServiceModel.ImpersonationOption> 例舉值，也就是 <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> 或 <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>，如下列範例所示。</span><span class="sxs-lookup"><span data-stu-id="cacf2-153">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cacf2-154">當服務的認證權限高於遠端用戶端時，而 <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> 屬性已設定為 <xref:System.ServiceModel.ImpersonationOption.Allowed>，便會使用服務的認證。</span><span class="sxs-lookup"><span data-stu-id="cacf2-154">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="cacf2-155">也就是說，如果低權限的使用者提供其認證，較高權限的服務會以服務的認證來執行方法，而且可以使用低權限使用者透過其他方法也無法使用的資源。</span><span class="sxs-lookup"><span data-stu-id="cacf2-155">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="cacf2-156">只有在呼叫端以可對應至 Windows 使用者帳戶的認證進行驗證時，WCF 基礎結構才能模擬呼叫端。</span><span class="sxs-lookup"><span data-stu-id="cacf2-156">The WCF infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="cacf2-157">如果服務是設定成使用無法對應至 Windows 帳戶的認證來進行驗證，該服務方法就不會執行。</span><span class="sxs-lookup"><span data-stu-id="cacf2-157">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cacf2-158">在 Windows XP 上，如果建立可設定狀態的 SCT，模擬將會失敗，因而產生 <xref:System.InvalidOperationException> 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-158">On Windows XP, impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="cacf2-159">如需詳細資訊，請參閱[不支援的案例](unsupported-scenarios.md)。</span><span class="sxs-lookup"><span data-stu-id="cacf2-159">For more information, see [Unsupported Scenarios](unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="cacf2-160">使用服務方法的模擬：命令式模型</span><span class="sxs-lookup"><span data-stu-id="cacf2-160">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="cacf2-161">有時候呼叫者並不需要模擬整個服務，而只需要模擬服務的部份即可運作。</span><span class="sxs-lookup"><span data-stu-id="cacf2-161">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="cacf2-162">在此情況下，請從服務方法內取得呼叫者的 Windows 身分識別，而且以命令方式執行模擬。</span><span class="sxs-lookup"><span data-stu-id="cacf2-162">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="cacf2-163">使用 <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> 的 <xref:System.ServiceModel.ServiceSecurityContext> 屬性傳回 <xref:System.Security.Principal.WindowsIdentity> 類別的執行個體，並先呼叫 <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> 方法，再使用該執行個體，即可完成這項執行。</span><span class="sxs-lookup"><span data-stu-id="cacf2-163">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cacf2-164">請務必使用 Visual Basic `Using` 語句或 c # `using` 語句，自動還原模擬動作。</span><span class="sxs-lookup"><span data-stu-id="cacf2-164">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="cacf2-165">如果您不使用語句，或使用 Visual Basic 或 c # 以外的程式設計語言，請務必還原模擬層級。</span><span class="sxs-lookup"><span data-stu-id="cacf2-165">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="cacf2-166">若是沒有做到這點，可能就會促使阻絕服務攻擊和提高權限攻擊的發生。</span><span class="sxs-lookup"><span data-stu-id="cacf2-166">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="cacf2-167">所有服務方法的模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-167">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="cacf2-168">在某些情況下，您必須在呼叫者內容中執行服務的所有方法。</span><span class="sxs-lookup"><span data-stu-id="cacf2-168">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="cacf2-169">這時並非明確地針對各個方法啟用這項功能，而是使用 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>。</span><span class="sxs-lookup"><span data-stu-id="cacf2-169">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="cacf2-170">如下列程式碼所示，將 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> 屬性設定為 `true`。</span><span class="sxs-lookup"><span data-stu-id="cacf2-170">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="cacf2-171"><xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> 是從 <xref:System.ServiceModel.ServiceHost> 類別的行為集合中加以擷取。</span><span class="sxs-lookup"><span data-stu-id="cacf2-171">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="cacf2-172">同時請注意，套用至每個方法之 `Impersonation` 的 <xref:System.ServiceModel.OperationBehaviorAttribute> 屬性，也必須設定為 <xref:System.ServiceModel.ImpersonationOption.Allowed> 或 <xref:System.ServiceModel.ImpersonationOption.Required>。</span><span class="sxs-lookup"><span data-stu-id="cacf2-172">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="cacf2-173">下表描述和所有可能組合的 WCF 行為 `ImpersonationOption` `ImpersonateCallerForAllServiceOperations` 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-173">The following table describes WCF behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="cacf2-174">行為</span><span class="sxs-lookup"><span data-stu-id="cacf2-174">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="cacf2-175">必要</span><span class="sxs-lookup"><span data-stu-id="cacf2-175">Required</span></span>|<span data-ttu-id="cacf2-176">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-176">n/a</span></span>|<span data-ttu-id="cacf2-177">WCF 模擬呼叫者</span><span class="sxs-lookup"><span data-stu-id="cacf2-177">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="cacf2-178">允許</span><span class="sxs-lookup"><span data-stu-id="cacf2-178">Allowed</span></span>|<span data-ttu-id="cacf2-179">false</span><span class="sxs-lookup"><span data-stu-id="cacf2-179">false</span></span>|<span data-ttu-id="cacf2-180">WCF 不會模擬呼叫端</span><span class="sxs-lookup"><span data-stu-id="cacf2-180">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="cacf2-181">允許</span><span class="sxs-lookup"><span data-stu-id="cacf2-181">Allowed</span></span>|<span data-ttu-id="cacf2-182">true</span><span class="sxs-lookup"><span data-stu-id="cacf2-182">true</span></span>|<span data-ttu-id="cacf2-183">WCF 模擬呼叫者</span><span class="sxs-lookup"><span data-stu-id="cacf2-183">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="cacf2-184">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="cacf2-184">NotAllowed</span></span>|<span data-ttu-id="cacf2-185">false</span><span class="sxs-lookup"><span data-stu-id="cacf2-185">false</span></span>|<span data-ttu-id="cacf2-186">WCF 不會模擬呼叫端</span><span class="sxs-lookup"><span data-stu-id="cacf2-186">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="cacf2-187">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="cacf2-187">NotAllowed</span></span>|<span data-ttu-id="cacf2-188">true</span><span class="sxs-lookup"><span data-stu-id="cacf2-188">true</span></span>|<span data-ttu-id="cacf2-189">不允許。</span><span class="sxs-lookup"><span data-stu-id="cacf2-189">Disallowed.</span></span> <span data-ttu-id="cacf2-190">(擲回 <xref:System.InvalidOperationException> )。</span><span class="sxs-lookup"><span data-stu-id="cacf2-190">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="cacf2-191">從 Windows 認證和快取權杖模擬取得的模擬等級</span><span class="sxs-lookup"><span data-stu-id="cacf2-191">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="cacf2-192">在某些案例中，若是使用 Windows 用戶端認證，用戶端只能部分控制服務執行的模擬等級。</span><span class="sxs-lookup"><span data-stu-id="cacf2-192">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="cacf2-193">當用戶端指定 Anonymous 模擬等級時會形成一種案例。</span><span class="sxs-lookup"><span data-stu-id="cacf2-193">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="cacf2-194">而以快取權杖執行模擬時會發生另一種案例。</span><span class="sxs-lookup"><span data-stu-id="cacf2-194">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="cacf2-195">設定 <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> 類別的 <xref:System.ServiceModel.Security.WindowsClientCredential> 屬性 (可以當做泛型 <xref:System.ServiceModel.ChannelFactory%601> 類別的屬性進行存取)，即可做到這點。</span><span class="sxs-lookup"><span data-stu-id="cacf2-195">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cacf2-196">指定 Anonymous 模擬等級時會導致用戶端以匿名方式登入服務。</span><span class="sxs-lookup"><span data-stu-id="cacf2-196">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="cacf2-197">因此，無論是否有執行模擬，服務一定會允許匿名登入。</span><span class="sxs-lookup"><span data-stu-id="cacf2-197">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="cacf2-198">用戶端可以將模擬等級指定為 <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>、 <xref:System.Security.Principal.TokenImpersonationLevel.Identification>、 <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>或 <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>。</span><span class="sxs-lookup"><span data-stu-id="cacf2-198">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="cacf2-199">這時只會產生指定等級的權杖，如下列程式碼所示。</span><span class="sxs-lookup"><span data-stu-id="cacf2-199">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="cacf2-200">下表會指定在從快取權杖模擬時，服務所取得的模擬等級。</span><span class="sxs-lookup"><span data-stu-id="cacf2-200">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="cacf2-201">`AllowedImpersonationLevel` 值</span><span class="sxs-lookup"><span data-stu-id="cacf2-201">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="cacf2-202">服務具有 `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="cacf2-202">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="cacf2-203">服務和用戶端能夠委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-203">Service and client are capable of delegation</span></span>|<span data-ttu-id="cacf2-204">快取權杖 `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="cacf2-204">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="cacf2-205">匿名</span><span class="sxs-lookup"><span data-stu-id="cacf2-205">Anonymous</span></span>|<span data-ttu-id="cacf2-206">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-206">Yes</span></span>|<span data-ttu-id="cacf2-207">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-207">n/a</span></span>|<span data-ttu-id="cacf2-208">模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-208">Impersonation</span></span>|  
|<span data-ttu-id="cacf2-209">匿名</span><span class="sxs-lookup"><span data-stu-id="cacf2-209">Anonymous</span></span>|<span data-ttu-id="cacf2-210">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-210">No</span></span>|<span data-ttu-id="cacf2-211">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-211">n/a</span></span>|<span data-ttu-id="cacf2-212">識別</span><span class="sxs-lookup"><span data-stu-id="cacf2-212">Identification</span></span>|  
|<span data-ttu-id="cacf2-213">識別</span><span class="sxs-lookup"><span data-stu-id="cacf2-213">Identification</span></span>|<span data-ttu-id="cacf2-214">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-214">n/a</span></span>|<span data-ttu-id="cacf2-215">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-215">n/a</span></span>|<span data-ttu-id="cacf2-216">識別</span><span class="sxs-lookup"><span data-stu-id="cacf2-216">Identification</span></span>|  
|<span data-ttu-id="cacf2-217">模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-217">Impersonation</span></span>|<span data-ttu-id="cacf2-218">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-218">Yes</span></span>|<span data-ttu-id="cacf2-219">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-219">n/a</span></span>|<span data-ttu-id="cacf2-220">模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-220">Impersonation</span></span>|  
|<span data-ttu-id="cacf2-221">模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-221">Impersonation</span></span>|<span data-ttu-id="cacf2-222">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-222">No</span></span>|<span data-ttu-id="cacf2-223">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-223">n/a</span></span>|<span data-ttu-id="cacf2-224">識別</span><span class="sxs-lookup"><span data-stu-id="cacf2-224">Identification</span></span>|  
|<span data-ttu-id="cacf2-225">委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-225">Delegation</span></span>|<span data-ttu-id="cacf2-226">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-226">Yes</span></span>|<span data-ttu-id="cacf2-227">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-227">Yes</span></span>|<span data-ttu-id="cacf2-228">委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-228">Delegation</span></span>|  
|<span data-ttu-id="cacf2-229">委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-229">Delegation</span></span>|<span data-ttu-id="cacf2-230">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-230">Yes</span></span>|<span data-ttu-id="cacf2-231">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-231">No</span></span>|<span data-ttu-id="cacf2-232">模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-232">Impersonation</span></span>|  
|<span data-ttu-id="cacf2-233">委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-233">Delegation</span></span>|<span data-ttu-id="cacf2-234">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-234">No</span></span>|<span data-ttu-id="cacf2-235">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-235">n/a</span></span>|<span data-ttu-id="cacf2-236">識別</span><span class="sxs-lookup"><span data-stu-id="cacf2-236">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="cacf2-237">從使用者名稱認證和快取權杖模擬取得的模擬等級</span><span class="sxs-lookup"><span data-stu-id="cacf2-237">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="cacf2-238">藉由傳遞服務的使用者名稱和密碼，用戶端可讓 WCF 以該使用者的身分登入，這相當於將 `AllowedImpersonationLevel` 屬性設定為 <xref:System.Security.Principal.TokenImpersonationLevel.Delegation> 。</span><span class="sxs-lookup"><span data-stu-id="cacf2-238">By passing the service its user name and password, a client enables WCF to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="cacf2-239">（ `AllowedImpersonationLevel` 可在 <xref:System.ServiceModel.Security.WindowsClientCredential> 和類別上使用 <xref:System.ServiceModel.Security.HttpDigestClientCredential> ）。下表提供當服務收到使用者名稱認證時所取得的模擬等級。</span><span class="sxs-lookup"><span data-stu-id="cacf2-239">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="cacf2-240">服務具有 `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="cacf2-240">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="cacf2-241">服務和用戶端能夠委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-241">Service and client are capable of delegation</span></span>|<span data-ttu-id="cacf2-242">快取權杖 `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="cacf2-242">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="cacf2-243">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-243">n/a</span></span>|<span data-ttu-id="cacf2-244">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-244">Yes</span></span>|<span data-ttu-id="cacf2-245">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-245">Yes</span></span>|<span data-ttu-id="cacf2-246">委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-246">Delegation</span></span>|  
|<span data-ttu-id="cacf2-247">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-247">n/a</span></span>|<span data-ttu-id="cacf2-248">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-248">Yes</span></span>|<span data-ttu-id="cacf2-249">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-249">No</span></span>|<span data-ttu-id="cacf2-250">模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-250">Impersonation</span></span>|  
|<span data-ttu-id="cacf2-251">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-251">n/a</span></span>|<span data-ttu-id="cacf2-252">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-252">No</span></span>|<span data-ttu-id="cacf2-253">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-253">n/a</span></span>|<span data-ttu-id="cacf2-254">識別</span><span class="sxs-lookup"><span data-stu-id="cacf2-254">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="cacf2-255">從 S4U 架構模擬取得的模擬等級</span><span class="sxs-lookup"><span data-stu-id="cacf2-255">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="cacf2-256">服務具有 `SeTcbPrivilege`</span><span class="sxs-lookup"><span data-stu-id="cacf2-256">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="cacf2-257">服務具有 `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="cacf2-257">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="cacf2-258">服務和用戶端能夠委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-258">Service and client are capable of delegation</span></span>|<span data-ttu-id="cacf2-259">快取權杖 `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="cacf2-259">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="cacf2-260">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-260">Yes</span></span>|<span data-ttu-id="cacf2-261">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-261">Yes</span></span>|<span data-ttu-id="cacf2-262">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-262">n/a</span></span>|<span data-ttu-id="cacf2-263">模擬</span><span class="sxs-lookup"><span data-stu-id="cacf2-263">Impersonation</span></span>|  
|<span data-ttu-id="cacf2-264">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-264">Yes</span></span>|<span data-ttu-id="cacf2-265">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-265">No</span></span>|<span data-ttu-id="cacf2-266">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-266">n/a</span></span>|<span data-ttu-id="cacf2-267">識別</span><span class="sxs-lookup"><span data-stu-id="cacf2-267">Identification</span></span>|  
|<span data-ttu-id="cacf2-268">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-268">No</span></span>|<span data-ttu-id="cacf2-269">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-269">n/a</span></span>|<span data-ttu-id="cacf2-270">n/a</span><span class="sxs-lookup"><span data-stu-id="cacf2-270">n/a</span></span>|<span data-ttu-id="cacf2-271">識別</span><span class="sxs-lookup"><span data-stu-id="cacf2-271">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="cacf2-272">將用戶端憑證對應至 Windows 帳戶</span><span class="sxs-lookup"><span data-stu-id="cacf2-272">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="cacf2-273">用戶端本身可以利用憑證讓自己通過對服務的驗證，並且讓服務將用戶端透過 Active Directory 對應到現有的帳戶。</span><span class="sxs-lookup"><span data-stu-id="cacf2-273">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="cacf2-274">下列 XML 示範如何對服務進行設定以對應憑證。</span><span class="sxs-lookup"><span data-stu-id="cacf2-274">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="cacf2-275">下列程式碼會示範如何設定服務。</span><span class="sxs-lookup"><span data-stu-id="cacf2-275">The following code shows how to configure the service.</span></span>  
  
```csharp
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="cacf2-276">委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-276">Delegation</span></span>  
 <span data-ttu-id="cacf2-277">若要委派給後端服務，服務必須使用用戶端的 Windows 身分識別，對後端服務執行多支線 (Multi-leg) Kerberos 驗證 (無 NTLM 後援的 SSPI) 或 Kerberos 直接驗證。</span><span class="sxs-lookup"><span data-stu-id="cacf2-277">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="cacf2-278">若要委派給後端服務，請建立 <xref:System.ServiceModel.ChannelFactory%601> 和通道，然後在模擬用戶端時透過通道通訊。</span><span class="sxs-lookup"><span data-stu-id="cacf2-278">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="cacf2-279">透過這種委派，後端服務離前端服務的距離取決於前端服務達成的模擬等級。</span><span class="sxs-lookup"><span data-stu-id="cacf2-279">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="cacf2-280">當模擬等級為 <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>時，前端和後端服務必須在相同電腦上執行。</span><span class="sxs-lookup"><span data-stu-id="cacf2-280">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="cacf2-281">當模擬等級為 <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>時，前端和後端服務可以在不同電腦或相同電腦上執行。</span><span class="sxs-lookup"><span data-stu-id="cacf2-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="cacf2-282">啟用委派等級模擬需要 Windows 網域原則已設定，才能允許委派。</span><span class="sxs-lookup"><span data-stu-id="cacf2-282">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="cacf2-283">如需設定 Active Directory 以支援委派的詳細資訊，請參閱 [啟用委派驗證](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc780217(v=ws.10))(英文)。</span><span class="sxs-lookup"><span data-stu-id="cacf2-283">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc780217(v=ws.10)).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cacf2-284">當用戶端使用對應至後端服務 Windows 帳戶的使用者名稱和密碼驗證前端服務時，前端服務可以重複使用用戶端的使用者名稱和密碼來驗證後端服務。</span><span class="sxs-lookup"><span data-stu-id="cacf2-284">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="cacf2-285">這是身分識別流動特別強大的形式，因為將使用者名稱和密碼傳遞至後端服務可讓後端服務執行模擬，但它不會構成委派，因為並未使用 Kerberos。</span><span class="sxs-lookup"><span data-stu-id="cacf2-285">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="cacf2-286">委派上的 Active Directory 控制項不會套用至使用者名稱和密碼驗證。</span><span class="sxs-lookup"><span data-stu-id="cacf2-286">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="cacf2-287">模擬等級功能的委派能力</span><span class="sxs-lookup"><span data-stu-id="cacf2-287">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="cacf2-288">模擬等級</span><span class="sxs-lookup"><span data-stu-id="cacf2-288">Impersonation level</span></span>|<span data-ttu-id="cacf2-289">服務可以執行跨處理序委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-289">Service can perform cross-process delegation</span></span>|<span data-ttu-id="cacf2-290">服務可以執行跨電腦委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-290">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="cacf2-291">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-291">No</span></span>|<span data-ttu-id="cacf2-292">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-292">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="cacf2-293">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-293">Yes</span></span>|<span data-ttu-id="cacf2-294">否</span><span class="sxs-lookup"><span data-stu-id="cacf2-294">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="cacf2-295">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-295">Yes</span></span>|<span data-ttu-id="cacf2-296">是</span><span class="sxs-lookup"><span data-stu-id="cacf2-296">Yes</span></span>|  
  
 <span data-ttu-id="cacf2-297">下列程式碼範例示範如何使用委派。</span><span class="sxs-lookup"><span data-stu-id="cacf2-297">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="cacf2-298">如何設定應用程式使用限制委派</span><span class="sxs-lookup"><span data-stu-id="cacf2-298">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="cacf2-299">在您可以使用限制委派之前，傳送者、接收者和網域控制站必須先設定為可使用限制委派。</span><span class="sxs-lookup"><span data-stu-id="cacf2-299">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="cacf2-300">下列程序列出啟用限制委派的步驟。</span><span class="sxs-lookup"><span data-stu-id="cacf2-300">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="cacf2-301">如需委派和限制委派之間差異的詳細資訊，請參閱 [Windows Server 2003 Kerberos 延伸](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc738207(v=ws.10)) (英文) 部分中有關限制的討論。</span><span class="sxs-lookup"><span data-stu-id="cacf2-301">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc738207(v=ws.10)) that discusses constrained discussion.</span></span>  
  
1. <span data-ttu-id="cacf2-302">在網域控制站上，清除用戶端應用程式執行所在之帳戶的 [ **這是機密帳戶，無法委派** ] 核取方塊。</span><span class="sxs-lookup"><span data-stu-id="cacf2-302">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2. <span data-ttu-id="cacf2-303">在網域控制站上，選取用戶端應用程式執行所在之帳戶的 [ **帳戶受信任可以委派** ] 核取方塊。</span><span class="sxs-lookup"><span data-stu-id="cacf2-303">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3. <span data-ttu-id="cacf2-304">在網域控制站上，按一下 [ **信任電腦以便進行委派** ] 選項，將中介層電腦設定為受信任，可進行委派。</span><span class="sxs-lookup"><span data-stu-id="cacf2-304">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4. <span data-ttu-id="cacf2-305">在網域控制站上，按一下 [ **信任這台電腦所委派的特定服務** ] 選項，將中介層電腦設定為使用限制委派。</span><span class="sxs-lookup"><span data-stu-id="cacf2-305">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="cacf2-306">如需設定限制委派的詳細指示，請參閱[Kerberos 通訊協定轉換和限制委派](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc739587(v=ws.10))。</span><span class="sxs-lookup"><span data-stu-id="cacf2-306">For more detailed instructions about configuring constrained delegation, see [Kerberos Protocol Transition and Constrained Delegation](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc739587(v=ws.10)).</span></span>
  
## <a name="see-also"></a><span data-ttu-id="cacf2-307">請參閱</span><span class="sxs-lookup"><span data-stu-id="cacf2-307">See also</span></span>

- <xref:System.ServiceModel.OperationBehaviorAttribute>
- <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>
- <xref:System.ServiceModel.ImpersonationOption>
- <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>
- <xref:System.ServiceModel.ServiceSecurityContext>
- <xref:System.Security.Principal.WindowsIdentity>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>
- <xref:System.ServiceModel.ServiceHost>
- <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ChannelFactory%601>
- <xref:System.Security.Principal.TokenImpersonationLevel.Identification>
- [<span data-ttu-id="cacf2-308">使用模擬搭配傳輸安全性</span><span class="sxs-lookup"><span data-stu-id="cacf2-308">Using Impersonation with Transport Security</span></span>](using-impersonation-with-transport-security.md)
- [<span data-ttu-id="cacf2-309">模擬用戶端</span><span class="sxs-lookup"><span data-stu-id="cacf2-309">Impersonating the Client</span></span>](../samples/impersonating-the-client.md)
- [<span data-ttu-id="cacf2-310">如何：在服務上模擬用戶端</span><span class="sxs-lookup"><span data-stu-id="cacf2-310">How to: Impersonate a Client on a Service</span></span>](../how-to-impersonate-a-client-on-a-service.md)
- [<span data-ttu-id="cacf2-311">ServiceModel 中繼資料公用程式工具 (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="cacf2-311">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../servicemodel-metadata-utility-tool-svcutil-exe.md)
