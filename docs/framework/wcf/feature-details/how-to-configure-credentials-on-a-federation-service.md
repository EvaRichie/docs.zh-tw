---
title: HOW TO：設定聯合服務的認證
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, federation
- federation
ms.assetid: 149ab165-0ef3-490a-83a9-4322a07bd98a
ms.openlocfilehash: 05f35bbb7dbb34cd4067c407578038cbb4eff70f
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/09/2020
ms.locfileid: "84599137"
---
# <a name="how-to-configure-credentials-on-a-federation-service"></a><span data-ttu-id="bae01-102">HOW TO：設定聯合服務的認證</span><span class="sxs-lookup"><span data-stu-id="bae01-102">How to: Configure Credentials on a Federation Service</span></span>
<span data-ttu-id="bae01-103">在 Windows Communication Foundation （WCF）中，建立聯合服務包含下列主要程式：</span><span class="sxs-lookup"><span data-stu-id="bae01-103">In Windows Communication Foundation (WCF), creating a federated service consists of the following main procedures:</span></span>  
  
1. <span data-ttu-id="bae01-104">設定 <xref:System.ServiceModel.WSFederationHttpBinding> 或類似的自訂繫結。</span><span class="sxs-lookup"><span data-stu-id="bae01-104">Configuring a <xref:System.ServiceModel.WSFederationHttpBinding> or similar custom binding.</span></span> <span data-ttu-id="bae01-105">如需建立適當系結的詳細資訊，請參閱 how [to： Create a WSFederationHttpBinding](how-to-create-a-wsfederationhttpbinding.md)。</span><span class="sxs-lookup"><span data-stu-id="bae01-105">For more information about creating an appropriate binding, see [How to: Create a WSFederationHttpBinding](how-to-create-a-wsfederationhttpbinding.md).</span></span>  
  
2. <span data-ttu-id="bae01-106">設定 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential>，此認證可控制如何驗證提供給服務的已發行權杖。</span><span class="sxs-lookup"><span data-stu-id="bae01-106">Configuring the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> that controls how issued tokens presented to the service are authenticated.</span></span>  
  
 <span data-ttu-id="bae01-107">本主題會提供第二個步驟的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="bae01-107">This topic provides details about the second step.</span></span> <span data-ttu-id="bae01-108">如需聯合服務運作方式的詳細資訊，請參閱[同盟](federation.md)。</span><span class="sxs-lookup"><span data-stu-id="bae01-108">For more information about how a federated service works, see [Federation](federation.md).</span></span>  
  
### <a name="to-set-the-properties-of-issuedtokenservicecredential-in-code"></a><span data-ttu-id="bae01-109">使用程式碼來設定 IssuedTokenServiceCredential 的屬性</span><span class="sxs-lookup"><span data-stu-id="bae01-109">To set the properties of IssuedTokenServiceCredential in code</span></span>  
  
1. <span data-ttu-id="bae01-110">使用 <xref:System.ServiceModel.Description.ServiceCredentials.IssuedTokenAuthentication%2A> 類別的 <xref:System.ServiceModel.Description.ServiceCredentials> 屬性，傳回 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> 執行個體 (Instance) 的參照。</span><span class="sxs-lookup"><span data-stu-id="bae01-110">Use the <xref:System.ServiceModel.Description.ServiceCredentials.IssuedTokenAuthentication%2A> property of the <xref:System.ServiceModel.Description.ServiceCredentials> class to return a reference to an <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> instance.</span></span> <span data-ttu-id="bae01-111">此屬性可從 <xref:System.ServiceModel.ServiceHostBase.Credentials%2A> 類別的 <xref:System.ServiceModel.ServiceHostBase> 屬性存取。</span><span class="sxs-lookup"><span data-stu-id="bae01-111">The property is accessed from the <xref:System.ServiceModel.ServiceHostBase.Credentials%2A> property of the <xref:System.ServiceModel.ServiceHostBase> class.</span></span>  
  
2. <span data-ttu-id="bae01-112"><xref:System.ServiceModel.Security.IssuedTokenServiceCredential.AllowUntrustedRsaIssuers%2A> `true` 如果要驗證自行發行的權杖（例如 CardSpace 卡），請將屬性設定為。</span><span class="sxs-lookup"><span data-stu-id="bae01-112">Set the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.AllowUntrustedRsaIssuers%2A> property to `true` if self-issued tokens such as CardSpace cards are to be authenticated.</span></span> <span data-ttu-id="bae01-113">預設值為 `false`。</span><span class="sxs-lookup"><span data-stu-id="bae01-113">The default is `false`.</span></span>  
  
3. <span data-ttu-id="bae01-114">將 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> 屬性所傳回的集合填入 (Populate) <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 類別的執行個體。</span><span class="sxs-lookup"><span data-stu-id="bae01-114">Populate the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> property with instances of the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class.</span></span> <span data-ttu-id="bae01-115">每個執行個體都代表服務將會從該處驗證權杖的簽發者。</span><span class="sxs-lookup"><span data-stu-id="bae01-115">Each instance represents an issuer from which the service will authenticate tokens.</span></span>  
  
    > [!NOTE]
    > <span data-ttu-id="bae01-116">不同於 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> 屬性所傳回的用戶端集合，已知憑證集合並不是有索引鍵的集合。</span><span class="sxs-lookup"><span data-stu-id="bae01-116">Unlike the client-side collection returned by the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property, the known certificates collection is not a keyed collection.</span></span> <span data-ttu-id="bae01-117">無論傳送包含已發行權杖之訊息的用戶端位址為何，服務都會接受已指定憑證所發行的權杖 (仍有其他條件限制，將於本主題稍後內容中說明)。</span><span class="sxs-lookup"><span data-stu-id="bae01-117">The service accepts the tokens that the specified certificates issue regardless of the address of the client that sent the message containing the issued token (subject to the further constraints, which are described later in this topic).</span></span>  
  
4. <span data-ttu-id="bae01-118">將 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> 屬性設定為其中一個 <xref:System.ServiceModel.Security.X509CertificateValidationMode> 列舉值。</span><span class="sxs-lookup"><span data-stu-id="bae01-118">Set the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> property to one of the <xref:System.ServiceModel.Security.X509CertificateValidationMode> enumeration values.</span></span> <span data-ttu-id="bae01-119">只有透過程式碼才能做到這點。</span><span class="sxs-lookup"><span data-stu-id="bae01-119">This can be done only in code.</span></span> <span data-ttu-id="bae01-120">預設值為 <xref:System.IdentityModel.Selectors.X509CertificateValidator.ChainTrust%2A>。</span><span class="sxs-lookup"><span data-stu-id="bae01-120">The default is <xref:System.IdentityModel.Selectors.X509CertificateValidator.ChainTrust%2A>.</span></span>  
  
5. <span data-ttu-id="bae01-121">如果 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> 屬性是設定為 <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom>，則會將自訂 <xref:System.IdentityModel.Selectors.X509CertificateValidator> 類別的執行個體指派給 <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CustomCertificateValidator%2A> 屬性。</span><span class="sxs-lookup"><span data-stu-id="bae01-121">If the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> property is set to <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom>, then assign an instance of the custom <xref:System.IdentityModel.Selectors.X509CertificateValidator> class to the <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CustomCertificateValidator%2A> property.</span></span>  
  
6. <span data-ttu-id="bae01-122">如果 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> 是設定為 `ChainTrust` 或 `PeerOrChainTrust`，則會將 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.RevocationMode%2A> 屬性設定為 <xref:System.Security.Cryptography.X509Certificates.X509RevocationMode> 列舉中的適當值。</span><span class="sxs-lookup"><span data-stu-id="bae01-122">If the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> is set to `ChainTrust` or `PeerOrChainTrust`, set the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.RevocationMode%2A> property to an appropriate value from the <xref:System.Security.Cryptography.X509Certificates.X509RevocationMode> enumeration.</span></span> <span data-ttu-id="bae01-123">請注意，在 `PeerTrust` 或 `Custom` 驗證模式中沒有使用撤銷模式。</span><span class="sxs-lookup"><span data-stu-id="bae01-123">Note that the revocation mode is not used in `PeerTrust` or `Custom` validation modes.</span></span>  
  
7. <span data-ttu-id="bae01-124">如有需要，將自訂 <xref:System.IdentityModel.Tokens.SamlSerializer> 類別的執行個體指派給 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.SamlSerializer%2A> 屬性。</span><span class="sxs-lookup"><span data-stu-id="bae01-124">If needed, assign an instance of a custom <xref:System.IdentityModel.Tokens.SamlSerializer> class to the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.SamlSerializer%2A> property.</span></span> <span data-ttu-id="bae01-125">例如，需要使用自訂的安全性判斷提示標記語言 (Security Assertions Markup Language，SAML) 序列化程式來剖析自訂 SAML 時。</span><span class="sxs-lookup"><span data-stu-id="bae01-125">A custom Security Assertions Markup Language (SAML) serializer is needed, for example, for parsing custom SAML assertions.</span></span>  
  
### <a name="to-set-the-properties-of-issuedtokenservicecredential-in-configuration"></a><span data-ttu-id="bae01-126">使用組態來設定 IssuedTokenServiceCredential 的屬性</span><span class="sxs-lookup"><span data-stu-id="bae01-126">To set the properties of IssuedTokenServiceCredential in configuration</span></span>  
  
1. <span data-ttu-id="bae01-127">建立 `<issuedTokenAuthentication>` 元素做為 <> 元素的子系 `serviceCredentials` 。</span><span class="sxs-lookup"><span data-stu-id="bae01-127">Create an `<issuedTokenAuthentication>` element as a child of a <`serviceCredentials`> element.</span></span>  
  
2. <span data-ttu-id="bae01-128">`allowUntrustedRsaIssuers` `<issuedTokenAuthentication>` `true` 如果驗證自我發行的權杖（例如 CardSpace 卡），請將元素的屬性設定為。</span><span class="sxs-lookup"><span data-stu-id="bae01-128">Set the `allowUntrustedRsaIssuers` attribute of the `<issuedTokenAuthentication>` element to `true` if authenticating a self-issued token, such as a CardSpace card.</span></span>  
  
3. <span data-ttu-id="bae01-129">建立 `<knownCertificates>` 項目做為 `<issuedTokenAuthentication>` 項目的子項。</span><span class="sxs-lookup"><span data-stu-id="bae01-129">Create a `<knownCertificates>` element as a child of the `<issuedTokenAuthentication>` element.</span></span>  
  
4. <span data-ttu-id="bae01-130">建立零個或多個 `<add>` 項目做為 `<knownCertificates>` 項目的子項目，並使用 `storeLocation`, `storeName`、`x509FindType` 及 `findValue` 屬性來指定如何找到該憑證。</span><span class="sxs-lookup"><span data-stu-id="bae01-130">Create zero or more `<add>` elements as children of the `<knownCertificates>` element, and specify how to locate the certificate using the `storeLocation`, `storeName`, `x509FindType`, and `findValue` attributes.</span></span>  
  
5. <span data-ttu-id="bae01-131">如有必要，請將 `samlSerializer` <> 元素的屬性設定 `issuedTokenAuthentication` 為自訂類別的型別名稱 <xref:System.IdentityModel.Tokens.SamlSerializer> 。</span><span class="sxs-lookup"><span data-stu-id="bae01-131">If necessary, set the `samlSerializer` attribute of the <`issuedTokenAuthentication`> element to the type name of the custom <xref:System.IdentityModel.Tokens.SamlSerializer> class.</span></span>  
  
## <a name="example"></a><span data-ttu-id="bae01-132">範例</span><span class="sxs-lookup"><span data-stu-id="bae01-132">Example</span></span>  
 <span data-ttu-id="bae01-133">下列範例會示範使用程式碼來設定 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> 的屬性。</span><span class="sxs-lookup"><span data-stu-id="bae01-133">The following example sets the properties of an <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> in code.</span></span>  
  
 [!code-csharp[C_FederatedService#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_federatedservice/cs/source.cs#2)]
 [!code-vb[C_FederatedService#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_federatedservice/vb/source.vb#2)]  
  
 <span data-ttu-id="bae01-134">為了讓聯合服務驗證用戶端，下列有關已發行權杖的各項條件必須成立：</span><span class="sxs-lookup"><span data-stu-id="bae01-134">In order for a federated service to authenticate a client, the following must be true about the issued token:</span></span>  
  
- <span data-ttu-id="bae01-135">當已發行權杖的數位簽章使用 RSA 安全性金鑰識別碼時，<xref:System.ServiceModel.Security.IssuedTokenServiceCredential.AllowUntrustedRsaIssuers%2A> 屬性必須是 `true`。</span><span class="sxs-lookup"><span data-stu-id="bae01-135">When the issued token’s digital signature uses an RSA security key identifier, the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.AllowUntrustedRsaIssuers%2A> property must be `true`.</span></span>  
  
- <span data-ttu-id="bae01-136">當已發行權杖的簽章使用 X.509 簽發者序號、X.509 主體金鑰識別碼或 X.509 指紋安全性識別碼時，已發行權杖必須由 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> 類別之 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> 屬性所傳回集合中的憑證完成簽署。</span><span class="sxs-lookup"><span data-stu-id="bae01-136">When the issued token’s signature uses an X.509 issuer serial number, X.509 subject key identifier, or X.509 thumbprint security identifier, the issued token must be signed by a certificate in the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> property of the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> class.</span></span>  
  
- <span data-ttu-id="bae01-137">當已發行權杖使用 X.509 憑證完成簽署時，該憑證都必須根據 <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CertificateValidationMode%2A> 屬性值所指定的語意進行驗證，無論該憑證是否當做 <xref:System.IdentityModel.Tokens.X509RawDataKeyIdentifierClause> 傳送到信賴憑證者或者是從 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> 屬性取得。</span><span class="sxs-lookup"><span data-stu-id="bae01-137">When the issued token is signed using an X.509 certificate, the certificate must validate per the semantics specified by the value of the <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CertificateValidationMode%2A> property, regardless of whether the certificate was sent to the relying party as a <xref:System.IdentityModel.Tokens.X509RawDataKeyIdentifierClause> or was obtained from the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> property.</span></span> <span data-ttu-id="bae01-138">如需 x.509 憑證驗證的詳細資訊，請參閱[使用憑證](working-with-certificates.md)。</span><span class="sxs-lookup"><span data-stu-id="bae01-138">For more information about X.509 certificate validation, see [Working with Certificates](working-with-certificates.md).</span></span>  
  
 <span data-ttu-id="bae01-139">例如，將 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> 設定為 <xref:System.ServiceModel.Security.X509CertificateValidationMode.PeerTrust>，便會對任何簽署憑證是位於 `TrustedPeople` 憑證存放區中的憑證進行驗證。</span><span class="sxs-lookup"><span data-stu-id="bae01-139">For example, setting the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> to <xref:System.ServiceModel.Security.X509CertificateValidationMode.PeerTrust> would authenticate any issued token whose signing certificate is in the `TrustedPeople` certificate store.</span></span> <span data-ttu-id="bae01-140">在此情況下，請將 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.TrustedStoreLocation%2A> 屬性設定為 <xref:System.Security.Cryptography.X509Certificates.StoreLocation.CurrentUser> 或 <xref:System.Security.Cryptography.X509Certificates.StoreLocation.LocalMachine>。</span><span class="sxs-lookup"><span data-stu-id="bae01-140">In that case, set the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.TrustedStoreLocation%2A> property to either <xref:System.Security.Cryptography.X509Certificates.StoreLocation.CurrentUser> or <xref:System.Security.Cryptography.X509Certificates.StoreLocation.LocalMachine>.</span></span> <span data-ttu-id="bae01-141">您可以選擇包括 <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom> 的其他模式。</span><span class="sxs-lookup"><span data-stu-id="bae01-141">You can select other modes, including <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom>.</span></span> <span data-ttu-id="bae01-142">若是選擇 `Custom`，您就必須將 <xref:System.IdentityModel.Selectors.X509CertificateValidator> 類別的執行個體指派給 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CustomCertificateValidator%2A> 屬性。</span><span class="sxs-lookup"><span data-stu-id="bae01-142">When `Custom` is selected, you must assign an instance of the <xref:System.IdentityModel.Selectors.X509CertificateValidator> class to the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CustomCertificateValidator%2A> property.</span></span> <span data-ttu-id="bae01-143">自訂驗證器可以使用其所偏好的任何準則來驗證憑證。</span><span class="sxs-lookup"><span data-stu-id="bae01-143">The custom validator can validate certificates using any criteria it likes.</span></span> <span data-ttu-id="bae01-144">如需詳細資訊，請參閱[如何：建立採用自訂憑證驗證程式的服務](../extending/how-to-create-a-service-that-employs-a-custom-certificate-validator.md)。</span><span class="sxs-lookup"><span data-stu-id="bae01-144">For more information, see [How to: Create a Service that Employs a Custom Certificate Validator](../extending/how-to-create-a-service-that-employs-a-custom-certificate-validator.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bae01-145">請參閱</span><span class="sxs-lookup"><span data-stu-id="bae01-145">See also</span></span>

- [<span data-ttu-id="bae01-146">同盟</span><span class="sxs-lookup"><span data-stu-id="bae01-146">Federation</span></span>](federation.md)
- [<span data-ttu-id="bae01-147">聯合與信任</span><span class="sxs-lookup"><span data-stu-id="bae01-147">Federation and Trust</span></span>](federation-and-trust.md)
- [<span data-ttu-id="bae01-148">聯合範例</span><span class="sxs-lookup"><span data-stu-id="bae01-148">Federation Sample</span></span>](../samples/federation-sample.md)
- [<span data-ttu-id="bae01-149">HOW TO：在 WSFederationHttpBinding 上停用安全工作階段</span><span class="sxs-lookup"><span data-stu-id="bae01-149">How to: Disable Secure Sessions on a WSFederationHttpBinding</span></span>](how-to-disable-secure-sessions-on-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="bae01-150">如何：建立 WSFederationHttpBinding</span><span class="sxs-lookup"><span data-stu-id="bae01-150">How to: Create a WSFederationHttpBinding</span></span>](how-to-create-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="bae01-151">如何：建立同盟用戶端</span><span class="sxs-lookup"><span data-stu-id="bae01-151">How to: Create a Federated Client</span></span>](how-to-create-a-federated-client.md)
- [<span data-ttu-id="bae01-152">Working with Certificates</span><span class="sxs-lookup"><span data-stu-id="bae01-152">Working with Certificates</span></span>](working-with-certificates.md)
- [<span data-ttu-id="bae01-153">SecurityBindingElement 驗證模式</span><span class="sxs-lookup"><span data-stu-id="bae01-153">SecurityBindingElement Authentication Modes</span></span>](securitybindingelement-authentication-modes.md)
