---
title: 工作流程服務主機擴充性
ms.date: 03/30/2017
ms.assetid: c0e8f7bb-cb13-49ec-852f-b85d7c23972f
ms.openlocfilehash: 67a7830c564cabafb9441e86eb0d87164d854ee5
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/26/2020
ms.locfileid: "96258448"
---
# <a name="workflow-service-host-extensibility"></a><span data-ttu-id="e5854-102">工作流程服務主機擴充性</span><span class="sxs-lookup"><span data-stu-id="e5854-102">Workflow Service Host Extensibility</span></span>

[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)] <span data-ttu-id="e5854-103">提供用於裝載工作流程服務的 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 類別。</span><span class="sxs-lookup"><span data-stu-id="e5854-103">provides the <xref:System.ServiceModel.Activities.WorkflowServiceHost> class for hosting workflow services.</span></span> <span data-ttu-id="e5854-104">若您要在 Managed 應用程式或 Windows 服務中自我裝載工作流程服務，則可使用此類別。</span><span class="sxs-lookup"><span data-stu-id="e5854-104">This class is used when you are self-hosting a workflow service in a managed application or a Windows service.</span></span> <span data-ttu-id="e5854-105">此類別還可在透過網際網路資訊服務 (IIS) 或 Windows Process Activation Service (WAS) 裝載工作流程時使用。</span><span class="sxs-lookup"><span data-stu-id="e5854-105">This class is also used when hosting a workflow service with Internet Information Services (IIS) or Windows Process Activation Service (WAS).</span></span> <span data-ttu-id="e5854-106"><xref:System.ServiceModel.Activities.WorkflowServiceHost> 類別會提供擴充點，讓您加入自訂擴充、變更閒置行為，以及裝載非服務工作流程 (不使用訊息傳遞活動的工作流程)。</span><span class="sxs-lookup"><span data-stu-id="e5854-106">The <xref:System.ServiceModel.Activities.WorkflowServiceHost> class provides extension points that allow you to add custom extensions, change the idle behavior, and host non-service workflows (workflows that do not use messaging activities).</span></span>  
  
## <a name="workflow-service-host-extensions"></a><span data-ttu-id="e5854-107">工作流程服務主機延伸模組</span><span class="sxs-lookup"><span data-stu-id="e5854-107">Workflow Service Host Extensions</span></span>  

 <span data-ttu-id="e5854-108"><xref:System.ServiceModel.Activities.WorkflowServiceHost> 包含 <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> 類型的 <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> 屬性，可提供將延伸模組加入至 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 的方法。</span><span class="sxs-lookup"><span data-stu-id="e5854-108">The <xref:System.ServiceModel.Activities.WorkflowServiceHost> contains a <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> property of type <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> that provides methods to add extensions to the <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span></span> <span data-ttu-id="e5854-109">使用 <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> 方法可為每個工作流程服務執行個體加入延伸模組。</span><span class="sxs-lookup"><span data-stu-id="e5854-109">Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service instance.</span></span> <span data-ttu-id="e5854-110">建立或從持續性存放區載入工作流程服務執行個體時，會呼叫指定的委派建立新的延伸模組。</span><span class="sxs-lookup"><span data-stu-id="e5854-110">The delegate specified is called to create a new extension when a workflow service instance is created or loaded from a persistence store.</span></span> <span data-ttu-id="e5854-111">使用 <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> 方法可為每一部工作流程服務主機加入延伸模組，每個延伸模組執行個體可供所有工作流程服務執行個體共用。</span><span class="sxs-lookup"><span data-stu-id="e5854-111">Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service host, one instance of the extension is shared for all workflow service instances.</span></span>  
  
## <a name="react-to-unhandled-exceptions"></a><span data-ttu-id="e5854-112">回應未處理的例外狀況</span><span class="sxs-lookup"><span data-stu-id="e5854-112">React to Unhandled Exceptions</span></span>  

 <span data-ttu-id="e5854-113"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> 可讓您指定工作流程服務內發生未處理的例外狀況時，所採取的動作。</span><span class="sxs-lookup"><span data-stu-id="e5854-113">The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> enables you to specify the action to take if an unhandled exception occurs within a workflow service.</span></span> <span data-ttu-id="e5854-114"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> 屬性會指定其中一個 <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> 值：</span><span class="sxs-lookup"><span data-stu-id="e5854-114">The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> property specifies one of the <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> values:</span></span>  
  
- <span data-ttu-id="e5854-115"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> – 中止工作流程服務執行個體。</span><span class="sxs-lookup"><span data-stu-id="e5854-115"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> – Aborts the workflow service instance.</span></span>  
  
- <span data-ttu-id="e5854-116"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> – 回復到最後保存的狀態，並且暫停工作流程服務執行個體。</span><span class="sxs-lookup"><span data-stu-id="e5854-116"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> – Rolls back to the last persisted state and suspends the workflow service instance.</span></span> <span data-ttu-id="e5854-117">只有在工作流程至少已保存一次時，才會發生此情況。</span><span class="sxs-lookup"><span data-stu-id="e5854-117">This only occurs if the workflow has already been persisted at least once.</span></span> <span data-ttu-id="e5854-118">否則，就會中止工作流程執行個體。</span><span class="sxs-lookup"><span data-stu-id="e5854-118">If not the workflow instance is aborted.</span></span>  
  
- <span data-ttu-id="e5854-119"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> – 取消執行個體。</span><span class="sxs-lookup"><span data-stu-id="e5854-119"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> – Cancels the instance.</span></span>  
  
- <span data-ttu-id="e5854-120"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> – 終止執行個體。</span><span class="sxs-lookup"><span data-stu-id="e5854-120"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> – Terminates the instance.</span></span>  
  
 <span data-ttu-id="e5854-121">此行為可以在程式碼中設定，如下列範例所示。</span><span class="sxs-lookup"><span data-stu-id="e5854-121">This behavior can be configured in code as shown in the following example.</span></span>  
  
```csharp  
host.Description.Behaviors.Add(new WorkflowUnhandledExceptionBehavior { Action = WorkflowUnhandledExceptionAction.Abandon });  
```  
  
 <span data-ttu-id="e5854-122">此外，它也可以在組態檔中設定，如下列範例所示</span><span class="sxs-lookup"><span data-stu-id="e5854-122">It can also be configured in a configuration file as shown in the following example.</span></span>  
  
```xml
<behaviors>  
      <serviceBehaviors>  
        <behavior>  
          <serviceMetadata httpGetEnabled="True"/>  
          <serviceDebug includeExceptionDetailInFaults="False" />  
          <workflowUnhandledExceptionBehavior action="Abandon" />
        </behavior>  
      </serviceBehaviors>  
</behaviors>
```  
  
## <a name="hosting-non-service-workflows"></a><span data-ttu-id="e5854-123">裝載非服務工作流程</span><span class="sxs-lookup"><span data-stu-id="e5854-123">Hosting Non-Service Workflows</span></span>  

 <span data-ttu-id="e5854-124"><xref:System.ServiceModel.Activities.WorkflowServiceHost> 可以用來裝載非服務工作流程，或者不是以 <xref:System.ServiceModel.Activities.Receive> 活動開始的工作流程，或不使用訊息傳遞活動的工作流程。</span><span class="sxs-lookup"><span data-stu-id="e5854-124"><xref:System.ServiceModel.Activities.WorkflowServiceHost> can be used to host non-service workflows, or workflows that either do not begin with a <xref:System.ServiceModel.Activities.Receive> activity or workflows that do not use the messaging activities.</span></span> <span data-ttu-id="e5854-125">工作流程服務通常會以 <xref:System.ServiceModel.Activities.Receive> 活動開始。</span><span class="sxs-lookup"><span data-stu-id="e5854-125">Workflow services normally begin with a <xref:System.ServiceModel.Activities.Receive> activity.</span></span> <span data-ttu-id="e5854-126">當 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 接收工作流程服務的訊息時，如果尚未執行 (或已保存)，則會建立新的工作流程服務執行個體。</span><span class="sxs-lookup"><span data-stu-id="e5854-126">When the <xref:System.ServiceModel.Activities.WorkflowServiceHost> receives a message for a workflow service, if it is not already running (or persisted) a new workflow service instance is created.</span></span> <span data-ttu-id="e5854-127">如果工作流程不是以接收活動開始，則無法藉由傳送訊息的方式啟動，因為沒有接收訊息的活動。</span><span class="sxs-lookup"><span data-stu-id="e5854-127">If a workflow does not begin with a Receive activity, it cannot be started by sending a message because there is no activity to receive the message.</span></span> <span data-ttu-id="e5854-128">若要裝載非服務工作流程，請從 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> 衍生類別，並且覆寫 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>、<xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> 和 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>。</span><span class="sxs-lookup"><span data-stu-id="e5854-128">To host a non-service workflow, derive a class from <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> and override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>, <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A>, and <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>.</span></span> <span data-ttu-id="e5854-129">如果您要提供慣用的執行個體 ID，請覆寫 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>。</span><span class="sxs-lookup"><span data-stu-id="e5854-129">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A> if you want to provide a preferred instance ID.</span></span> <span data-ttu-id="e5854-130">覆寫 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A>，即可建立自訂的工作流程建立內容，或是填入現有 <xref:System.ServiceModel.Activities.WorkflowCreationContext> 的執行個體。</span><span class="sxs-lookup"><span data-stu-id="e5854-130">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> to create a custom workflow creation context or populate an instance of the existing <xref:System.ServiceModel.Activities.WorkflowCreationContext>.</span></span> <span data-ttu-id="e5854-131">覆寫 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>，即可從傳入訊息手動擷取書籤。</span><span class="sxs-lookup"><span data-stu-id="e5854-131">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> to manually extract the bookmark from the incoming message.</span></span> <span data-ttu-id="e5854-132">如果您覆寫此方法，就必須在其主體中叫用 <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A>，以便回應傳送至 WorkflowHostingEndpoint 的訊息。</span><span class="sxs-lookup"><span data-stu-id="e5854-132">If you override this method, you must invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> in its body so as to respond to the message sent to the WorkflowHostingEndpoint.</span></span> <span data-ttu-id="e5854-133">如果您沒有這樣做，最後可能會超過 <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> 限制。</span><span class="sxs-lookup"><span data-stu-id="e5854-133">If you do not do so, a <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> limit may be eventually exceeded.</span></span> <span data-ttu-id="e5854-134">在雙向合約中，您可以偵測由於用戶端無法接收回應所導致的 <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> 叫用失敗。</span><span class="sxs-lookup"><span data-stu-id="e5854-134">In two-way contracts, you may be able to detect your   failure to invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> because of the client’s failure to receive a response.</span></span> <span data-ttu-id="e5854-135">在單向合約中，您可能要等到超過 <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> 節流閥限制之後，才能辨識無法呼叫 <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> 的錯誤，但是卻為時已晚。</span><span class="sxs-lookup"><span data-stu-id="e5854-135">In one-way contracts, you may not recognize the mistake of failing to call <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> until it’s too late, after the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> throttle limit is exceeded.</span></span> <span data-ttu-id="e5854-136">如需詳細資訊，請參閱 [WorkflowHostingEndpoint Resume 書簽](../../windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)以建立非服務工作流程的新實例、宣告服務合約，以定義建立新實例的作業。</span><span class="sxs-lookup"><span data-stu-id="e5854-136">For more information, please see the [WorkflowHostingEndpoint Resume Bookmark](../../windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)To create a new instance of a non-service workflow, declare a service contract that defines an operation that creates a new instance.</span></span> <span data-ttu-id="e5854-137">建立作業應採用 IDictionary \<string, object> 來傳遞任何必要的工作流程參數。</span><span class="sxs-lookup"><span data-stu-id="e5854-137">The creation operation should take an IDictionary\<string, object> to pass any required workflow parameters.</span></span> <span data-ttu-id="e5854-138">此合約會由 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> 衍生的類別以隱含方式實作。</span><span class="sxs-lookup"><span data-stu-id="e5854-138">This contract is implicitly implemented by the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class.</span></span> <span data-ttu-id="e5854-139">裝載工作流程時，可呼叫 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>，將 <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> 衍生類別的執行個體加入至主機，並且呼叫 <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>。</span><span class="sxs-lookup"><span data-stu-id="e5854-139">When hosting the workflow, add an instance of the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class to the host by calling <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> and call <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>.</span></span> <span data-ttu-id="e5854-140">若要建立工作流程的執行個體，請建立服務合約型別的 <xref:System.ServiceModel.ChannelFactory%601>，並且呼叫 <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>。</span><span class="sxs-lookup"><span data-stu-id="e5854-140">To create an instance of the workflow, create a <xref:System.ServiceModel.ChannelFactory%601> of your service contract type and call <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>.</span></span> <span data-ttu-id="e5854-141">接著，您可以呼叫服務合約中定義的建立作業。</span><span class="sxs-lookup"><span data-stu-id="e5854-141">You can then call the create operation defined in your service contract.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e5854-142">另請參閱</span><span class="sxs-lookup"><span data-stu-id="e5854-142">See also</span></span>

- [<span data-ttu-id="e5854-143">工作流程服務</span><span class="sxs-lookup"><span data-stu-id="e5854-143">Workflow Services</span></span>](workflow-services.md)
- [<span data-ttu-id="e5854-144">傳訊活動</span><span class="sxs-lookup"><span data-stu-id="e5854-144">Messaging Activities</span></span>](messaging-activities.md)
