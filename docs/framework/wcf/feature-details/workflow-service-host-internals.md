---
title: 工作流程服務主機內部
ms.date: 03/30/2017
ms.assetid: af44596f-bf6a-4149-9f04-08d8e8f45250
ms.openlocfilehash: 7b47293211ee8143b1ce713c64ff1d5b22161b45
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/09/2020
ms.locfileid: "84594877"
---
# <a name="workflow-service-host-internals"></a><span data-ttu-id="f6e70-102">工作流程服務主機內部</span><span class="sxs-lookup"><span data-stu-id="f6e70-102">Workflow Service Host Internals</span></span>
<span data-ttu-id="f6e70-103"><xref:System.ServiceModel.WorkflowServiceHost> 會提供工作流程服務的主機。</span><span class="sxs-lookup"><span data-stu-id="f6e70-103"><xref:System.ServiceModel.WorkflowServiceHost> provides a host for workflow services.</span></span> <span data-ttu-id="f6e70-104">它會負責接聽傳入訊息並將訊息路由傳送至適當的工作流程服務執行個體、控制閒置工作流程的卸載和保存作業，以及其他作業。</span><span class="sxs-lookup"><span data-stu-id="f6e70-104">It is responsible for listening for incoming messages and routing them to the appropriate workflow service instance, it controls unloading and persisting of idle workflows, and more.</span></span> <span data-ttu-id="f6e70-105">本主題描述 WorkflowServiceHost 如何處理傳入訊息。</span><span class="sxs-lookup"><span data-stu-id="f6e70-105">This topic describes how WorkflowServiceHost processes incoming messages.</span></span>  
  
## <a name="workflowservicehost-overview"></a><span data-ttu-id="f6e70-106">WorkflowServiceHost 概觀</span><span class="sxs-lookup"><span data-stu-id="f6e70-106">WorkflowServiceHost Overview</span></span>  

<span data-ttu-id="f6e70-107"><xref:System.ServiceModel.WorkflowServiceHost> 類別是用來裝載工作流程服務。</span><span class="sxs-lookup"><span data-stu-id="f6e70-107">The <xref:System.ServiceModel.WorkflowServiceHost> class is used to host workflow services.</span></span> <span data-ttu-id="f6e70-108">它會接聽傳入訊息並將訊息路由傳送至適當的服務執行個體，並視需要建立新的執行個體或從永久性儲存裝置載入現有的執行個體。</span><span class="sxs-lookup"><span data-stu-id="f6e70-108">It listens for incoming messages and routes them to the appropriate service instance, creating new instances or loading existing instances from durable storage as needed.</span></span> <span data-ttu-id="f6e70-109">下圖說明高層級的 <xref:System.ServiceModel.WorkflowServiceHost> 運作方式：</span><span class="sxs-lookup"><span data-stu-id="f6e70-109">The following diagram illustrates on a high level how <xref:System.ServiceModel.WorkflowServiceHost> works:</span></span>
  
 ![此圖顯示工作流程服務主機的總覽。](./media/workflow-service-host-internals/workflow-service-host-high-level-overview.gif)  
  
 <span data-ttu-id="f6e70-111">這張圖表顯示 <xref:System.ServiceModel.WorkflowServiceHost> 會從 .xamlx 檔案載入工作流程服務定義，並且從組態檔載入組態資訊。</span><span class="sxs-lookup"><span data-stu-id="f6e70-111">This diagram shows that <xref:System.ServiceModel.WorkflowServiceHost> loads workflow service definitions from .xamlx files and loads configuration information from a configuration file.</span></span> <span data-ttu-id="f6e70-112">它也會從追蹤設定檔載入追蹤組態。</span><span class="sxs-lookup"><span data-stu-id="f6e70-112">It also loads tracking configuration from the tracking profile.</span></span> <span data-ttu-id="f6e70-113"><xref:System.ServiceModel.WorkflowServiceHost> 會公開工作流程控制端點，可讓您將控制作業傳送至工作流程執行個體。</span><span class="sxs-lookup"><span data-stu-id="f6e70-113"><xref:System.ServiceModel.WorkflowServiceHost> exposes a workflow control endpoint which allows you to send control operations to workflow instances.</span></span>  <span data-ttu-id="f6e70-114">如需詳細資訊，請參閱[工作流程式控制制端點範例](workflow-control-endpoint.md)。</span><span class="sxs-lookup"><span data-stu-id="f6e70-114">For more information see [Workflow Control Endpoint sample](workflow-control-endpoint.md).</span></span>  
  
 <span data-ttu-id="f6e70-115"><xref:System.ServiceModel.WorkflowServiceHost> 也會公開應用程式端點，以便接聽傳入的應用程式訊息。</span><span class="sxs-lookup"><span data-stu-id="f6e70-115"><xref:System.ServiceModel.WorkflowServiceHost> also exposes application endpoints that listen for incoming application messages.</span></span> <span data-ttu-id="f6e70-116">當傳入訊息送達時，它就會傳送至適當的工作流程服務執行個體 (如果目前已載入的話)。</span><span class="sxs-lookup"><span data-stu-id="f6e70-116">When an incoming message arrives it is sent to the appropriate workflow service instance (if it is currently loaded).</span></span> <span data-ttu-id="f6e70-117">必要時，它也會建立新的工作流程執行個體。</span><span class="sxs-lookup"><span data-stu-id="f6e70-117">If needed a new workflow instance is created.</span></span> <span data-ttu-id="f6e70-118">或者，如果現有的執行個體已經保存，就會從持續性存放區載入此執行個體。</span><span class="sxs-lookup"><span data-stu-id="f6e70-118">Or if an existing instance has been persisted it is loaded from the persistence store.</span></span>  
  
## <a name="workflowservicehost-details"></a><span data-ttu-id="f6e70-119">WorkflowServiceHost 詳細資料</span><span class="sxs-lookup"><span data-stu-id="f6e70-119">WorkflowServiceHost Details</span></span>  
 <span data-ttu-id="f6e70-120">下圖顯示如何 <xref:System.ServiceModel.WorkflowServiceHost> 以更詳細的方式處理訊息：</span><span class="sxs-lookup"><span data-stu-id="f6e70-120">The following diagram shows how <xref:System.ServiceModel.WorkflowServiceHost> handles messages in a bit more detail:</span></span>  
  
 ![顯示工作流程服務主機訊息流程的圖表。](./media/workflow-service-host-internals/workflow-service-host-message-flow.gif)  
  
 <span data-ttu-id="f6e70-122">這張圖表顯示三個不同的端點：應用程式端點、工作流程控制端點和工作流程裝載端點。</span><span class="sxs-lookup"><span data-stu-id="f6e70-122">This diagram shows three different endpoints, an application endpoint, a workflow control endpoint, and a workflow hosting endpoint.</span></span> <span data-ttu-id="f6e70-123">應用程式端點會接收要傳送至特定工作流程執行個體的訊息。</span><span class="sxs-lookup"><span data-stu-id="f6e70-123">The application endpoint receives messages that are bound for a specific workflow instance.</span></span> <span data-ttu-id="f6e70-124">工作流程控制端點會接聽控制作業。</span><span class="sxs-lookup"><span data-stu-id="f6e70-124">The workflow control endpoint listens for control operations.</span></span> <span data-ttu-id="f6e70-125">工作流程裝載端點會接聽讓 <xref:System.ServiceModel.WorkflowServiceHost> 載入並執行非服務工作流程的訊息。</span><span class="sxs-lookup"><span data-stu-id="f6e70-125">The workflow hosting endpoint listens for messages that cause <xref:System.ServiceModel.WorkflowServiceHost> to load and execute non-service workflows.</span></span> <span data-ttu-id="f6e70-126">如圖表所示，所有訊息都會透過 WCF 執行階段處理。</span><span class="sxs-lookup"><span data-stu-id="f6e70-126">As shown in the diagram all messages are processed through the WCF runtime.</span></span>  <span data-ttu-id="f6e70-127">工作流程執行個體節流是使用 <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentInstances%2A> 屬性來達成。</span><span class="sxs-lookup"><span data-stu-id="f6e70-127">Workflow service instance throttling is achieved by using the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentInstances%2A> property.</span></span> <span data-ttu-id="f6e70-128">這個屬性會限制並行工作流程服務執行個體的數目。</span><span class="sxs-lookup"><span data-stu-id="f6e70-128">This property will limit the number of concurrent workflow service instances.</span></span> <span data-ttu-id="f6e70-129">超過此節流時，系統就會將新工作流程服務執行個體的任何其他要求或啟動已保存之工作流程執行個體的要求排入佇列。</span><span class="sxs-lookup"><span data-stu-id="f6e70-129">When this throttle is exceeded any additional requests for new workflow service instances or requests to activate persisted workflow instances will be queued.</span></span> <span data-ttu-id="f6e70-130">已佇列的要求會按照 FIFO 順序來處理，不論它們是新執行個體或執行中之已保存執行個體的要求都一樣。</span><span class="sxs-lookup"><span data-stu-id="f6e70-130">The queued requests are processed in FIFO order regardless of whether they are requests for a new instance or a running, persisted instance.</span></span> <span data-ttu-id="f6e70-131">系統會載入主機原則資訊，以便判斷如何處理未處理的例外狀況，以及如何卸載並保存閒置的工作流程服務。</span><span class="sxs-lookup"><span data-stu-id="f6e70-131">Host policy information is loaded that determines how unhandled exceptions are dealt with, and how idle workflow services are unloaded and persisted.</span></span> <span data-ttu-id="f6e70-132">如需這些主題的詳細資訊，請參閱[如何：使用 Workflowservicehost 設定工作流程未處理的例外狀況行為](config-workflow-unhandled-exception-workflowservicehost.md)和[如何：使用 Workflowservicehost 設定閒置行為](how-to-configure-idle-behavior-with-workflowservicehost.md)。</span><span class="sxs-lookup"><span data-stu-id="f6e70-132">For more information about these topics see [How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost](config-workflow-unhandled-exception-workflowservicehost.md) and [How to: Configure Idle Behavior with WorkflowServiceHost](how-to-configure-idle-behavior-with-workflowservicehost.md).</span></span> <span data-ttu-id="f6e70-133">工作流程執行個體是根據主機原則來保存，並在必要時重新載入。</span><span class="sxs-lookup"><span data-stu-id="f6e70-133">Workflow instances are persisted according to host policies and are reloaded when needed.</span></span> <span data-ttu-id="f6e70-134">如需工作流程持續性的詳細資訊，請參閱：[如何：使用 WorkflowServiceHost 設定持續](how-to-configure-persistence-with-workflowservicehost.md)性、[建立長時間執行的工作流程服務](creating-a-long-running-workflow-service.md)和[工作流程持續](../../windows-workflow-foundation/workflow-persistence.md)性。</span><span class="sxs-lookup"><span data-stu-id="f6e70-134">For more information about workflow persistence see: [How to: Configure Persistence with WorkflowServiceHost](how-to-configure-persistence-with-workflowservicehost.md), [Creating a Long-running Workflow Service](creating-a-long-running-workflow-service.md), and [Workflow Persistence](../../windows-workflow-foundation/workflow-persistence.md).</span></span>  
  
 <span data-ttu-id="f6e70-135">下圖顯示在呼叫 WorkflowServiceHost 時的流程：</span><span class="sxs-lookup"><span data-stu-id="f6e70-135">The following illustration shows the flow when WorkflowServiceHost.Open is called:</span></span>  
  
 ![在呼叫 WorkflowServiceHost. Open 時顯示流程的圖表。](./media/workflow-service-host-internals/workflow-service-host-open.gif)  
  
 <span data-ttu-id="f6e70-137">系統會從 XAML 載入工作流程，並且建立活動樹狀。</span><span class="sxs-lookup"><span data-stu-id="f6e70-137">The workflow is loaded from XAML and the activity tree is created.</span></span> <span data-ttu-id="f6e70-138"><xref:System.ServiceModel.WorkflowServiceHost> 會瀏覽活動樹狀並建立服務說明。</span><span class="sxs-lookup"><span data-stu-id="f6e70-138"><xref:System.ServiceModel.WorkflowServiceHost> walks the activity tree and creates the service description.</span></span> <span data-ttu-id="f6e70-139">然後，組態會套用至主機。</span><span class="sxs-lookup"><span data-stu-id="f6e70-139">Configuration is applied to the host.</span></span> <span data-ttu-id="f6e70-140">最後，主機會開始接聽傳入訊息。</span><span class="sxs-lookup"><span data-stu-id="f6e70-140">Finally the host begins to listen for incoming messages.</span></span>  
  
 <span data-ttu-id="f6e70-141">下圖顯示 <xref:System.ServiceModel.WorkflowServiceHost> 當收到 CanCreateInstance 設定為之 Receive 活動的訊息系結時，會執行的動作 `true` ：</span><span class="sxs-lookup"><span data-stu-id="f6e70-141">The following illustration shows what the <xref:System.ServiceModel.WorkflowServiceHost> does when it receives a message bound for a Receive activity that has CanCreateInstance set to `true`:</span></span>  
  
 ![工作流程主控制項接收訊息時所使用的決策樹，而 CanCreateInstance 則為 true。](./media/workflow-service-host-internals/workflow-service-host-receive-message-cancreateinstance.gif)  
  
 <span data-ttu-id="f6e70-143">當訊息送達時，就會由 WCF 通道堆疊處理。</span><span class="sxs-lookup"><span data-stu-id="f6e70-143">The message arrives and is processed by the WCF channel stack.</span></span> <span data-ttu-id="f6e70-144">然後，系統會檢查節流並執行相互關聯查詢。</span><span class="sxs-lookup"><span data-stu-id="f6e70-144">Throttles are checked and correlation queries are executed.</span></span> <span data-ttu-id="f6e70-145">如果此訊息要傳送至現有的執行個體，就會傳遞此訊息。</span><span class="sxs-lookup"><span data-stu-id="f6e70-145">If the message is bound for an existing instance the message is delivered.</span></span> <span data-ttu-id="f6e70-146">如果需要建立新的執行個體，則會檢查 Receive 活動的 CanCreateInstance 屬性。</span><span class="sxs-lookup"><span data-stu-id="f6e70-146">If a new instance needs to be created, the Receive activity’s CanCreateInstance property is checked.</span></span> <span data-ttu-id="f6e70-147">如果此屬性設定為 true，就會建立新的執行個體並傳遞此訊息。</span><span class="sxs-lookup"><span data-stu-id="f6e70-147">If it is set to true, a new instance is created and the message is delivered.</span></span>  
  
 <span data-ttu-id="f6e70-148">下圖顯示當 <xref:System.ServiceModel.WorkflowServiceHost> 接收要傳送至 CanCreateInstance 設定為 false 之 Receive 活動的訊息時，它所進行的作業。</span><span class="sxs-lookup"><span data-stu-id="f6e70-148">The following illustration shows what the <xref:System.ServiceModel.WorkflowServiceHost> does when it receives a message bound for a Receive activity that has CanCreateInstance set to false.</span></span>  
  
 ![工作流程主控制項接收訊息時所使用的決策樹，而 CanCreateInstance 則為 false。](./media/workflow-service-host-internals/workflow-service-host-receive-message.gif)  
  
 <span data-ttu-id="f6e70-150">當訊息送達時，就會由 WCF 通道堆疊處理。</span><span class="sxs-lookup"><span data-stu-id="f6e70-150">The message arrives and is processed by the WCF channel stack.</span></span> <span data-ttu-id="f6e70-151">然後，系統會檢查節流並執行相互關聯查詢。</span><span class="sxs-lookup"><span data-stu-id="f6e70-151">Throttles are checked and correlation queries are executed.</span></span> <span data-ttu-id="f6e70-152">此訊息要傳送至現有的執行個體 (因為 CanCreateInstance 為 false)，所以系統會從持續性存放區載入執行個體、繼續使用書籤，然後工作流程便執行。</span><span class="sxs-lookup"><span data-stu-id="f6e70-152">The message is bound for an existing instance (because CanCreateInstance is false) so the instance is loaded from persistence store, the bookmark is resumed and the workflow executes.</span></span>  
  
> [!WARNING]
> <span data-ttu-id="f6e70-153">如果 SQL Server 設定為只在 NamedPipe 通訊協定上接聽，工作流程服務主機將無法開啟。</span><span class="sxs-lookup"><span data-stu-id="f6e70-153">Workflow Service Host will fail to open if SQL Server is configured to listen on NamedPipe protocol only.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="f6e70-154">請參閱</span><span class="sxs-lookup"><span data-stu-id="f6e70-154">See also</span></span>

- [<span data-ttu-id="f6e70-155">工作流程服務</span><span class="sxs-lookup"><span data-stu-id="f6e70-155">Workflow Services</span></span>](workflow-services.md)
- [<span data-ttu-id="f6e70-156">裝載工作流程服務</span><span class="sxs-lookup"><span data-stu-id="f6e70-156">Hosting Workflow Services</span></span>](hosting-workflow-services.md)
- [<span data-ttu-id="f6e70-157">工作流程控制端點</span><span class="sxs-lookup"><span data-stu-id="f6e70-157">Workflow Control Endpoint</span></span>](workflow-control-endpoint.md)
- [<span data-ttu-id="f6e70-158">如何：使用 WorkflowServiceHost 設定工作流程未處理例外狀況行為</span><span class="sxs-lookup"><span data-stu-id="f6e70-158">How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost</span></span>](config-workflow-unhandled-exception-workflowservicehost.md)
- [<span data-ttu-id="f6e70-159">建立長期執行的工作流程服務</span><span class="sxs-lookup"><span data-stu-id="f6e70-159">Creating a Long-running Workflow Service</span></span>](creating-a-long-running-workflow-service.md)
- [<span data-ttu-id="f6e70-160">工作流程持續性</span><span class="sxs-lookup"><span data-stu-id="f6e70-160">Workflow Persistence</span></span>](../../windows-workflow-foundation/workflow-persistence.md)
