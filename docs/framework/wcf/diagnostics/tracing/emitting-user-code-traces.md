---
title: 發出使用者程式碼追蹤
ms.date: 03/30/2017
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
ms.openlocfilehash: e8b2031165a83e24ba15a2fcf847a170f47e696a
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/09/2020
ms.locfileid: "84589288"
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="57b4d-102">發出使用者程式碼追蹤</span><span class="sxs-lookup"><span data-stu-id="57b4d-102">Emitting User-Code Traces</span></span>

<span data-ttu-id="57b4d-103">除了在設定中啟用追蹤來收集 Windows Communication Foundation （WCF）所產生的檢測資料之外，您也可以在使用者程式碼中以程式設計方式發出追蹤。</span><span class="sxs-lookup"><span data-stu-id="57b4d-103">In addition to enabling tracing in configuration to collect instrumentation data generated by Windows Communication Foundation (WCF), you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="57b4d-104">如此一來，您就可以主動建立供日後深入診斷之用的檢測資料。</span><span class="sxs-lookup"><span data-stu-id="57b4d-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="57b4d-105">本主題將討論如何完成這項工作。</span><span class="sxs-lookup"><span data-stu-id="57b4d-105">This topic discusses how you can do this.</span></span>

<span data-ttu-id="57b4d-106">此外，[延伸追蹤](../../samples/extending-tracing.md)範例包含下列各節所示範的所有程式碼。</span><span class="sxs-lookup"><span data-stu-id="57b4d-106">In addition, the [Extending Tracing](../../samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>

## <a name="creating-a-trace-source"></a><span data-ttu-id="57b4d-107">建立追蹤來源</span><span class="sxs-lookup"><span data-stu-id="57b4d-107">Creating a Trace Source</span></span>

<span data-ttu-id="57b4d-108">您可以使用下列程式碼來建立使用者追蹤來源。</span><span class="sxs-lookup"><span data-stu-id="57b4d-108">You can use the following code to create a user trace source.</span></span>

```csharp
TraceSource ts = new TraceSource("myUserTraceSource");
```

## <a name="creating-activities"></a><span data-ttu-id="57b4d-109">建立活動</span><span class="sxs-lookup"><span data-stu-id="57b4d-109">Creating Activities</span></span>

<span data-ttu-id="57b4d-110">活動是處理的邏輯單位。</span><span class="sxs-lookup"><span data-stu-id="57b4d-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="57b4d-111">您可以為每個主要處理單位建立一個活動，而這些處理單位是您要在其中將追蹤聚集成群組的地方。</span><span class="sxs-lookup"><span data-stu-id="57b4d-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="57b4d-112">例如，您可以為每一個針對服務發出的要求建立一個活動。</span><span class="sxs-lookup"><span data-stu-id="57b4d-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="57b4d-113">若要這麼做，請執行下列步驟。</span><span class="sxs-lookup"><span data-stu-id="57b4d-113">To do so, perform the following steps.</span></span>

1. <span data-ttu-id="57b4d-114">儲存範圍內的活動識別碼。</span><span class="sxs-lookup"><span data-stu-id="57b4d-114">Save the activity ID in scope.</span></span>

2. <span data-ttu-id="57b4d-115">建立新的活動識別碼。</span><span class="sxs-lookup"><span data-stu-id="57b4d-115">Create a new activity ID.</span></span>

3. <span data-ttu-id="57b4d-116">從範圍內的活動傳輸到新活動、設定範圍內的新活動，然後發出該活動的「開始追蹤」。</span><span class="sxs-lookup"><span data-stu-id="57b4d-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>

<span data-ttu-id="57b4d-117">下列程式碼會示範如何執行此項作業。</span><span class="sxs-lookup"><span data-stu-id="57b4d-117">The following code demonstrates how to do this.</span></span>

```csharp
Guid oldID = Trace.CorrelationManager.ActivityId;
Guid traceID = Guid.NewGuid();
ts.TraceTransfer(0, "transfer", traceID);
Trace.CorrelationManager.ActivityId = traceID; // Trace is static
ts.TraceEvent(TraceEventType.Start, 0, "Add request");
```

## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="57b4d-118">在使用者活動內發出追蹤</span><span class="sxs-lookup"><span data-stu-id="57b4d-118">Emitting Traces within a User Activity</span></span>

<span data-ttu-id="57b4d-119">下列程式碼會在使用者活動內發出追蹤。</span><span class="sxs-lookup"><span data-stu-id="57b4d-119">The following code emits traces within a user activity.</span></span>

```csharp
double value1 = 100.00D;
double value2 = 15.99D;
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);
double result = client.Add(value1, value2);
ts.TraceInformation("Client receives Add response '" + result + "'");
```

## <a name="stopping-the-activities"></a><span data-ttu-id="57b4d-120">停止活動</span><span class="sxs-lookup"><span data-stu-id="57b4d-120">Stopping the Activities</span></span>

<span data-ttu-id="57b4d-121">若要停止活動，請傳輸回到舊活動、停止目前的活動識別碼，然後重設範圍內的舊活動識別碼。</span><span class="sxs-lookup"><span data-stu-id="57b4d-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>

<span data-ttu-id="57b4d-122">下列程式碼會示範如何執行此項作業。</span><span class="sxs-lookup"><span data-stu-id="57b4d-122">The following code demonstrates how to do this.</span></span>

```csharp
ts.TraceTransfer(0, "transfer", oldID);
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");
Trace.CorrelationManager.ActivityId = oldID;
```

## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="57b4d-123">將活動識別碼傳播至服務</span><span class="sxs-lookup"><span data-stu-id="57b4d-123">Propagating the Activity ID to A Service</span></span>

<span data-ttu-id="57b4d-124">如果同時在用戶端和服務的組態檔中，將其 `propagateActivity` 追蹤來源的 `true` 屬性設定為 `System.ServiceModel`，則會在用戶端定義的同一個活動中進行「加法」要求的服務處理。</span><span class="sxs-lookup"><span data-stu-id="57b4d-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="57b4d-125">如果服務定義了本身的活動和傳輸，服務追蹤就不會出現在用戶端傳播的活動中，</span><span class="sxs-lookup"><span data-stu-id="57b4d-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="57b4d-126">而會出現在和用戶端傳播的識別碼所代表之活動相互關聯的活動中 (此相互關聯是由傳輸追蹤建立)。</span><span class="sxs-lookup"><span data-stu-id="57b4d-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>

> [!NOTE]
> <span data-ttu-id="57b4d-127">如果在 `propagateActivity` `true` 用戶端和服務上將屬性設定為，則服務作業範圍中的環境活動會由 WCF 設定。</span><span class="sxs-lookup"><span data-stu-id="57b4d-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by WCF.</span></span>

<span data-ttu-id="57b4d-128">您可以使用下列程式碼來檢查是否已在 WCF 範圍內設定活動。</span><span class="sxs-lookup"><span data-stu-id="57b4d-128">You can use the following code to check whether an activity was set in scope by WCF.</span></span>

```csharp
// Check if an activity was set in scope by WCF, if it was
// propagated from the client. If not, ( ambient activity is
// equal to Guid.Empty), create a new one.
if(Trace.CorrelationManager.ActivityId == Guid.Empty)
{
    Guid newGuid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = newGuid;
}
// Emit your Start trace.
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");

// Emit the processing traces for that request.
serviceTs.TraceInformation("Service receives Add "
                            + n1 + ", " + n2);
// double result = n1 + n2;
serviceTs.TraceInformation("Service sends Add result" + result);

// Emit the Stop trace and exit the method scope.
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");
// return result;
```

## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="57b4d-129">追蹤程式碼中擲回的例外狀況</span><span class="sxs-lookup"><span data-stu-id="57b4d-129">Tracing Exceptions Thrown in Code</span></span>

<span data-ttu-id="57b4d-130">當您在程式碼中擲回例外狀況時，您也可以使用下列程式碼來追蹤警告層級 (含) 以上的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="57b4d-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>

```csharp
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");
```

## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="57b4d-131">在服務追蹤檢視器工具中檢視使用者追蹤</span><span class="sxs-lookup"><span data-stu-id="57b4d-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>

<span data-ttu-id="57b4d-132">本節包含使用[服務追蹤檢視器工具（svctraceviewer.exe）](../../service-trace-viewer-tool-svctraceviewer-exe.md)查看時，執行[延伸追蹤](../../samples/extending-tracing.md)範例所產生之追蹤的螢幕擷取畫面。</span><span class="sxs-lookup"><span data-stu-id="57b4d-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="57b4d-133">在下圖中，會在左面板上選取先前建立的「新增要求」活動。</span><span class="sxs-lookup"><span data-stu-id="57b4d-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="57b4d-134">它和構成應用程式用戶端程式的另外三個「數學運算」活動 (除法、減法、乘法) 列在一起。</span><span class="sxs-lookup"><span data-stu-id="57b4d-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="57b4d-135">使用者程式碼為每項作業各定義了一個新活動，以便隔離不同要求中可能發生的錯誤。</span><span class="sxs-lookup"><span data-stu-id="57b4d-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>

<span data-ttu-id="57b4d-136">為了示範[延伸追蹤](../../samples/extending-tracing.md)範例中的傳輸使用方式，也會建立封裝這四個作業要求的計算機活動。</span><span class="sxs-lookup"><span data-stu-id="57b4d-136">To demonstrate the use of transfers in the [Extending Tracing](../../samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="57b4d-137">每個要求都有往返於「計算機」活動和要求活動之間的傳輸 (本圖的右上方面板中會反白顯示追蹤)。</span><span class="sxs-lookup"><span data-stu-id="57b4d-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>

<span data-ttu-id="57b4d-138">當您選取左面板上的活動時，這個活動所包含的追蹤會顯示在右上方面板中。</span><span class="sxs-lookup"><span data-stu-id="57b4d-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="57b4d-139">如果 `propagateActivity` 是在 `true` 要求路徑中的每個端點，則要求活動中的追蹤會來自參與要求的所有處理常式。</span><span class="sxs-lookup"><span data-stu-id="57b4d-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="57b4d-140">在這個範例中，您可以在面板的第 4 欄中看見來自用戶端和服務兩方的追蹤。</span><span class="sxs-lookup"><span data-stu-id="57b4d-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>

<span data-ttu-id="57b4d-141">這個活動會顯示下列處理順序：</span><span class="sxs-lookup"><span data-stu-id="57b4d-141">This activity shows the following order of processing:</span></span>

1. <span data-ttu-id="57b4d-142">用戶端傳送訊息至「加法」。</span><span class="sxs-lookup"><span data-stu-id="57b4d-142">Client sends message to Add.</span></span>

2. <span data-ttu-id="57b4d-143">服務接收「加法」要求訊息。</span><span class="sxs-lookup"><span data-stu-id="57b4d-143">Service receives Add request message.</span></span>

3. <span data-ttu-id="57b4d-144">服務傳送「加法」回應。</span><span class="sxs-lookup"><span data-stu-id="57b4d-144">Service sends Add response.</span></span>

4. <span data-ttu-id="57b4d-145">用戶端接收「加法」回應。</span><span class="sxs-lookup"><span data-stu-id="57b4d-145">Client receives Add response.</span></span>

<span data-ttu-id="57b4d-146">所有這些追蹤都是在資訊層級發出。</span><span class="sxs-lookup"><span data-stu-id="57b4d-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="57b4d-147">按一下右上方面板中的追蹤，就會在右下方面板中顯示該追蹤的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="57b4d-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>

<span data-ttu-id="57b4d-148">在下列圖表中，也會看到往返「計算機」活動的傳輸追蹤，以及每個要求活動各兩對的「開始」和「停止」追蹤，一對屬於用戶端，另一對屬於服務 (亦即，每個追蹤來源各有一對追蹤)。</span><span class="sxs-lookup"><span data-stu-id="57b4d-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>

<span data-ttu-id="57b4d-149">![追蹤檢視器：發出使用者&#45;程式碼追蹤](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")依建立時間（左面板）及其嵌套活動的活動清單（右上方面板）</span><span class="sxs-lookup"><span data-stu-id="57b4d-149">![Trace Viewer: Emitting User&#45;code traces](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>

<span data-ttu-id="57b4d-150">如果服務程式碼擲回連帶導致用戶端擲回的例外狀況 (例如，用戶端未獲得其要求的回應時)，服務和用戶端的警告或錯誤訊息都會因為直接的相互關聯而在同一個活動中產生。</span><span class="sxs-lookup"><span data-stu-id="57b4d-150">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="57b4d-151">在下圖中，服務會擲回例外狀況，指出「服務會拒絕在使用者程式碼中處理此要求」。</span><span class="sxs-lookup"><span data-stu-id="57b4d-151">In the following image, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="57b4d-152">用戶端也會擲回例外狀況，指出「伺服器無法處理要求，因為發生內部錯誤。」</span><span class="sxs-lookup"><span data-stu-id="57b4d-152">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>

<span data-ttu-id="57b4d-153">下列影像顯示，如果要求活動識別碼已傳播，則指定要求的端點之間的錯誤會出現在相同的活動中：</span><span class="sxs-lookup"><span data-stu-id="57b4d-153">The following images shows that errors across endpoints for a given request appear in the same activity if the request activity id was propagated:</span></span>

![顯示指定要求之端點間錯誤的螢幕擷取畫面。](./media/emitting-user-code-traces/trace-viewer-endpoint-errors.gif)

<span data-ttu-id="57b4d-155">按兩下左面板上的「乘法」活動時，會顯示下圖，其中包含每個相關處理序的「乘法」活動追蹤。</span><span class="sxs-lookup"><span data-stu-id="57b4d-155">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="57b4d-156">我們可以看到警告先發生在服務 (擲回例外狀況)，接著會因為無法處理要求而在用戶端產生警告和錯誤。</span><span class="sxs-lookup"><span data-stu-id="57b4d-156">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="57b4d-157">因此，我們可以看出端點間發生錯誤的因果關係，從而得知錯誤的根本原因。</span><span class="sxs-lookup"><span data-stu-id="57b4d-157">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>

<span data-ttu-id="57b4d-158">下圖顯示錯誤相互關聯的圖表視圖：</span><span class="sxs-lookup"><span data-stu-id="57b4d-158">The following image shows a graph view of error correlation:</span></span>

![顯示錯誤相互關聯之圖形視圖的螢幕擷取畫面。](./media/emitting-user-code-traces/trace-viewer-error-correlation.gif)

<span data-ttu-id="57b4d-160">為了取得前述的追蹤，我們將使用者追蹤來源設定為 `ActivityTracing`，而將 `propagateActivity=true` 追蹤來源設定為 `System.ServiceModel`。</span><span class="sxs-lookup"><span data-stu-id="57b4d-160">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="57b4d-161">我們並未將 `ActivityTracing` 設定給 `System.ServiceModel` 追蹤來源，來讓使用者程式碼使用使用者程式碼活動傳播 </span><span class="sxs-lookup"><span data-stu-id="57b4d-161">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="57b4d-162">（當 System.servicemodel 活動追蹤為開啟時，用戶端中定義的活動識別碼不會傳播到服務使用者程式碼;不過，傳輸會讓用戶端和服務使用者程式碼活動與中繼 WCF 活動相互關聯）。</span><span class="sxs-lookup"><span data-stu-id="57b4d-162">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate WCF activities.)</span></span>

<span data-ttu-id="57b4d-163">定義活動和傳播活動識別碼可讓我們在端點之間執行直接錯誤相互關聯。</span><span class="sxs-lookup"><span data-stu-id="57b4d-163">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="57b4d-164">如此一來，就可以更迅速地找到錯誤的根本原因。</span><span class="sxs-lookup"><span data-stu-id="57b4d-164">In this way, we can locate the root cause of an error more quickly.</span></span>

## <a name="see-also"></a><span data-ttu-id="57b4d-165">請參閱</span><span class="sxs-lookup"><span data-stu-id="57b4d-165">See also</span></span>

- [<span data-ttu-id="57b4d-166">擴充追蹤</span><span class="sxs-lookup"><span data-stu-id="57b4d-166">Extending Tracing</span></span>](../../samples/extending-tracing.md)
