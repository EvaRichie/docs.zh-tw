---
title: 設定訊息流程追蹤
ms.date: 03/30/2017
ms.assetid: 15571ca2-bee2-47fb-ba10-fcbc09152ad0
ms.openlocfilehash: 6c271c26eb4e57014b3aaebf306b283bd06c7119
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/26/2020
ms.locfileid: "96254879"
---
# <a name="configuring-message-flow-tracing"></a><span data-ttu-id="74a21-102">設定訊息流程追蹤</span><span class="sxs-lookup"><span data-stu-id="74a21-102">Configuring Message Flow Tracing</span></span>

<span data-ttu-id="74a21-103">當 Windows Communication Foundation 啟用 (WCF) 活動追蹤時，會將端對端活動識別碼指派給整個 WCF 堆疊中的邏輯活動。</span><span class="sxs-lookup"><span data-stu-id="74a21-103">When Windows Communication Foundation (WCF) activity tracing is enabled, End-To-End Activity IDs are assigned to logical activities throughout the WCF stack.</span></span> <span data-ttu-id="74a21-104">現在，[!INCLUDE[netfx_current_short](../../../../../includes/netfx-current-short-md.md)] 針對這項功能提供了具備更高效能且可搭配 Windows 事件追蹤 (ETW) 使用的版本，也就是所謂的訊息流程追蹤。</span><span class="sxs-lookup"><span data-stu-id="74a21-104">In [!INCLUDE[netfx_current_short](../../../../../includes/netfx-current-short-md.md)], there is now a higher performance version of this feature that works with Event Tracing for Windows (ETW) called message flow tracing.</span></span> <span data-ttu-id="74a21-105">啟用之後，就會取得傳入訊息的端對端活動識別碼 (若是空的則會指派)，並且傳播給在通道將訊息解碼之後發出的所有追蹤事件。</span><span class="sxs-lookup"><span data-stu-id="74a21-105">When enabled, End-To-End activity IDs are taken from (or assigned to if empty) incoming messages and are propagated to all tracing events that are emitted after the message has been decoded by the channel.</span></span> <span data-ttu-id="74a21-106">在解碼之後，客戶可以使用這項功能，利用來自不同服務的追蹤記錄重新建構訊息流程。</span><span class="sxs-lookup"><span data-stu-id="74a21-106">Customers can use this feature to reconstruct message flows with trace logs from different services after decoding.</span></span>  
  
 <span data-ttu-id="74a21-107">偵測到應用程式的問題之後，可以啟用追蹤，等到問題解決再停用追蹤。</span><span class="sxs-lookup"><span data-stu-id="74a21-107">Tracing can be enabled after a problem is detected with the application and then disabled once the problem is resolved.</span></span>  
  
## <a name="enabling-tracing"></a><span data-ttu-id="74a21-108">啟用追蹤</span><span class="sxs-lookup"><span data-stu-id="74a21-108">Enabling Tracing</span></span>  

 <span data-ttu-id="74a21-109">若要啟用訊息流程追蹤，請將 .NET Framework 4 `messageFlowTracing` 組態項目設定為 `true`，如以下範例所示。</span><span class="sxs-lookup"><span data-stu-id="74a21-109">You can enable message flow tracing by setting the .NET Framework 4 `messageFlowTracing` configuration element to `true`, as shown in the following example.</span></span>  
  
```xml  
<system.servicemodel>  
  <diagnostics>  
    <endToEndTracing propagateActivity="true" messageFlowTracing="true" />  
  </diagnostics>  
</system.servicemodel>  
```  
  
> [!NOTE]
> <span data-ttu-id="74a21-110">由於 `endToEndTracing` 組態項目位於 Web.config 檔案中，所以不能像 ETW 那樣利用動態方式設定。</span><span class="sxs-lookup"><span data-stu-id="74a21-110">Because the `endToEndTracing` configuration element resides in a Web.config file, it cannot be dynamically configured in the same way as ETW.</span></span> <span data-ttu-id="74a21-111">應用程式必須先進行回收，`endToEndTracing` 組態項目才會生效。</span><span class="sxs-lookup"><span data-stu-id="74a21-111">For the `endToEndTracing` configuration element to take effect, the application must be recycled.</span></span>  
  
 <span data-ttu-id="74a21-112">活動會透過交換識別碼 (稱為活動識別碼) 建立相互關聯。</span><span class="sxs-lookup"><span data-stu-id="74a21-112">Activities are correlated by the interchange of an identifier called the activity ID.</span></span> <span data-ttu-id="74a21-113">這個識別碼是 GUID，由 System.Diagnostics.CorrelationManager 類別所產生。</span><span class="sxs-lookup"><span data-stu-id="74a21-113">This identifier is a GUID, and is generated by the System.Diagnostics.CorrelationManager class.</span></span> <span data-ttu-id="74a21-114">如果您要操作 System.Diagnostics.Trace.CorrelationManager.ActivityID，請確定此值在執行控制權傳回給 WCF 程式碼時設定為原始值。</span><span class="sxs-lookup"><span data-stu-id="74a21-114">If you manipulate System.Diagnostics.Trace.CorrelationManager.ActivityID, ensure that the value is set to original when execution control transfers back to WCF code.</span></span>  <span data-ttu-id="74a21-115">此外，如果您要使用非同步 WCF 程式撰寫模型，請確定 System.Diagnostics.Trace.CorrelationManager.ActivityID 會在執行緒之間傳輸。</span><span class="sxs-lookup"><span data-stu-id="74a21-115">Also, if you use an asynchronous WCF programming model ensure that System.Diagnostics.Trace.CorrelationManager.ActivityID is transferred between the threads.</span></span>  
  
## <a name="message-flow-tracing-and-rest-services"></a><span data-ttu-id="74a21-116">訊息流程追蹤和 REST 服務</span><span class="sxs-lookup"><span data-stu-id="74a21-116">Message Flow Tracing and REST Services</span></span>  

 <span data-ttu-id="74a21-117">訊息流程追蹤可讓您端對端地追蹤要求。</span><span class="sxs-lookup"><span data-stu-id="74a21-117">Message flow tracing allows you to trace a request end to end.</span></span>  <span data-ttu-id="74a21-118">透過 SOAP 服務，在 SOAP 訊息標頭中傳送活動 ID。</span><span class="sxs-lookup"><span data-stu-id="74a21-118">With SOAP-based services an Activity ID is sent in a SOAP message header.</span></span> <span data-ttu-id="74a21-119">REST 要求不包含此標頭，因此會改用特殊 HTTP 事件標頭。</span><span class="sxs-lookup"><span data-stu-id="74a21-119">REST requests do not contain this header so a special HTTP event header is used instead.</span></span> <span data-ttu-id="74a21-120">下列程式碼片段顯示如何以程式設計方式擷取活動 ID 值：</span><span class="sxs-lookup"><span data-stu-id="74a21-120">The following code snippet shows how you can programmatically retrieve the Activity ID value:</span></span>  
  
```csharp
Object output = null;
if (OperationContext.Current.IncomingMessageProperties.TryGetValue(HttpRequestMessageProperty.Name, out output))
{
   HttpRequestMessageProperty httpHeaders = output as HttpRequestMessageProperty;
   // Retrieve the Activity Id from the HTTP header    string e2eId = httpHeaders.Headers["E2EActivity"];
   // ...
}
```

 <span data-ttu-id="74a21-121">您可以使用下列程式碼，以程式設計方式加入標頭：</span><span class="sxs-lookup"><span data-stu-id="74a21-121">You can programmatically add the header using the following code:</span></span>  
  
```csharp  
HttpContent content = new StreamContent(contentStream);  
Guid correlation = Guid.NewGuid();  
content.Headers.Add("E2EActivity", Convert.ToBase64String(correlation.ToByteArray()));  
```
