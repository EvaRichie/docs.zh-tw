---
title: 伺服器端 UI 自動化提供者實作
description: 瞭解如何在 .NET 中為自訂控制項執行伺服器端 UI 自動化提供者。 WPF 和非 WPF 元素的執行方式不同。
ms.date: 03/30/2017
helpviewer_keywords:
- server-side UI Automation provider implementation
- UI Automation, server-side provider implementation
- provider implementation, UI Automation
ms.assetid: 6acc6d08-bd67-4e2e-915c-9c1d34eb86fe
ms.openlocfilehash: ea1b5e668e29d854233d4dde4c0e6152d591da97
ms.sourcegitcommit: 3824ff187947572b274b9715b60c11269335c181
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/17/2020
ms.locfileid: "84903892"
---
# <a name="server-side-ui-automation-provider-implementation"></a><span data-ttu-id="56a3f-104">伺服器端 UI 自動化提供者實作</span><span class="sxs-lookup"><span data-stu-id="56a3f-104">Server-Side UI Automation Provider Implementation</span></span>

> [!NOTE]
> <span data-ttu-id="56a3f-105">這份文件適用於想要使用 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 命名空間中定義之 Managed <xref:System.Windows.Automation> 類別的 .NET Framework 開發人員。</span><span class="sxs-lookup"><span data-stu-id="56a3f-105">This documentation is intended for .NET Framework developers who want to use the managed [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] classes defined in the <xref:System.Windows.Automation> namespace.</span></span> <span data-ttu-id="56a3f-106">如需 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)]的最新資訊，請參閱 [Windows Automation API：UI 自動化](/windows/win32/winauto/entry-uiauto-win32)。</span><span class="sxs-lookup"><span data-stu-id="56a3f-106">For the latest information about [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)], see [Windows Automation API: UI Automation](/windows/win32/winauto/entry-uiauto-win32).</span></span>

<span data-ttu-id="56a3f-107">本節描述如何為自訂控制項實作伺服器端使用者介面自動化提供者。</span><span class="sxs-lookup"><span data-stu-id="56a3f-107">This section describes how to implement a server-side UI Automation provider for a custom control.</span></span>

<span data-ttu-id="56a3f-108">Windows Presentation Foundation （WPF）專案和非 WPF 專案的執行（例如針對 Windows Forms 所設計的元素）基本上不同。</span><span class="sxs-lookup"><span data-stu-id="56a3f-108">The implementation for Windows Presentation Foundation (WPF) elements and non-WPF elements (such as those designed for Windows Forms) is fundamentally different.</span></span> <span data-ttu-id="56a3f-109">WPF 元素 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 透過衍生自的類別提供的支援 <xref:System.Windows.Automation.Peers.AutomationPeer> 。</span><span class="sxs-lookup"><span data-stu-id="56a3f-109">WPF elements provide support for [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] through a class derived from <xref:System.Windows.Automation.Peers.AutomationPeer>.</span></span> <span data-ttu-id="56a3f-110">非 WPF 元素會透過提供者介面的實現來提供支援。</span><span class="sxs-lookup"><span data-stu-id="56a3f-110">Non-WPF elements provide support through implementations of provider interfaces.</span></span>

<a name="Security_Considerations"></a>

## <a name="security-considerations"></a><span data-ttu-id="56a3f-111">安全性考量</span><span class="sxs-lookup"><span data-stu-id="56a3f-111">Security Considerations</span></span>

<span data-ttu-id="56a3f-112">應該寫入提供者，以便他們可在部分信任環境中運作。</span><span class="sxs-lookup"><span data-stu-id="56a3f-112">Providers should be written so that they can work in a partial-trust environment.</span></span> <span data-ttu-id="56a3f-113">因為 UIAutomationClient.dll 未設定為在部分信任下執行，所以您的提供者程式碼不應該參考該組件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-113">Because UIAutomationClient.dll is not configured to run under partial trust, your provider code should not reference that assembly.</span></span> <span data-ttu-id="56a3f-114">如果這樣做，程式碼可在完全信任環境中執行，但無法在部分信任環境中執行。</span><span class="sxs-lookup"><span data-stu-id="56a3f-114">If it does so, the code may run in a full-trust environment but then fail in a partial-trust environment.</span></span>

<span data-ttu-id="56a3f-115">尤其，不要使用來自 UIAutomationClient.dll 中類別的欄位，例如 <xref:System.Windows.Automation.AutomationElement>中的欄位。</span><span class="sxs-lookup"><span data-stu-id="56a3f-115">In particular, do not use fields from classes in UIAutomationClient.dll such as those in <xref:System.Windows.Automation.AutomationElement>.</span></span> <span data-ttu-id="56a3f-116">請改用來自 UIAutomationTypes.dll 中類別的對等欄位，例如 <xref:System.Windows.Automation.AutomationElementIdentifiers>。</span><span class="sxs-lookup"><span data-stu-id="56a3f-116">Instead, use the equivalent fields from classes in UIAutomationTypes.dll, such as <xref:System.Windows.Automation.AutomationElementIdentifiers>.</span></span>

<a name="Provider_Implementation_by_WPF_Elements"></a>

## <a name="provider-implementation-by-windows-presentation-foundation-elements"></a><span data-ttu-id="56a3f-117">依 Windows Presentation Foundation 項目的提供者實作</span><span class="sxs-lookup"><span data-stu-id="56a3f-117">Provider Implementation by Windows Presentation Foundation Elements</span></span>

<span data-ttu-id="56a3f-118">如需本主題的詳細資訊，請參閱 [WPF 自訂控制項的 UI 自動化](../wpf/controls/ui-automation-of-a-wpf-custom-control.md)。</span><span class="sxs-lookup"><span data-stu-id="56a3f-118">For more information on this topic, please see [UI Automation of a WPF Custom Control](../wpf/controls/ui-automation-of-a-wpf-custom-control.md).</span></span>

<a name="Provider_Implementation_by_non_WPF_Elements"></a>

## <a name="provider-implementation-by-non-wpf-elements"></a><span data-ttu-id="56a3f-119">依非 WPF 項目的提供者實作</span><span class="sxs-lookup"><span data-stu-id="56a3f-119">Provider Implementation by non-WPF Elements</span></span>

<span data-ttu-id="56a3f-120">不屬於 WPF 架構的自訂控制項，但是以 managed 程式碼撰寫的（最常見的是 Windows Forms 控制項），藉由執行介面來提供的支援 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="56a3f-120">Custom controls that are not part of the WPF framework, but that are written in managed code (most often these are Windows Forms controls), provide support for [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] by implementing interfaces.</span></span> <span data-ttu-id="56a3f-121">每個項目必須至少實作下一節中第一個資料表列出的其中一個介面。</span><span class="sxs-lookup"><span data-stu-id="56a3f-121">Every element must implement at least one of the interfaces listed in the first table in the next section.</span></span> <span data-ttu-id="56a3f-122">此外，如果項目支援一或多個控制項模式，它必須針對每個控制項模式實作適當的介面。</span><span class="sxs-lookup"><span data-stu-id="56a3f-122">In addition, if the element supports one or more control patterns, it must implement the appropriate interface for each control pattern.</span></span>

<span data-ttu-id="56a3f-123">您的 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 提供者專案必須參考下列組件：</span><span class="sxs-lookup"><span data-stu-id="56a3f-123">Your [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] provider project must reference the following assemblies:</span></span>

- <span data-ttu-id="56a3f-124">UIAutomationProviders.dll</span><span class="sxs-lookup"><span data-stu-id="56a3f-124">UIAutomationProviders.dll</span></span>

- <span data-ttu-id="56a3f-125">UIAutomationTypes.dll</span><span class="sxs-lookup"><span data-stu-id="56a3f-125">UIAutomationTypes.dll</span></span>

- <span data-ttu-id="56a3f-126">WindowsBase.dll</span><span class="sxs-lookup"><span data-stu-id="56a3f-126">WindowsBase.dll</span></span>

<a name="Provider_Interfaces"></a>

### <a name="provider-interfaces"></a><span data-ttu-id="56a3f-127">提供者介面</span><span class="sxs-lookup"><span data-stu-id="56a3f-127">Provider Interfaces</span></span>

<span data-ttu-id="56a3f-128">每個 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 提供者必須實作下列其中一個介面。</span><span class="sxs-lookup"><span data-stu-id="56a3f-128">Every [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] provider must implement one of the following interfaces.</span></span>

|<span data-ttu-id="56a3f-129">介面</span><span class="sxs-lookup"><span data-stu-id="56a3f-129">Interface</span></span>|<span data-ttu-id="56a3f-130">描述</span><span class="sxs-lookup"><span data-stu-id="56a3f-130">Description</span></span>|
|---------------|-----------------|
|<xref:System.Windows.Automation.Provider.IRawElementProviderSimple>|<span data-ttu-id="56a3f-131">提供功能給裝載在視窗中的簡單控制項，包括支援控制項模式和屬性。</span><span class="sxs-lookup"><span data-stu-id="56a3f-131">Provides functionality for a simple control hosted in a window, including support for control patterns and properties.</span></span>|
|<xref:System.Windows.Automation.Provider.IRawElementProviderFragment>|<span data-ttu-id="56a3f-132">繼承自 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple>。</span><span class="sxs-lookup"><span data-stu-id="56a3f-132">Inherits from <xref:System.Windows.Automation.Provider.IRawElementProviderSimple>.</span></span> <span data-ttu-id="56a3f-133">為複雜控制項中的項目新增功能，包括在片段內導覽、設定焦點，以及傳回項目的週框。</span><span class="sxs-lookup"><span data-stu-id="56a3f-133">Adds functionality for an element in a complex control, including navigation within the fragment, setting focus, and returning the bounding rectangle of the element.</span></span>|
|<xref:System.Windows.Automation.Provider.IRawElementProviderFragmentRoot>|<span data-ttu-id="56a3f-134">繼承自 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment>。</span><span class="sxs-lookup"><span data-stu-id="56a3f-134">Inherits from <xref:System.Windows.Automation.Provider.IRawElementProviderFragment>.</span></span> <span data-ttu-id="56a3f-135">為複雜控制項中的根項目新增功能，包括在指定的座標尋找子項目，以及設定整個控制項的焦點狀態。</span><span class="sxs-lookup"><span data-stu-id="56a3f-135">Adds functionality for the root element in a complex control, including locating a child element at specified coordinates and setting the focus state for the entire control.</span></span>|

<span data-ttu-id="56a3f-136">下列介面提供新增的功能，但不需要實作。</span><span class="sxs-lookup"><span data-stu-id="56a3f-136">The following interfaces provide added functionality but are not required to be implemented.</span></span>

|<span data-ttu-id="56a3f-137">介面</span><span class="sxs-lookup"><span data-stu-id="56a3f-137">Interface</span></span>|<span data-ttu-id="56a3f-138">描述</span><span class="sxs-lookup"><span data-stu-id="56a3f-138">Description</span></span>|
|---------------|-----------------|
|<xref:System.Windows.Automation.Provider.IRawElementProviderAdviseEvents>|<span data-ttu-id="56a3f-139">可讓提供者追蹤事件的要求。</span><span class="sxs-lookup"><span data-stu-id="56a3f-139">Enables the provider to track requests for events.</span></span>|
|<xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride>|<span data-ttu-id="56a3f-140">可讓以視窗為基礎的項目在片段的 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 樹狀結構內重新定位。</span><span class="sxs-lookup"><span data-stu-id="56a3f-140">Enables repositioning of window-based elements within the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree of a fragment.</span></span>|

<span data-ttu-id="56a3f-141"><xref:System.Windows.Automation.Provider> 命名空間中的其他所有介面則是用於控制項模式支援。</span><span class="sxs-lookup"><span data-stu-id="56a3f-141">All other interfaces in the <xref:System.Windows.Automation.Provider> namespace are for control pattern support.</span></span>

<a name="Requirements_for_Non_WPF_Providers"></a>

### <a name="requirements-for-non-wpf-providers"></a><span data-ttu-id="56a3f-142">非 WPF 提供者的需求</span><span class="sxs-lookup"><span data-stu-id="56a3f-142">Requirements for Non-WPF Providers</span></span>

<span data-ttu-id="56a3f-143">若要與 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)]通訊，您的控制項必須實作下列主要功能領域：</span><span class="sxs-lookup"><span data-stu-id="56a3f-143">In order to communicate with [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)], your control must implement the following main areas of functionality:</span></span>

|<span data-ttu-id="56a3f-144">功能</span><span class="sxs-lookup"><span data-stu-id="56a3f-144">Functionality</span></span>|<span data-ttu-id="56a3f-145">實作</span><span class="sxs-lookup"><span data-stu-id="56a3f-145">Implementation</span></span>|
|-------------------|--------------------|
|<span data-ttu-id="56a3f-146">將提供者公開至 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)]</span><span class="sxs-lookup"><span data-stu-id="56a3f-146">Expose the provider to [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)]</span></span>|<span data-ttu-id="56a3f-147">在回應傳送至控制項視窗的 WM_GETOBJECT 訊息時，傳回實作 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple> 的物件 (或衍生的介面)。</span><span class="sxs-lookup"><span data-stu-id="56a3f-147">In response to a WM_GETOBJECT message sent to the control window, return the object that implements <xref:System.Windows.Automation.Provider.IRawElementProviderSimple> (or a derived interface).</span></span> <span data-ttu-id="56a3f-148">對於片段，這必須是片段根的提供者。</span><span class="sxs-lookup"><span data-stu-id="56a3f-148">For fragments, this must be the provider for the fragment root.</span></span>|
|<span data-ttu-id="56a3f-149">提供屬性值</span><span class="sxs-lookup"><span data-stu-id="56a3f-149">Provide property values</span></span>|<span data-ttu-id="56a3f-150">實作 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.GetPropertyValue%2A> 來提供或覆寫值。</span><span class="sxs-lookup"><span data-stu-id="56a3f-150">Implement <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.GetPropertyValue%2A> to provide or override values.</span></span>|
|<span data-ttu-id="56a3f-151">可讓用戶端與控制項互動</span><span class="sxs-lookup"><span data-stu-id="56a3f-151">Enable the client to interact with the control</span></span>|<span data-ttu-id="56a3f-152">實作支援控制模式的介面，例如 <xref:System.Windows.Automation.Provider.IInvokeProvider>。</span><span class="sxs-lookup"><span data-stu-id="56a3f-152">Implement interfaces that support control patterns, such as <xref:System.Windows.Automation.Provider.IInvokeProvider>.</span></span> <span data-ttu-id="56a3f-153">實作 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.GetPatternProvider%2A>時傳回這些模式提供者。</span><span class="sxs-lookup"><span data-stu-id="56a3f-153">Return these pattern providers in your implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.GetPatternProvider%2A>.</span></span>|
|<span data-ttu-id="56a3f-154">引發事件</span><span class="sxs-lookup"><span data-stu-id="56a3f-154">Raise events</span></span>|<span data-ttu-id="56a3f-155">呼叫 <xref:System.Windows.Automation.Provider.AutomationInteropProvider> 的其中一個靜態方法，來引發用戶端可以接聽的事件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-155">Call one of the static methods of <xref:System.Windows.Automation.Provider.AutomationInteropProvider> to raise an event that a client can listen for.</span></span>|
|<span data-ttu-id="56a3f-156">在片段內啟用導覽和聚焦功能</span><span class="sxs-lookup"><span data-stu-id="56a3f-156">Enable navigation and focusing within a fragment</span></span>|<span data-ttu-id="56a3f-157">為片段內的每個項目實作 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment> 。</span><span class="sxs-lookup"><span data-stu-id="56a3f-157">Implement <xref:System.Windows.Automation.Provider.IRawElementProviderFragment> for each element within the fragment.</span></span> <span data-ttu-id="56a3f-158">(項目若不屬於片段，則不需要)。</span><span class="sxs-lookup"><span data-stu-id="56a3f-158">(Not necessary for elements that are not part of a fragment.)</span></span>|
|<span data-ttu-id="56a3f-159">可讓您在片段中將焦點放在子項目和尋找子項目</span><span class="sxs-lookup"><span data-stu-id="56a3f-159">Enable focusing and location of child element in a fragment</span></span>|<span data-ttu-id="56a3f-160">實作 <xref:System.Windows.Automation.Provider.IRawElementProviderFragmentRoot>。</span><span class="sxs-lookup"><span data-stu-id="56a3f-160">Implement <xref:System.Windows.Automation.Provider.IRawElementProviderFragmentRoot>.</span></span> <span data-ttu-id="56a3f-161">(項目若不是片段根，則不需要)。</span><span class="sxs-lookup"><span data-stu-id="56a3f-161">(Not necessary for elements that are not fragment roots.)</span></span>|

<a name="Property_Values_in_Non_WPF_Providers"></a>

### <a name="property-values-in-non-wpf-providers"></a><span data-ttu-id="56a3f-162">非 WPF 提供者中的屬性值</span><span class="sxs-lookup"><span data-stu-id="56a3f-162">Property Values in Non-WPF Providers</span></span>

<span data-ttu-id="56a3f-163">自訂控制項的[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 提供者必須支援某些屬性，而這些屬性可由自動化系統以及用戶端應用程式使用。</span><span class="sxs-lookup"><span data-stu-id="56a3f-163">[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] providers for custom controls must support certain properties that can be used by the automation system as well as by client applications.</span></span> <span data-ttu-id="56a3f-164">對於裝載於視窗 (HWND) 的項目， [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 可以從預設視窗提供者擷取某些屬性，但必須從自訂提供者取得其他屬性。</span><span class="sxs-lookup"><span data-stu-id="56a3f-164">For elements that are hosted in windows (HWNDs), [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] can retrieve some properties from the default window provider, but must obtain others from the custom provider.</span></span>

<span data-ttu-id="56a3f-165">以 HWND 為基礎的控制項的提供者通常不需要提供下列屬性 (以欄位值識別)：</span><span class="sxs-lookup"><span data-stu-id="56a3f-165">Providers for HWND based controls do not usually need to provide the following properties (identified by field values):</span></span>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.BoundingRectangleProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.ClickablePointProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.ProcessIdProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.ClassNameProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.HasKeyboardFocusProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.IsEnabledProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.IsKeyboardFocusableProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.IsPasswordProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.NameProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.RuntimeIdProperty>

> [!NOTE]
> <span data-ttu-id="56a3f-166">簡單項目的 <xref:System.Windows.Automation.AutomationElementIdentifiers.RuntimeIdProperty> 或裝載在視窗中之片段根的項目取自於視窗；不過，根之下的片段項目 (例如清單方塊中的清單項目) 必須提供自己的識別項。</span><span class="sxs-lookup"><span data-stu-id="56a3f-166">The <xref:System.Windows.Automation.AutomationElementIdentifiers.RuntimeIdProperty> of a simple element or fragment root hosted in a window is obtained from the window; however, fragment elements below the root (such as list items in a list box) must provide their own identifiers.</span></span> <span data-ttu-id="56a3f-167">如需詳細資訊，請參閱 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.GetRuntimeId%2A>。</span><span class="sxs-lookup"><span data-stu-id="56a3f-167">For more information, see <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.GetRuntimeId%2A>.</span></span>
>
> <span data-ttu-id="56a3f-168"><xref:System.Windows.Automation.AutomationElementIdentifiers.IsKeyboardFocusableProperty>應該針對 Windows Forms 控制項中裝載的提供者傳回。</span><span class="sxs-lookup"><span data-stu-id="56a3f-168">The <xref:System.Windows.Automation.AutomationElementIdentifiers.IsKeyboardFocusableProperty> should be returned for providers hosted in a Windows Forms control.</span></span> <span data-ttu-id="56a3f-169">在此情況下，預設視窗提供者可能無法擷取正確值。</span><span class="sxs-lookup"><span data-stu-id="56a3f-169">In this case, the default window provider may be unable to retrieve the correct value.</span></span>
>
> <span data-ttu-id="56a3f-170"><xref:System.Windows.Automation.AutomationElementIdentifiers.NameProperty> 通常由主機提供者所提供。</span><span class="sxs-lookup"><span data-stu-id="56a3f-170">The <xref:System.Windows.Automation.AutomationElementIdentifiers.NameProperty> is usually supplied by the host provider.</span></span> <span data-ttu-id="56a3f-171">例如，如果自訂控制項衍生自 <xref:System.Windows.Forms.Control>，則名稱衍生自控制項的 `Text` 屬性。</span><span class="sxs-lookup"><span data-stu-id="56a3f-171">For example, if a custom control is derived from <xref:System.Windows.Forms.Control>, the name is derived from the `Text` property of the control.</span></span>

<span data-ttu-id="56a3f-172">如需範例程式碼，請參閱 [Return Properties from a UI Automation Provider](return-properties-from-a-ui-automation-provider.md)。</span><span class="sxs-lookup"><span data-stu-id="56a3f-172">For example code, see [Return Properties from a UI Automation Provider](return-properties-from-a-ui-automation-provider.md).</span></span>

<a name="Events_in_Non_WPF_Providers"></a>

### <a name="events-in-non-wpf-providers"></a><span data-ttu-id="56a3f-173">非 WPF 提供者中的事件</span><span class="sxs-lookup"><span data-stu-id="56a3f-173">Events in Non-WPF Providers</span></span>

[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] <span data-ttu-id="56a3f-174">提供者應該引發事件，將 UI 狀態中的變更通知用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="56a3f-174">providers should raise events to notify client applications of changes in the state of the UI.</span></span> <span data-ttu-id="56a3f-175">下列方法會用於引發事件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-175">The following methods are used to raise events.</span></span>

|<span data-ttu-id="56a3f-176">方法</span><span class="sxs-lookup"><span data-stu-id="56a3f-176">Method</span></span>|<span data-ttu-id="56a3f-177">描述</span><span class="sxs-lookup"><span data-stu-id="56a3f-177">Description</span></span>|
|------------|-----------------|
|<xref:System.Windows.Automation.Provider.AutomationInteropProvider.RaiseAutomationEvent%2A>|<span data-ttu-id="56a3f-178">引發各種事件，包括由控制項模式觸發的事件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-178">Raises various events, including events triggered by control patterns.</span></span>|
|<xref:System.Windows.Automation.Provider.AutomationInteropProvider.RaiseAutomationPropertyChangedEvent%2A>|<span data-ttu-id="56a3f-179">[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 屬性變更後，即會引發事件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-179">Raises an event when a [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] property has changed.</span></span>|
|<xref:System.Windows.Automation.Provider.AutomationInteropProvider.RaiseStructureChangedEvent%2A>|<span data-ttu-id="56a3f-180">[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 樹狀結構的結構變更後，即會引發事件，例如，移除或加入項目。</span><span class="sxs-lookup"><span data-stu-id="56a3f-180">Raises an event when the structure of the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree has changed; for example, by the removal or addition of an element.</span></span>|

<span data-ttu-id="56a3f-181">事件的目的是通知用戶端 [!INCLUDE[TLA#tla_ui](../../../includes/tlasharptla-ui-md.md)]中發生某種情況，活動是否由 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 系統本身觸發。</span><span class="sxs-lookup"><span data-stu-id="56a3f-181">The purpose of an event is to notify the client of something taking place in the [!INCLUDE[TLA#tla_ui](../../../includes/tlasharptla-ui-md.md)], whether or not the activity is triggered by the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] system itself.</span></span> <span data-ttu-id="56a3f-182">例如，每當透過直接使用者輸入，或是藉由呼叫 <xref:System.Windows.Automation.InvokePatternIdentifiers.InvokedEvent> 的應用程式叫用控制項時，應該引發 <xref:System.Windows.Automation.InvokePattern.Invoke%2A>所識別的事件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-182">For example, the event identified by <xref:System.Windows.Automation.InvokePatternIdentifiers.InvokedEvent> should be raised whenever the control is invoked, either through direct user input or by the client application calling <xref:System.Windows.Automation.InvokePattern.Invoke%2A>.</span></span>

<span data-ttu-id="56a3f-183">若要最佳化效能，提供者可以選擇性地引發事件，或如果沒有註冊任何用戶端應用程式來接收事件，則完全不引發任何事件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-183">To optimize performance, a provider can selectively raise events, or raise no events at all if no client application is registered to receive them.</span></span> <span data-ttu-id="56a3f-184">下列方法會用於最佳化。</span><span class="sxs-lookup"><span data-stu-id="56a3f-184">The following methods are used for optimization.</span></span>

|<span data-ttu-id="56a3f-185">方法</span><span class="sxs-lookup"><span data-stu-id="56a3f-185">Method</span></span>|<span data-ttu-id="56a3f-186">描述</span><span class="sxs-lookup"><span data-stu-id="56a3f-186">Description</span></span>|
|------------|-----------------|
|<xref:System.Windows.Automation.Provider.AutomationInteropProvider.ClientsAreListening%2A>|<span data-ttu-id="56a3f-187">這個靜態屬性會指定是否有任何用戶端應用程式已訂閱 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 事件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-187">This static property specifies whether any client applications have subscribed to [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] events.</span></span>|
|<xref:System.Windows.Automation.Provider.IRawElementProviderAdviseEvents>|<span data-ttu-id="56a3f-188">提供者在片段根上實作此介面，可讓提供者在用戶端針對片段上的事件註冊和取消註冊事件處理常式時接到通知。</span><span class="sxs-lookup"><span data-stu-id="56a3f-188">The provider's implementation of this interface on a fragment root enables it to be advised when clients register and unregister event handlers for events on the fragment.</span></span>|

<a name="Non_WPF_Provider_Navigation"></a>

### <a name="non-wpf-provider-navigation"></a><span data-ttu-id="56a3f-189">非 WPF 提供者導覽</span><span class="sxs-lookup"><span data-stu-id="56a3f-189">Non-WPF Provider Navigation</span></span>

<span data-ttu-id="56a3f-190">簡單控制項 (例如裝載於視窗 (HWND) 的自訂按鈕) 的提供者不需要支援 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 樹狀結構內的導覽。</span><span class="sxs-lookup"><span data-stu-id="56a3f-190">Providers for simple controls such as a custom button hosted in a window (HWND) do not need to support navigation within the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree.</span></span> <span data-ttu-id="56a3f-191">項目之間的導覽是由主控視窗的預設提供者處理，而預設提供者則於 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>的實作中指定。</span><span class="sxs-lookup"><span data-stu-id="56a3f-191">Navigation to and from the element is handled by the default provider for the host window, which is specified in the implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>.</span></span> <span data-ttu-id="56a3f-192">不過，當您實作複雜自訂控制項的提供者時，您必須支援片段的根節點與子系之間的導覽，以及同層級節點之間的導覽。</span><span class="sxs-lookup"><span data-stu-id="56a3f-192">When you implement a provider for a complex custom control, however, you must support navigation between the root node of the fragment and its descendants, and between sibling nodes.</span></span>

> [!NOTE]
> <span data-ttu-id="56a3f-193">根以外的片段項目必須從 `null` 傳回 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>參考，因為它們不會直接裝載在視窗中，而且沒有預設提供者可支援項目之間的導覽。</span><span class="sxs-lookup"><span data-stu-id="56a3f-193">Elements of a fragment other than the root must return a `null` reference  from <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>, because they are not directly hosted in a window, and no default provider can support navigation to and from them.</span></span>

<span data-ttu-id="56a3f-194">片段的結構取決於您的 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.Navigate%2A>實作。</span><span class="sxs-lookup"><span data-stu-id="56a3f-194">The structure of the fragment is determined by your implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.Navigate%2A>.</span></span> <span data-ttu-id="56a3f-195">對於每個片段的可能方向，此方法會傳回該方向中項目的提供者物件。</span><span class="sxs-lookup"><span data-stu-id="56a3f-195">For each possible direction from each fragment, this method returns the provider object for the element in that direction.</span></span> <span data-ttu-id="56a3f-196">如果該方向中沒有任何項目，此方法會傳回 `null` 參考。</span><span class="sxs-lookup"><span data-stu-id="56a3f-196">If there is no element in that direction, the method returns a `null` reference.</span></span>

<span data-ttu-id="56a3f-197">片段根僅支援導覽至子項目。</span><span class="sxs-lookup"><span data-stu-id="56a3f-197">The fragment root supports navigation only to child elements.</span></span> <span data-ttu-id="56a3f-198">例如，當方向為 <xref:System.Windows.Automation.Provider.NavigateDirection.FirstChild>時，清單方塊會傳回清單中的第一個項目，而當方向為 <xref:System.Windows.Automation.Provider.NavigateDirection.LastChild>時，則傳回最後一個項目。</span><span class="sxs-lookup"><span data-stu-id="56a3f-198">For example, a list box returns the first item in the list when the direction is <xref:System.Windows.Automation.Provider.NavigateDirection.FirstChild>, and the last item when the direction is <xref:System.Windows.Automation.Provider.NavigateDirection.LastChild>.</span></span> <span data-ttu-id="56a3f-199">片段根目錄不支援導覽至父代或同層級；這是由主控視窗提供者處理。</span><span class="sxs-lookup"><span data-stu-id="56a3f-199">The fragment root does not support navigation to a parent or siblings; this is handled by the host window provider.</span></span>

<span data-ttu-id="56a3f-200">不是根的片段項目必須支援導覽至父代，以及導覽至任何同層級和其具有的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-200">Elements of a fragment that are not the root must support navigation to the parent, and to any siblings and children they have.</span></span>

<a name="Non_WPF_Provider_Reparenting"></a>

### <a name="non-wpf-provider-reparenting"></a><span data-ttu-id="56a3f-201">非 WPF 提供者重設父代</span><span class="sxs-lookup"><span data-stu-id="56a3f-201">Non-WPF Provider Reparenting</span></span>

<span data-ttu-id="56a3f-202">實際上快顯視窗是最上層視窗，因此預設為出現在 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 樹狀結構，以做為桌面的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-202">Pop-up windows are actually top-level windows, and so by default appear in the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree as children of the desktop.</span></span> <span data-ttu-id="56a3f-203">不過，在許多情況下，快顯視窗在邏輯上是一些其他控制項的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-203">In many cases, however, pop-up windows are logically children of some other control.</span></span> <span data-ttu-id="56a3f-204">例如，下拉式方塊的下拉式清單在邏輯上是下拉式方塊的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-204">For example, the drop-down list of a combo box is logically a child of the combo box.</span></span> <span data-ttu-id="56a3f-205">同樣地，功能表快顯視窗在邏輯上是功能表的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-205">Similarly, a menu pop-up window is logically a child of the menu.</span></span> [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] <span data-ttu-id="56a3f-206">提供支援，以重設快顯視窗的父代，讓它們看起來似乎是相關聯控制項的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-206">provides support to reparent pop-up windows so that they appear to be children of the associated control.</span></span>

<span data-ttu-id="56a3f-207">若要重設快顯視窗的父代：</span><span class="sxs-lookup"><span data-stu-id="56a3f-207">To reparent a pop-up window:</span></span>

1. <span data-ttu-id="56a3f-208">建立快顯視窗的提供者。</span><span class="sxs-lookup"><span data-stu-id="56a3f-208">Create a provider for the pop-up window.</span></span> <span data-ttu-id="56a3f-209">這需要預先知道快顯視窗的類別。</span><span class="sxs-lookup"><span data-stu-id="56a3f-209">This requires that the class of the pop-up window is known in advance.</span></span>

2. <span data-ttu-id="56a3f-210">如往常般實作該快顯視窗的所有屬性和模式，好似它本身就是控制項。</span><span class="sxs-lookup"><span data-stu-id="56a3f-210">Implement all properties and patterns as usual for that pop-up, as though it were a control in its own right.</span></span>

3. <span data-ttu-id="56a3f-211">實作 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A> 屬性，好讓它傳回取自 <xref:System.Windows.Automation.Provider.AutomationInteropProvider.HostProviderFromHandle%2A>的值，其中參數是快顯視窗的視窗控制代碼。</span><span class="sxs-lookup"><span data-stu-id="56a3f-211">Implement the <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A> property so that it returns the value obtained from <xref:System.Windows.Automation.Provider.AutomationInteropProvider.HostProviderFromHandle%2A>, where the parameter is the window handle of the pop-up window.</span></span>

4. <span data-ttu-id="56a3f-212">實作快顯視窗和其父代的 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.Navigate%2A> ，以便可以適當處理從邏輯父代到邏輯子系的導覽，以及同層級子系之間的導覽。</span><span class="sxs-lookup"><span data-stu-id="56a3f-212">Implement <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.Navigate%2A> for the pop-up window and its parent so that navigation is handled properly from the logical parent to the logical children, and between sibling children.</span></span>

<span data-ttu-id="56a3f-213">當 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 遇到快顯視窗時，它會辨識是否以預設值取代導覽，並在遇到快顯視窗為桌面的子系時，略過快顯視窗。</span><span class="sxs-lookup"><span data-stu-id="56a3f-213">When [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] encounters the pop-up window, it recognizes that navigation is being overridden from the default, and skips over the pop-up window when it is encountered as a child of the desktop.</span></span> <span data-ttu-id="56a3f-214">相反地，節點只能透過片段來連接。</span><span class="sxs-lookup"><span data-stu-id="56a3f-214">Instead, the node will only be reachable through the fragment.</span></span>

<span data-ttu-id="56a3f-215">重設父代不適合控制項可以裝載任何類別之視窗的情況。</span><span class="sxs-lookup"><span data-stu-id="56a3f-215">Reparenting is not suitable for cases where a control can host a window of any class.</span></span> <span data-ttu-id="56a3f-216">例如，rebar 可在其群組列中裝載任何類型的 HWND。</span><span class="sxs-lookup"><span data-stu-id="56a3f-216">For example, a rebar can host any type of HWND in its bands.</span></span> <span data-ttu-id="56a3f-217">為了處理這些情況， [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 支援替代形式的 HWND 重新配置，如下一節所述。</span><span class="sxs-lookup"><span data-stu-id="56a3f-217">To handle these cases, [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] supports an alternative form of HWND relocation, as described in the next section.</span></span>

<a name="Non_WPF_Provider_Repositioning"></a>

### <a name="non-wpf-provider-repositioning"></a><span data-ttu-id="56a3f-218">非 WPF 提供者重設配置</span><span class="sxs-lookup"><span data-stu-id="56a3f-218">Non-WPF Provider Repositioning</span></span>

[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] <span data-ttu-id="56a3f-219">片段可能包含兩個或多個項目，而每一個都包含在一個視窗 (HWND) 中。</span><span class="sxs-lookup"><span data-stu-id="56a3f-219">fragments may contain two or more elements that are each contained in a window (HWND).</span></span> <span data-ttu-id="56a3f-220">因為每個 HWND 都有自己的預設提供者，將 HWND 視為包含 HWND 的子系，所以 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 樹狀結構會根據預設將 HWND 顯示在片段中，做為父視窗的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-220">Because each HWND has its own default provider that considers the HWND to be a child of a containing HWND, the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree will, by default, show the HWNDs in the fragment as children of the parent window.</span></span> <span data-ttu-id="56a3f-221">在大部分情況下，這是所需的行為，但有時候，可能會造成混淆，因為它不符合 [!INCLUDE[TLA2#tla_ui](../../../includes/tla2sharptla-ui-md.md)]的邏輯結構。</span><span class="sxs-lookup"><span data-stu-id="56a3f-221">In most cases this is desirable behavior, but sometimes it can lead to confusion because it does not match the logical structure of the [!INCLUDE[TLA2#tla_ui](../../../includes/tla2sharptla-ui-md.md)].</span></span>

<span data-ttu-id="56a3f-222">rebar 控制項就是這種情況的好範例。</span><span class="sxs-lookup"><span data-stu-id="56a3f-222">A good example of this is a rebar control.</span></span> <span data-ttu-id="56a3f-223">Rebar 包含群組列，其中每一個可以輪流包含 HWND 型控制項，例如工具列、編輯方塊或下拉式方塊。</span><span class="sxs-lookup"><span data-stu-id="56a3f-223">A rebar contains bands, each of which can in turn contain an HWND-based control such as a toolbar, an edit box, or a combo box.</span></span> <span data-ttu-id="56a3f-224">Rebar HWND 的預設視窗提供者會將群組列控制項 HWND 視為子系，而且 rebar 提供者也會將群組列視為子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-224">The default window provider for the rebar HWND sees the band control HWNDs as children, and the rebar provider sees the bands as children.</span></span> <span data-ttu-id="56a3f-225">因為 HWND 提供者和 rebar 提供者會一起運作，並且結合其子系，所以群組列和 HWND 型控制項會顯示為 rebar 的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-225">Because the HWND provider and the rebar provider are working in tandem and combining their children, both the bands and the HWND-based controls appear as children of the rebar.</span></span> <span data-ttu-id="56a3f-226">不過，在邏輯上只有群組列應該顯示為 rebar 的子系，而且每個群組列提供者應該要與其包含之控制項的預設 HWND 提供者配合。</span><span class="sxs-lookup"><span data-stu-id="56a3f-226">Logically, however, only the bands should appear as children of the rebar, and each band provider should be coupled with the default HWND provider for the control it contains.</span></span>

<span data-ttu-id="56a3f-227">為了達成此目的，rebar 的片段根提供者會公開一組代表群組列的子系。</span><span class="sxs-lookup"><span data-stu-id="56a3f-227">To accomplish this, the fragment root provider for the rebar exposes a set of children representing the bands.</span></span> <span data-ttu-id="56a3f-228">每個群組列都有可能公開屬性和模式的單一提供者。</span><span class="sxs-lookup"><span data-stu-id="56a3f-228">Each band has a single provider that may expose properties and patterns.</span></span> <span data-ttu-id="56a3f-229">在實作 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>時，群組列提供者會傳回控制項 HWND 的預設視窗提供者，而取得此提供者的方式為呼叫 <xref:System.Windows.Automation.Provider.AutomationInteropProvider.HostProviderFromHandle%2A>，並傳入控制項的視窗控制代碼。</span><span class="sxs-lookup"><span data-stu-id="56a3f-229">In its implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>, the band provider returns the default window provider for the control HWND, which it obtains by calling <xref:System.Windows.Automation.Provider.AutomationInteropProvider.HostProviderFromHandle%2A>, passing in the control's window handle.</span></span> <span data-ttu-id="56a3f-230">最後，rebar 的片段根提供者會實作 <xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride> 介面，以及在實作 <xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride.GetOverrideProviderForHwnd%2A> 時，它會傳回指定的 HWND 中包含之控制項的適當群組列提供者。</span><span class="sxs-lookup"><span data-stu-id="56a3f-230">Finally, the fragment root provider for the rebar implements the <xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride> interface, and in its implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride.GetOverrideProviderForHwnd%2A> it returns the appropriate band provider for the control contained in the specified HWND.</span></span>

## <a name="see-also"></a><span data-ttu-id="56a3f-231">另請參閱</span><span class="sxs-lookup"><span data-stu-id="56a3f-231">See also</span></span>

- [<span data-ttu-id="56a3f-232">UI 自動化提供者概觀</span><span class="sxs-lookup"><span data-stu-id="56a3f-232">UI Automation Providers Overview</span></span>](ui-automation-providers-overview.md)
- [<span data-ttu-id="56a3f-233">公開伺服器端 UI 自動化提供者</span><span class="sxs-lookup"><span data-stu-id="56a3f-233">Expose a Server-side UI Automation Provider</span></span>](expose-a-server-side-ui-automation-provider.md)
- [<span data-ttu-id="56a3f-234">從 UI 自動化提供者傳回屬性</span><span class="sxs-lookup"><span data-stu-id="56a3f-234">Return Properties from a UI Automation Provider</span></span>](return-properties-from-a-ui-automation-provider.md)
- [<span data-ttu-id="56a3f-235">UI 自動化提供者引發事件</span><span class="sxs-lookup"><span data-stu-id="56a3f-235">Raise Events from a UI Automation Provider</span></span>](raise-events-from-a-ui-automation-provider.md)
- [<span data-ttu-id="56a3f-236">在 UI 自動化片段提供者中啟用導覽</span><span class="sxs-lookup"><span data-stu-id="56a3f-236">Enable Navigation in a UI Automation Fragment Provider</span></span>](enable-navigation-in-a-ui-automation-fragment-provider.md)
- [<span data-ttu-id="56a3f-237">支援 UI 自動化提供者的控制項模式</span><span class="sxs-lookup"><span data-stu-id="56a3f-237">Support Control Patterns in a UI Automation Provider</span></span>](support-control-patterns-in-a-ui-automation-provider.md)
