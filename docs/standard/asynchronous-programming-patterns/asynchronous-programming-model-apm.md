---
title: 非同步程式設計模型 (APM)
description: 瞭解 .NET 中 (APM) 的非同步程式設計模型。 探索如何開始及結束非同步作業。
ms.date: 03/30/2017
helpviewer_keywords:
- ending asynchronous operations
- starting asynchronous operations
- beginning asynchronous operations
- asynchronous programming, ending operations
- asynchronous programming
- stopping asynchronous operations
- asynchronous programming, beginning operations
ms.assetid: c9b3501e-6bc6-40f9-8efd-4b6d9e39ccf0
ms.openlocfilehash: a6e2ed06e92adffa6c8a61b27bbff994370e8b34
ms.sourcegitcommit: d8020797a6657d0fbbdff362b80300815f682f94
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/24/2020
ms.locfileid: "95722735"
---
# <a name="asynchronous-programming-model-apm"></a><span data-ttu-id="22cd7-104">非同步程式設計模型 (APM)</span><span class="sxs-lookup"><span data-stu-id="22cd7-104">Asynchronous Programming Model (APM)</span></span>

<span data-ttu-id="22cd7-105">使用 <xref:System.IAsyncResult> 設計模式的非同步作業會實作為兩種方法，一種名為 `BeginOperationName`，另一種名為 `EndOperationName`，這兩種方法分別負責開始和結束非同步作業 *OperationName*。</span><span class="sxs-lookup"><span data-stu-id="22cd7-105">An asynchronous operation that uses the <xref:System.IAsyncResult> design pattern is implemented as two methods named `BeginOperationName` and `EndOperationName` that begin and end the asynchronous operation *OperationName* respectively.</span></span> <span data-ttu-id="22cd7-106">例如， <xref:System.IO.FileStream> 類別提供 <xref:System.IO.FileStream.BeginRead%2A> 和 <xref:System.IO.FileStream.EndRead%2A> 方法，以非同步方式讀取檔案的位元組。</span><span class="sxs-lookup"><span data-stu-id="22cd7-106">For example, the <xref:System.IO.FileStream> class provides the <xref:System.IO.FileStream.BeginRead%2A> and <xref:System.IO.FileStream.EndRead%2A> methods to asynchronously read bytes from a file.</span></span> <span data-ttu-id="22cd7-107">這些方法實作 <xref:System.IO.FileStream.Read%2A> 方法的非同步版本。</span><span class="sxs-lookup"><span data-stu-id="22cd7-107">These methods implement the asynchronous version of the <xref:System.IO.FileStream.Read%2A> method.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="22cd7-108">從 .NET Framework 4 開始，工作平行程式庫會為非同步處理和平行程式設計提供新的模型。</span><span class="sxs-lookup"><span data-stu-id="22cd7-108">Starting with the .NET Framework 4, the Task Parallel Library provides a new model for asynchronous and parallel programming.</span></span> <span data-ttu-id="22cd7-109">如需詳細資訊，請參閱 [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md) 和 [Task-based Asynchronous Pattern (TAP)](task-based-asynchronous-pattern-tap.md)。</span><span class="sxs-lookup"><span data-stu-id="22cd7-109">For more information, see [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md) and [Task-based Asynchronous Pattern (TAP)](task-based-asynchronous-pattern-tap.md)).</span></span>  
  
 <span data-ttu-id="22cd7-110">呼叫 `BeginOperationName` 之後，應用程式可以繼續對進行呼叫的執行緒執行指令，而非同步作業會在不同的執行緒上執行。</span><span class="sxs-lookup"><span data-stu-id="22cd7-110">After calling `BeginOperationName`, an application can continue executing instructions on the calling thread while the asynchronous operation takes place on a different thread.</span></span> <span data-ttu-id="22cd7-111">每次呼叫 `BeginOperationName` 後，應用程式也要呼叫 `EndOperationName` 才能取得作業的結果。</span><span class="sxs-lookup"><span data-stu-id="22cd7-111">For each call to `BeginOperationName`, the application should also call `EndOperationName` to get the results of the operation.</span></span>  
  
## <a name="beginning-an-asynchronous-operation"></a><span data-ttu-id="22cd7-112">開始非同步作業</span><span class="sxs-lookup"><span data-stu-id="22cd7-112">Beginning an Asynchronous Operation</span></span>  

 <span data-ttu-id="22cd7-113">`BeginOperationName` 方法開始非同步作業 *OperationName*，並傳回實作 <xref:System.IAsyncResult> 介面的物件。</span><span class="sxs-lookup"><span data-stu-id="22cd7-113">The `BeginOperationName` method begins asynchronous operation *OperationName* and returns an object that implements the <xref:System.IAsyncResult> interface.</span></span> <span data-ttu-id="22cd7-114"><xref:System.IAsyncResult> 物件會儲存非同步作業的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="22cd7-114"><xref:System.IAsyncResult> objects store information about an asynchronous operation.</span></span> <span data-ttu-id="22cd7-115">下表顯示非同步作業的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="22cd7-115">The following table shows information about an asynchronous operation.</span></span>  
  
|<span data-ttu-id="22cd7-116">member</span><span class="sxs-lookup"><span data-stu-id="22cd7-116">Member</span></span>|<span data-ttu-id="22cd7-117">描述</span><span class="sxs-lookup"><span data-stu-id="22cd7-117">Description</span></span>|  
|------------|-----------------|  
|<xref:System.IAsyncResult.AsyncState%2A>|<span data-ttu-id="22cd7-118">選擇性的應用程式特定物件，其中包含非同步作業的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="22cd7-118">An optional application-specific object that contains information about the asynchronous operation.</span></span>|  
|<xref:System.IAsyncResult.AsyncWaitHandle%2A>|<span data-ttu-id="22cd7-119"><xref:System.Threading.WaitHandle> 可用來封鎖應用程式執行，直到非同步作業完成。</span><span class="sxs-lookup"><span data-stu-id="22cd7-119">A <xref:System.Threading.WaitHandle> that can be used to block application execution until the asynchronous operation completes.</span></span>|  
|<xref:System.IAsyncResult.CompletedSynchronously%2A>|<span data-ttu-id="22cd7-120">這個值指出，非同步作業是否是在用來呼叫 `BeginOperationName` 的執行緒上完成的，而不是在個別 <xref:System.Threading.ThreadPool> 執行緒上完成。</span><span class="sxs-lookup"><span data-stu-id="22cd7-120">A value that indicates whether the asynchronous operation completed on the thread used to call `BeginOperationName` instead of completing on a separate <xref:System.Threading.ThreadPool> thread.</span></span>|  
|<xref:System.IAsyncResult.IsCompleted%2A>|<span data-ttu-id="22cd7-121">指出非同步作業是否完成的值。</span><span class="sxs-lookup"><span data-stu-id="22cd7-121">A value that indicates whether the asynchronous operation has completed.</span></span>|  
  
 <span data-ttu-id="22cd7-122">`BeginOperationName` 方法會使用任何方法同步版本簽章中所宣告，以傳值或傳址方式傳遞的參數。</span><span class="sxs-lookup"><span data-stu-id="22cd7-122">A `BeginOperationName` method takes any parameters declared in the signature of the synchronous version of the method that are passed by value or by reference.</span></span> <span data-ttu-id="22cd7-123">任何 out 參數都不是 `BeginOperationName` 方法簽章的一部分。</span><span class="sxs-lookup"><span data-stu-id="22cd7-123">Any out parameters are not part of the `BeginOperationName` method signature.</span></span> <span data-ttu-id="22cd7-124">`BeginOperationName` 方法簽章還包括另外兩個參數。</span><span class="sxs-lookup"><span data-stu-id="22cd7-124">The `BeginOperationName` method signature also includes two additional parameters.</span></span> <span data-ttu-id="22cd7-125">它們之中的第一個定義 <xref:System.AsyncCallback> 委派，參考非同步作業完成時呼叫的方法。</span><span class="sxs-lookup"><span data-stu-id="22cd7-125">The first of these defines an <xref:System.AsyncCallback> delegate that references a method that is called when the asynchronous operation completes.</span></span> <span data-ttu-id="22cd7-126">如果不想在作業完成時叫用方法，呼叫端可以指定 `null` (在 Visual Basic 中為`Nothing` )。</span><span class="sxs-lookup"><span data-stu-id="22cd7-126">The caller can specify `null` (`Nothing` in Visual Basic) if it does not want a method invoked when the operation completes.</span></span> <span data-ttu-id="22cd7-127">第二個參數是使用者定義的物件。</span><span class="sxs-lookup"><span data-stu-id="22cd7-127">The second additional parameter is a user-defined object.</span></span> <span data-ttu-id="22cd7-128">這個物件可以用來將應用程式專屬的狀態資訊傳遞至非同步作業完成時叫用的方法。</span><span class="sxs-lookup"><span data-stu-id="22cd7-128">This object can be used to pass application-specific state information to the method invoked when the asynchronous operation completes.</span></span> <span data-ttu-id="22cd7-129">如果 `BeginOperationName` 方法使用其他作業特定參數 (例如用來儲存從檔案讀取位元組的位元組陣列)，<xref:System.AsyncCallback> 和應用程式狀態物件就會是 `BeginOperationName` 方法簽章中最後的參數。</span><span class="sxs-lookup"><span data-stu-id="22cd7-129">If a `BeginOperationName` method takes additional operation-specific parameters, such as a byte array to store bytes read from a file, the <xref:System.AsyncCallback> and application state object are the last parameters in the `BeginOperationName` method signature.</span></span>  
  
 <span data-ttu-id="22cd7-130">`BeginOperationName` 會立即將控制權傳回呼叫的執行緒。</span><span class="sxs-lookup"><span data-stu-id="22cd7-130">`BeginOperationName` returns control to the calling thread immediately.</span></span> <span data-ttu-id="22cd7-131">如果 `BeginOperationName` 方法擲回例外狀況，則例外狀況會在非同步作業啟動之前擲回。</span><span class="sxs-lookup"><span data-stu-id="22cd7-131">If the `BeginOperationName` method throws exceptions, the exceptions are thrown before the asynchronous operation is started.</span></span> <span data-ttu-id="22cd7-132">如果 `BeginOperationName` 方法擲回例外狀況，則不會叫用回呼方法。</span><span class="sxs-lookup"><span data-stu-id="22cd7-132">If the `BeginOperationName` method throws exceptions, the callback method is not invoked.</span></span>  
  
## <a name="ending-an-asynchronous-operation"></a><span data-ttu-id="22cd7-133">結束非同步作業</span><span class="sxs-lookup"><span data-stu-id="22cd7-133">Ending an Asynchronous Operation</span></span>  

 <span data-ttu-id="22cd7-134">`EndOperationName` 方法會結束非同步作業 *OperationName*。</span><span class="sxs-lookup"><span data-stu-id="22cd7-134">The `EndOperationName` method ends asynchronous operation *OperationName*.</span></span> <span data-ttu-id="22cd7-135">`EndOperationName` 方法的傳回值型別與其同步版本所傳回的型別相同，而且是非同步作業專屬。</span><span class="sxs-lookup"><span data-stu-id="22cd7-135">The return value of the `EndOperationName` method is the same type returned by its synchronous counterpart and is specific to the asynchronous operation.</span></span> <span data-ttu-id="22cd7-136">例如， <xref:System.IO.FileStream.EndRead%2A> 方法會傳回從 <xref:System.IO.FileStream> 讀取的位元組數目，而 <xref:System.Net.Dns.EndGetHostByName%2A> 方法會傳回包含主機電腦相關資訊的 <xref:System.Net.IPHostEntry> 物件。</span><span class="sxs-lookup"><span data-stu-id="22cd7-136">For example, the <xref:System.IO.FileStream.EndRead%2A> method returns the number of bytes read from a <xref:System.IO.FileStream> and the <xref:System.Net.Dns.EndGetHostByName%2A> method returns an <xref:System.Net.IPHostEntry> object that contains information about a host computer.</span></span> <span data-ttu-id="22cd7-137">`EndOperationName` 方法會使用在此方法同步版本簽章中所宣告的任何 out 或 ref 參數。</span><span class="sxs-lookup"><span data-stu-id="22cd7-137">The `EndOperationName` method takes any out or ref parameters declared in the signature of the synchronous version of the method.</span></span> <span data-ttu-id="22cd7-138">除了同步方法中的參數外，`EndOperationName` 方法還包括 <xref:System.IAsyncResult> 參數。</span><span class="sxs-lookup"><span data-stu-id="22cd7-138">In addition to the parameters from the synchronous method, the `EndOperationName` method also includes an <xref:System.IAsyncResult> parameter.</span></span> <span data-ttu-id="22cd7-139">呼叫者必須傳遞 `BeginOperationName` 的對應呼叫所傳回的執行個體。</span><span class="sxs-lookup"><span data-stu-id="22cd7-139">Callers must pass the instance returned by the corresponding call to `BeginOperationName`.</span></span>  
  
 <span data-ttu-id="22cd7-140">如果呼叫 `EndOperationName` 時，<xref:System.IAsyncResult> 物件所代表的非同步作業還沒有完成，`EndOperationName` 就會封鎖呼叫執行緒，直到非同步作業完成為止。</span><span class="sxs-lookup"><span data-stu-id="22cd7-140">If the asynchronous operation represented by the <xref:System.IAsyncResult> object has not completed when `EndOperationName` is called, `EndOperationName` blocks the calling thread until the asynchronous operation is complete.</span></span> <span data-ttu-id="22cd7-141">非同步作業所擲回的例外狀況都是從 `EndOperationName` 方法擲回。</span><span class="sxs-lookup"><span data-stu-id="22cd7-141">Exceptions thrown by the asynchronous operation are thrown from the `EndOperationName` method.</span></span> <span data-ttu-id="22cd7-142">使用相同的 `EndOperationName` 多次呼叫 <xref:System.IAsyncResult> 方法的效果尚未定義。</span><span class="sxs-lookup"><span data-stu-id="22cd7-142">The effect of calling the `EndOperationName` method multiple times with the same <xref:System.IAsyncResult> is not defined.</span></span> <span data-ttu-id="22cd7-143">使用並非由相關 Begin 方法所傳回的 <xref:System.IAsyncResult> 呼叫 `EndOperationName` 方法的方式，也同樣尚未定義。</span><span class="sxs-lookup"><span data-stu-id="22cd7-143">Likewise, calling the `EndOperationName` method with an <xref:System.IAsyncResult> that was not returned by the related Begin method is also not defined.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="22cd7-144">對任一未定義的情況，實施者應該考慮擲回 <xref:System.InvalidOperationException>。</span><span class="sxs-lookup"><span data-stu-id="22cd7-144">For either of the undefined scenarios, implementers should consider throwing <xref:System.InvalidOperationException>.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="22cd7-145">這個設計模式的實施者應該告知呼叫端，非同步作業已透過將 <xref:System.IAsyncResult.IsCompleted%2A> 設定為 true、呼叫非同步回呼方法 (如果有指定) 和傳送訊號給 <xref:System.IAsyncResult.AsyncWaitHandle%2A>而完成。</span><span class="sxs-lookup"><span data-stu-id="22cd7-145">Implementers of this design pattern should notify the caller that the asynchronous operation completed by setting <xref:System.IAsyncResult.IsCompleted%2A> to true, calling the asynchronous callback method (if one was specified) and signaling the <xref:System.IAsyncResult.AsyncWaitHandle%2A>.</span></span>  
  
 <span data-ttu-id="22cd7-146">應用程式開發人員有數項設計選擇，可存取非同步作業的結果。</span><span class="sxs-lookup"><span data-stu-id="22cd7-146">Application developers have several design choices for accessing the results of the asynchronous operation.</span></span> <span data-ttu-id="22cd7-147">正確的選擇取決於當作業完成時，應用程式是否有可以執行的指示。</span><span class="sxs-lookup"><span data-stu-id="22cd7-147">The correct choice depends on whether the application has instructions that can execute while the operation completes.</span></span> <span data-ttu-id="22cd7-148">如果應用程式一直到接收到非同步作業的結果，都無法執行任何額外的工作，它就必須封鎖直到取得結果為止。</span><span class="sxs-lookup"><span data-stu-id="22cd7-148">If an application cannot perform any additional work until it receives the results of the asynchronous operation, the application must block until the results are available.</span></span> <span data-ttu-id="22cd7-149">若要封鎖到非同步作業完成，您可以使用下列方法的其中之一：</span><span class="sxs-lookup"><span data-stu-id="22cd7-149">To block until an asynchronous operation completes, you can use one of the following approaches:</span></span>  
  
- <span data-ttu-id="22cd7-150">從應用程式的主要執行緒呼叫 `EndOperationName`，並封鎖應用程式的執行，直到作業完成為止。</span><span class="sxs-lookup"><span data-stu-id="22cd7-150">Call `EndOperationName` from the application’s main thread, blocking application execution until the operation is complete.</span></span> <span data-ttu-id="22cd7-151">如需說明這項技巧的範例，請參閱[以結束非同步作業的方式封鎖應用程式執行](blocking-application-execution-by-ending-an-async-operation.md)。</span><span class="sxs-lookup"><span data-stu-id="22cd7-151">For an example that illustrates this technique, see [Blocking Application Execution by Ending an Async Operation](blocking-application-execution-by-ending-an-async-operation.md).</span></span>  
  
- <span data-ttu-id="22cd7-152">使用 <xref:System.IAsyncResult.AsyncWaitHandle%2A> 應用程式執行，直到一或多個作業完成為止。</span><span class="sxs-lookup"><span data-stu-id="22cd7-152">Use the <xref:System.IAsyncResult.AsyncWaitHandle%2A> to block application execution until one or more operations are complete.</span></span> <span data-ttu-id="22cd7-153">如需說明這項技巧的範例，請參閱 [Blocking Application Execution Using an AsyncWaitHandle](blocking-application-execution-using-an-asyncwaithandle.md)。</span><span class="sxs-lookup"><span data-stu-id="22cd7-153">For an example that illustrates this technique, see [Blocking Application Execution Using an AsyncWaitHandle](blocking-application-execution-using-an-asyncwaithandle.md).</span></span>  
  
 <span data-ttu-id="22cd7-154">在非同步作業完成時不需要封鎖的應用程式，可以使用下列方法的其中之一：</span><span class="sxs-lookup"><span data-stu-id="22cd7-154">Applications that do not need to block while the asynchronous operation completes can use one of the following approaches:</span></span>  
  
- <span data-ttu-id="22cd7-155">定期檢查 <xref:System.IAsyncResult.IsCompleted%2A> 屬性以輪詢作業完成狀態，並在作業完成時呼叫 `EndOperationName`。</span><span class="sxs-lookup"><span data-stu-id="22cd7-155">Poll for operation completion status by checking the <xref:System.IAsyncResult.IsCompleted%2A> property periodically and calling `EndOperationName` when the operation is complete.</span></span> <span data-ttu-id="22cd7-156">如需說明這項技巧的範例，請參閱 [Polling for the Status of an Asynchronous Operation](polling-for-the-status-of-an-asynchronous-operation.md)。</span><span class="sxs-lookup"><span data-stu-id="22cd7-156">For an example that illustrates this technique, see [Polling for the Status of an Asynchronous Operation](polling-for-the-status-of-an-asynchronous-operation.md).</span></span>  
  
- <span data-ttu-id="22cd7-157">使用 <xref:System.AsyncCallback> 委派指定作業完成時要叫用的方法。</span><span class="sxs-lookup"><span data-stu-id="22cd7-157">Use an <xref:System.AsyncCallback> delegate to specify a method to be invoked when the operation is complete.</span></span> <span data-ttu-id="22cd7-158">如需說明這項技巧的範例，請參閱 [Using an AsyncCallback Delegate to End an Asynchronous Operation](using-an-asynccallback-delegate-to-end-an-asynchronous-operation.md)。</span><span class="sxs-lookup"><span data-stu-id="22cd7-158">For an example that illustrates this technique, see [Using an AsyncCallback Delegate to End an Asynchronous Operation](using-an-asynccallback-delegate-to-end-an-asynchronous-operation.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="22cd7-159">另請參閱</span><span class="sxs-lookup"><span data-stu-id="22cd7-159">See also</span></span>

- [<span data-ttu-id="22cd7-160">事件架構非同步模式 (EAP)</span><span class="sxs-lookup"><span data-stu-id="22cd7-160">Event-based Asynchronous Pattern (EAP)</span></span>](event-based-asynchronous-pattern-eap.md)
- [<span data-ttu-id="22cd7-161">以非同步的方式呼叫同步方法</span><span class="sxs-lookup"><span data-stu-id="22cd7-161">Calling Synchronous Methods Asynchronously</span></span>](calling-synchronous-methods-asynchronously.md)
- [<span data-ttu-id="22cd7-162">使用 AsyncCallback 委派和狀態物件</span><span class="sxs-lookup"><span data-stu-id="22cd7-162">Using an AsyncCallback Delegate and State Object</span></span>](using-an-asynccallback-delegate-and-state-object.md)
