---
title: 作法：撰寫含有執行緒區域變數的 Parallel.For 迴圈
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
ms.openlocfilehash: bb6ac1a64c3a71646946d1af894d1124b12e4769
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/02/2020
ms.locfileid: "84290755"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="bac52-102">作法：撰寫含有執行緒區域變數的 Parallel.For 迴圈</span><span class="sxs-lookup"><span data-stu-id="bac52-102">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="bac52-103">此範例說明如何使用執行緒區域變數，儲存及擷取 <xref:System.Threading.Tasks.Parallel.For%2A> 迴圈所建立之每項工作的狀態。</span><span class="sxs-lookup"><span data-stu-id="bac52-103">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="bac52-104">使用執行緒區域資料，可讓您避免因同步處理大量的共用狀態存取而產生額外負荷。</span><span class="sxs-lookup"><span data-stu-id="bac52-104">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="bac52-105">您可以計算並儲存值，直到工作的所有反覆運算完成為止，而無須在每次反覆運算時寫入至共用資源。</span><span class="sxs-lookup"><span data-stu-id="bac52-105">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="bac52-106">接著，您可以將最終結果寫入至共用資源，或將其傳遞至其他方法。</span><span class="sxs-lookup"><span data-stu-id="bac52-106">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="bac52-107">範例</span><span class="sxs-lookup"><span data-stu-id="bac52-107">Example</span></span>  
 <span data-ttu-id="bac52-108">下列範例呼叫 <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> 方法，以計算含有一百萬個項目之陣列中的值總和。</span><span class="sxs-lookup"><span data-stu-id="bac52-108">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="bac52-109">每個項目的值等於其索引。</span><span class="sxs-lookup"><span data-stu-id="bac52-109">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="bac52-110">每個 <xref:System.Threading.Tasks.Parallel.For%2A> 方法的前兩個參數指定反覆運算的開始和結束值。</span><span class="sxs-lookup"><span data-stu-id="bac52-110">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="bac52-111">在方法的這個多載中，第三個參數是您初始化區域狀態的位置。</span><span class="sxs-lookup"><span data-stu-id="bac52-111">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="bac52-112">在此內容中，區域狀態表示存留期始於目前執行緒上之迴圈的第一次反覆運算之前，終於最後一次反覆運算之後的變數。</span><span class="sxs-lookup"><span data-stu-id="bac52-112">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="bac52-113">第三個參數的類型是 <xref:System.Func%601>，其中 `TResult` 是將會儲存執行緒區域狀態的變數類型。</span><span class="sxs-lookup"><span data-stu-id="bac52-113">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="bac52-114">其類型是由呼叫泛型 <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> 方法時所提供的泛型類型引數所定義，在此範例中為 <xref:System.Int64>。</span><span class="sxs-lookup"><span data-stu-id="bac52-114">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="bac52-115">此型別引數會指示編譯器將用於儲存執行緒區域狀態的暫存變數類型。</span><span class="sxs-lookup"><span data-stu-id="bac52-115">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="bac52-116">在此範例中，運算式 `() => 0` (在 Visual Basic 中為 `Function() 0`) 會將執行緒區域變數初始化為零。</span><span class="sxs-lookup"><span data-stu-id="bac52-116">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="bac52-117">如果泛型類型引數是參考類型或使用者定義的實值類型，則此運算式如下所示：</span><span class="sxs-lookup"><span data-stu-id="bac52-117">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="bac52-118">第四個參數會定義迴圈邏輯。</span><span class="sxs-lookup"><span data-stu-id="bac52-118">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="bac52-119">它必須是委派或 Lambda 運算式，其簽章是 `Func<int, ParallelLoopState, long, long>` (在 C# 中) 或 `Func(Of Integer, ParallelLoopState, Long, Long)` (在 Visual Basic 中)。</span><span class="sxs-lookup"><span data-stu-id="bac52-119">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="bac52-120">第一個參數是該迴圈反覆運算之迴圈計數器的值。</span><span class="sxs-lookup"><span data-stu-id="bac52-120">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="bac52-121">第二個參數是可用於脫離迴圈的 <xref:System.Threading.Tasks.ParallelLoopState> 物件，<xref:System.Threading.Tasks.Parallel> 類別會提供此物件給每個迴圈。</span><span class="sxs-lookup"><span data-stu-id="bac52-121">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="bac52-122">第三個參數是執行緒區域變數。</span><span class="sxs-lookup"><span data-stu-id="bac52-122">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="bac52-123">最後一個參數是傳回型別。</span><span class="sxs-lookup"><span data-stu-id="bac52-123">The last parameter is the return type.</span></span> <span data-ttu-id="bac52-124">在此範例中，此類型為 <xref:System.Int64>，因為這是我們在 <xref:System.Threading.Tasks.Parallel.For%2A> 型別引數中指定的類型。</span><span class="sxs-lookup"><span data-stu-id="bac52-124">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="bac52-125">該變數的名稱為 `subtotal`，會由 Lambda 運算式傳回。</span><span class="sxs-lookup"><span data-stu-id="bac52-125">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="bac52-126">此傳回值會在迴圈的每次後續反覆運算時，用來初始化 `subtotal`。</span><span class="sxs-lookup"><span data-stu-id="bac52-126">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="bac52-127">您也可以將此最後一個參數視為會傳遞至每個反覆項目，然後在最後一個反覆項目完成時傳遞至 `localFinally` 委派的值。</span><span class="sxs-lookup"><span data-stu-id="bac52-127">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="bac52-128">第五個參數定義要在特定執行緒上所有的反覆項目完成後呼叫一次的方法。</span><span class="sxs-lookup"><span data-stu-id="bac52-128">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="bac52-129">輸入參數的類型會重新對應至 <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> 方法的型別引數，以及主體 Lambda 運算式所傳回的類型。</span><span class="sxs-lookup"><span data-stu-id="bac52-129">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="bac52-130">在此範例中，會透過呼叫 <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> 方法，以安全執行緒的方式將值加入至類別範圍的變數中。</span><span class="sxs-lookup"><span data-stu-id="bac52-130">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="bac52-131">使用執行緒區域變數，可讓我們避免在每次反覆運算迴圈時寫入至此類別變數。</span><span class="sxs-lookup"><span data-stu-id="bac52-131">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="bac52-132">如需如何使用 Lambda 運算式的詳細資訊，請參閱 [PLINQ 和 TPL 中的 Lambda 運算式](lambda-expressions-in-plinq-and-tpl.md)。</span><span class="sxs-lookup"><span data-stu-id="bac52-132">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bac52-133">另請參閱</span><span class="sxs-lookup"><span data-stu-id="bac52-133">See also</span></span>

- [<span data-ttu-id="bac52-134">資料平行處理</span><span class="sxs-lookup"><span data-stu-id="bac52-134">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="bac52-135">平行程式設計</span><span class="sxs-lookup"><span data-stu-id="bac52-135">Parallel Programming</span></span>](index.md)
- [<span data-ttu-id="bac52-136">工作平行程式庫 (TPL)</span><span class="sxs-lookup"><span data-stu-id="bac52-136">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
- [<span data-ttu-id="bac52-137">PLINQ 和 TPL 中的 Lambda 運算式</span><span class="sxs-lookup"><span data-stu-id="bac52-137">Lambda Expressions in PLINQ and TPL</span></span>](lambda-expressions-in-plinq-and-tpl.md)
