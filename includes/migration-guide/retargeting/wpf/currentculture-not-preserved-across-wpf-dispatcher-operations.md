---
ms.openlocfilehash: bd656478a55856e676853e57f3e7386ea0aa0211
ms.sourcegitcommit: e02d17b2cf9c1258dadda4810a5e6072a0089aee
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/01/2020
ms.locfileid: "85614384"
---
### <a name="currentculture-is-not-preserved-across-wpf-dispatcher-operations"></a><span data-ttu-id="bb0c3-101">CurrentCulture 無法跨 WPF 發送器作業保留</span><span class="sxs-lookup"><span data-stu-id="bb0c3-101">CurrentCulture is not preserved across WPF Dispatcher operations</span></span>

#### <a name="details"></a><span data-ttu-id="bb0c3-102">詳細資料</span><span class="sxs-lookup"><span data-stu-id="bb0c3-102">Details</span></span>

<span data-ttu-id="bb0c3-103">從 .NET Framework 4.6 開始，在 <xref:System.Windows.Threading.Dispatcher?displayProperty=fullName> 內對 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 或 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 所做的變更，將會在發送器作業結束時遺失。</span><span class="sxs-lookup"><span data-stu-id="bb0c3-103">Beginning in the .NET Framework 4.6, changes to <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> made within a <xref:System.Windows.Threading.Dispatcher?displayProperty=fullName> will be lost at the end of that dispatcher operation.</span></span> <span data-ttu-id="bb0c3-104">同樣地，在發送器作業外部對 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 或 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 所做的變更，不會在執行該作業時反映出來。實際上，這表示 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 和 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 變更可能不會在 WPF UI 回呼與 WPF 應用程式的其他程式碼之間流動。這是因為從以 .NET Framework 4.6 為目標的應用程式開始，<xref:System.Threading.ExecutionContext?displayProperty=fullName> 的變更會導致 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 和 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 儲存在執行內容中。</span><span class="sxs-lookup"><span data-stu-id="bb0c3-104">Similarly, changes to <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> made outside of a Dispatcher operation may not be reflected when that operation executes.Practically speaking, this means that <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> changes may not flow between WPF UI callbacks and other code in a WPF application.This is due to a change in <xref:System.Threading.ExecutionContext?displayProperty=fullName> that causes <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> to be stored in the execution context beginning with apps targeting the .NET Framework 4.6.</span></span> <span data-ttu-id="bb0c3-105">WPF 發送器作業會儲存用來開始作業的執行內容，並在作業完成時還原先前的內容。</span><span class="sxs-lookup"><span data-stu-id="bb0c3-105">WPF dispatcher operations store the execution context used to begin the operation and restore the previous context when the operation is completed.</span></span> <span data-ttu-id="bb0c3-106">因為 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 和 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 現在是該內容的一部分，所以在發送器作業內對其進行的變更不會保留到作業外。</span><span class="sxs-lookup"><span data-stu-id="bb0c3-106">Because <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> are now part of that context, changes to them within a dispatcher operation are not persisted outside of the operation.</span></span>

#### <a name="suggestion"></a><span data-ttu-id="bb0c3-107">建議</span><span class="sxs-lookup"><span data-stu-id="bb0c3-107">Suggestion</span></span>

<span data-ttu-id="bb0c3-108">您可以將所需的 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 或 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 儲存在欄位中，然後簽入設定正確 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 和 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 的所有發送器作業主體 (包括 UI 事件回呼處理常式)，來解決受此變更影響的應用程式。</span><span class="sxs-lookup"><span data-stu-id="bb0c3-108">Apps affected by this change may work around it by storing the desired <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> in a field and checking in all Dispatcher operation bodies (including UI event callback handlers) that the correct <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> are set.</span></span> <span data-ttu-id="bb0c3-109">此外，由於此 WPF 變更的基本 ExecutionContext 變更只會影響以 .NET Framework 4.6 或更新版本為目標的應用程式，因此您可以將目標設為 .NET Framework 4.5.2 來避免此中斷情況。以 .NET Framework 4.6 或更新版本為目標的應用程式，也可以設定下列相容性參數來解決此問題：</span><span class="sxs-lookup"><span data-stu-id="bb0c3-109">Alternatively, because the ExecutionContext change underlying this WPF change only affects apps targeting the .NET Framework 4.6 or newer, this break can be avoided by targeting the .NET Framework 4.5.2.Apps that target .NET Framework 4.6 or later can also work around this by setting the following compatibility switch:</span></span>

<pre><code class="lang-csharp">AppContext.SetSwitch(&quot;Switch.System.Globalization.NoAsyncCurrentCulture&quot;, true);&#13;&#10;</code></pre>

<span data-ttu-id="bb0c3-110">.NET Framework 4.6.2 中的 WPF 已修正此問題。</span><span class="sxs-lookup"><span data-stu-id="bb0c3-110">This issue has been fixed by WPF in .NET Framework 4.6.2.</span></span> <span data-ttu-id="bb0c3-111">.NET Frameworks 4.6、4.6.1 也已透過 [KB 3139549](https://support.microsoft.com/kb/3139549) 進行修正。</span><span class="sxs-lookup"><span data-stu-id="bb0c3-111">It has also been fixed in .NET Frameworks 4.6, 4.6.1 through [KB 3139549](https://support.microsoft.com/kb/3139549).</span></span> <span data-ttu-id="bb0c3-112">以 .NET Framework 4.6 或更新版本為目標的應用程式將在 WPF 應用程式中自動取得正確的行為 - <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName>/<xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 會跨發送器作業保留。</span><span class="sxs-lookup"><span data-stu-id="bb0c3-112">Applications targeting .NET Framework 4.6 or later will automatically get the right behavior in WPF applications - <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName>/<xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>) would be preserved across Dispatcher operations.</span></span>

| <span data-ttu-id="bb0c3-113">名稱</span><span class="sxs-lookup"><span data-stu-id="bb0c3-113">Name</span></span>    | <span data-ttu-id="bb0c3-114">值</span><span class="sxs-lookup"><span data-stu-id="bb0c3-114">Value</span></span>       |
|:--------|:------------|
| <span data-ttu-id="bb0c3-115">影響範圍</span><span class="sxs-lookup"><span data-stu-id="bb0c3-115">Scope</span></span>   | <span data-ttu-id="bb0c3-116">Minor</span><span class="sxs-lookup"><span data-stu-id="bb0c3-116">Minor</span></span>       |
| <span data-ttu-id="bb0c3-117">版本</span><span class="sxs-lookup"><span data-stu-id="bb0c3-117">Version</span></span> | <span data-ttu-id="bb0c3-118">4.6</span><span class="sxs-lookup"><span data-stu-id="bb0c3-118">4.6</span></span>         |
| <span data-ttu-id="bb0c3-119">類型</span><span class="sxs-lookup"><span data-stu-id="bb0c3-119">Type</span></span>    | <span data-ttu-id="bb0c3-120">正在重定目標</span><span class="sxs-lookup"><span data-stu-id="bb0c3-120">Retargeting</span></span> |
