---
ms.openlocfilehash: ab9431780422dfece5dcf8007d13e6d584f5118f
ms.sourcegitcommit: 721c3e4bdbb1ea0bb420818ec944c538fe5c513a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/01/2020
ms.locfileid: "96477086"
---
### <a name="avoiding-endless-recursion-for-iworkflowinstancemanagementtransactedcancel-and-iworkflowinstancemanagementtransactedterminate"></a><span data-ttu-id="a677c-101">避免 IWorkflowInstanceManagement.TransactedCancel 與 IWorkflowInstanceManagement.TransactedTerminate 的無止盡遞迴</span><span class="sxs-lookup"><span data-stu-id="a677c-101">Avoiding endless recursion for IWorkflowInstanceManagement.TransactedCancel and IWorkflowInstanceManagement.TransactedTerminate</span></span>

#### <a name="details"></a><span data-ttu-id="a677c-102">詳細資料</span><span class="sxs-lookup"><span data-stu-id="a677c-102">Details</span></span>

<span data-ttu-id="a677c-103">在某些情況下，若使用 <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> 或 <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> API 取消或終止工作流程服務執行個體，當 `Workflow` 執行階段因為處理要求的過程，而嘗試保有該服務執行個體時，工作流程執行個體可能會出現因為無止盡遞迴而發生堆疊溢位。</span><span class="sxs-lookup"><span data-stu-id="a677c-103">Under some circumstances when using <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> APIs to cancel or terminate a workflow service instance, the workflow instance may encounter a stack overflow due to endless recursion when the `Workflow` runtime attempts to persist the service instance as part of processing the request.</span></span> <span data-ttu-id="a677c-104">如果工作流程實例的狀態是正在等候其他服務的其他未完成 WCF 要求完成，就會發生此問題。</span><span class="sxs-lookup"><span data-stu-id="a677c-104">The problem occurs if the workflow instance is in a state where it is waiting for some other outstanding WCF request to another service to complete.</span></span> <span data-ttu-id="a677c-105">`TransactedCancel`和 `TransactedTerminate` 作業會建立針對工作流程服務實例排入佇列的工作專案。</span><span class="sxs-lookup"><span data-stu-id="a677c-105">The `TransactedCancel` and `TransactedTerminate` operations create work items that are queued for the workflow service instance.</span></span> <span data-ttu-id="a677c-106">處理 `TransactedCancel/TransactedTerminate` 要求的過程中，不會執行這些工作項目。</span><span class="sxs-lookup"><span data-stu-id="a677c-106">These work items are not executed as part of the processing of the `TransactedCancel/TransactedTerminate` request.</span></span> <span data-ttu-id="a677c-107">因為工作流程服務執行個體正忙於等候其他未完成的 WCF 要求完成，所以建立的工作項目會維持在佇列中。</span><span class="sxs-lookup"><span data-stu-id="a677c-107">Because the workflow service instance is busy waiting for the other outstanding WCF request to complete, the work item created remains queued.</span></span> <span data-ttu-id="a677c-108">`TransactedCancel/TransactedTerminate` 作業已完成，且控制權已回到用戶端。</span><span class="sxs-lookup"><span data-stu-id="a677c-108">The `TransactedCancel/TransactedTerminate` operation completes and control is returned back to the client.</span></span> <span data-ttu-id="a677c-109">當交易與嘗試認可的 `TransactedCancel/TransactedTerminate` 作業相關聯時，它需要保有該工作流程服務執行個體的狀態。</span><span class="sxs-lookup"><span data-stu-id="a677c-109">When the transaction associated with the `TransactedCancel/TransactedTerminate` operation attempts to commit, it needs to persist the workflow service instance state.</span></span> <span data-ttu-id="a677c-110">但因為執行個體仍有未完成的 `WCF`要求，所以工作流程執行階段無法保有該工作流程服務執行個體，因而發生無止盡的遞迴迴圈而導致堆疊溢位。因為 `TransactedCancel` 與 `TransactedTerminate` 只會在記憶體中建立工作項目，所以交易存在的事實並沒有任何影響。</span><span class="sxs-lookup"><span data-stu-id="a677c-110">But because there is an outstanding `WCF` request for the instance, the Workflow runtime cannot persist the workflow service instance, and an endless recursion loop leads to the stack overflow.Because `TransactedCancel` and `TransactedTerminate` only create a work item in memory, the fact that a transaction exists doesn't have any effect.</span></span> <span data-ttu-id="a677c-111">復原交易並不會捨棄該工作項目。為解決此問題，從 .NET Framework 4.7.2 起已引進了 `AppSetting`，其可新增至工作流程服務的 `web.config/app.config`，告知它可忽略 `TransactedCancel` 與 `TransactedTerminate` 的交易。</span><span class="sxs-lookup"><span data-stu-id="a677c-111">A rollback of the transaction does not discard the work item.To address this issue, starting in .NET Framework 4.7.2, we have introduced an `AppSetting` that can be added to the `web.config/app.config` of the workflow service that tells it to ignore transactions for `TransactedCancel` and `TransactedTerminate`.</span></span> <span data-ttu-id="a677c-112">這可讓交易認可，而不需要等待工作流程實例保存。</span><span class="sxs-lookup"><span data-stu-id="a677c-112">This allows the transaction to commit without waiting for the workflow instance to persist.</span></span> <span data-ttu-id="a677c-113">這項功能的 AppSetting 名為 `microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate` 。</span><span class="sxs-lookup"><span data-stu-id="a677c-113">The AppSetting for this feature is named `microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate`.</span></span> <span data-ttu-id="a677c-114">值 `true` 表示應忽略該交易，以避免堆疊溢位。</span><span class="sxs-lookup"><span data-stu-id="a677c-114">A value of `true` indicates that the transaction should be ignored, thus avoiding the stack overflow.</span></span> <span data-ttu-id="a677c-115">此 AppSetting 的預設值為 `false`，因此不會影響現有的工作流程服務執行個體。</span><span class="sxs-lookup"><span data-stu-id="a677c-115">The default value of this AppSetting is `false`, so existing workflow service instances are not affected.</span></span>

#### <a name="suggestion"></a><span data-ttu-id="a677c-116">建議</span><span class="sxs-lookup"><span data-stu-id="a677c-116">Suggestion</span></span>

<span data-ttu-id="a677c-117">若目前使用 AppFabric 或另一個 <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> 用戶端，且在嘗試取消或終止工作流程執行個體時，在工作流程服務執行個體中發生了堆疊溢位，您可以將下列內容加入工作流程服務的 web.config/app.config 檔案之 `<appSettings>` 區段中：</span><span class="sxs-lookup"><span data-stu-id="a677c-117">If you are using AppFabric or another <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> client and are encountering a stack overflow in the workflow service instance when trying to cancel or terminate a workflow instance, you can add the following to the `<appSettings>` section of the web.config/app.config file for the workflow service:</span></span>

<pre><code class="lang-xml">&lt;add key=&quot;microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate&quot; value=&quot;true&quot;/&gt;&#13;&#10;</code></pre>

<span data-ttu-id="a677c-118">若未遇到問題，則不需要執行這項動作。</span><span class="sxs-lookup"><span data-stu-id="a677c-118">If you are not encountering the problem, you do not need to do this.</span></span>

| <span data-ttu-id="a677c-119">名稱</span><span class="sxs-lookup"><span data-stu-id="a677c-119">Name</span></span>    | <span data-ttu-id="a677c-120">值</span><span class="sxs-lookup"><span data-stu-id="a677c-120">Value</span></span>       |
|:--------|:------------|
| <span data-ttu-id="a677c-121">範圍</span><span class="sxs-lookup"><span data-stu-id="a677c-121">Scope</span></span>   | <span data-ttu-id="a677c-122">Edge</span><span class="sxs-lookup"><span data-stu-id="a677c-122">Edge</span></span>        |
| <span data-ttu-id="a677c-123">版本</span><span class="sxs-lookup"><span data-stu-id="a677c-123">Version</span></span> | <span data-ttu-id="a677c-124">4.7.2</span><span class="sxs-lookup"><span data-stu-id="a677c-124">4.7.2</span></span>       |
| <span data-ttu-id="a677c-125">類型</span><span class="sxs-lookup"><span data-stu-id="a677c-125">Type</span></span>    | <span data-ttu-id="a677c-126">正在重定目標</span><span class="sxs-lookup"><span data-stu-id="a677c-126">Retargeting</span></span> |
